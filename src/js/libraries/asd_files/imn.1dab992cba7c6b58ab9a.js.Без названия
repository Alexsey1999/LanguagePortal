!function(e){function t(t){for(var n,s,o=t[0],l=t[1],c=t[2],u=0,g=[];u<o.length;u++)s=o[u],Object.prototype.hasOwnProperty.call(r,s)&&r[s]&&g.push(r[s][0]),r[s]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(e[n]=l[n]);for(d&&d(t);g.length;)g.shift()();return i.push.apply(i,c||[]),a()}function a(){for(var e,t=0;t<i.length;t++){for(var a=i[t],n=!0,o=1;o<a.length;o++){var l=a[o];0!==r[l]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=a[0]))}return e}var n={},r={"web/imn":0},i=[];function s(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.e=function(){return Promise.resolve()},s.m=e,s.c=n,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/js/cmodules/";var o=window.webpackJsonp=window.webpackJsonp||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var d=l;i.push([221,"common","palette","vendors","23f13708e764b3c21f858fbe45ced5b3","7ed9e4d544bccc8a5ada0a712a9cf1ad","1fe1df46cdb12c3eb98af3fc95e7c624","902866c362380432bb8fab2a5e67d693"]),a()}({"1MUc":function(e,t,a){"use strict";a.r(t),a.d(t,"ChatCreation",(function(){return V}));var n=a("q1tI"),r=a.n(n),i=a("6krn"),s=a("QDnf"),o=a("e87a"),l=a("euvX"),c=function(e){var t=e.children,a=e.title,n=e.onClose,s=e.onBack;return r.a.createElement(o.default,{onClose:n,disableBodyScroll:!0,className:"ChatCreationModal"},r.a.createElement(l.ModalHeader,{title:a,onClose:n,backText:s?Object(i.getLang)("global_back"):void 0,onBack:s,appearance:"blue"}),r.a.createElement("div",{className:"ChatCreationModal__content"},t))},d=a("iukX"),u=function(e){var t=e.setFlags,a=e.flags,n=e.onClose;return r.a.createElement(d.ChatSettingsOptions,{flags:a,back:n,isChatCreation:!0,onSave:function(e){return t(e),Promise.resolve()},afterSave:n,onCancel:n})},g=a("F0+T"),m=function(e){var t=e.usersList,a=e.onRemoveToken,n=e.onChange,s=e.onSelect,o=e.renderSuggest,l=e.tokens,c=e.query;return r.a.createElement(g.default,{className:"ChatCreationUserList",tokens:l,removeTokenPlaceholder:Object(i.getLang)("mail_create_chat_remove_user"),onRemoveToken:a,placeholder:Object(i.getLang)("mail_search_creation"),value:c,onChange:n,onSelect:s,useInfiniteScroll:!0,hasMore:!1,virtualized:!0,loadMore:function(){},notFoundText:Object(i.getLang)("mail_no_users_found"),autoFocus:!0,isSearching:!1,renderSuggest:o,data:t})},p=a("Hri0"),_=a("5R8M"),b=a("Cx1h"),h=a("P13b"),f=a("Aegd"),v=function(e){var t=e.data,a=e.onSelect,n=e.isSelected,i=Object(h.isContactPeer)(t.peerId)?r.a.createElement(f.ConversationNoPhoto,{id:t.peerId,text:Object(h.getUserInitials)(t.name),size:"34",specificType:7}):t.photo;return r.a.createElement(_.default,{"data-id":t.peerId,onClick:function(){return a(t.peerId)},selectable:!0,aside:r.a.createElement(b.ListMultiSelectControl,{isSelected:n})},r.a.createElement(p.default,{"data-id":t.peerId,size:"34",title:t.name,photo:i}))},O=a("XuPN"),y=a("nAFc"),j=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),r=0;for(t=0;t<a;t++)for(var i=arguments[t],s=0,o=i.length;s<o;s++,r++)n[r]=i[s];return n},C=function(e){var t=e.usersList,a=e.selectedMap,i=e.setSelectedMap,s=e.onServerSearch,o=Object(n.useState)(""),l=o[0],c=o[1],d=Object(n.useState)(t.map((function(e){return e.peerId}))),u=d[0],g=d[1],p=Object(n.useRef)(w(t)),_=Object(n.useCallback)((function(e){return e.name}),[]),b=Object(n.useCallback)((function(e){return e.peerId}),[]),h=Object(O.useIndexer)(Array.from(p.current.values()),_,b),f=Object(n.useMemo)((function(){return Array.from(p.current.keys())}),[p.current]),y=Object(n.useCallback)((function(e,t){return s(e,t)}),[s]);Object(n.useEffect)((function(){var e=h.search(l).map((function(e){return e.peerId}));g(e),y(l,e).then((function(t){if(0!==l.length){var a=[],n=[];t.forEach((function(e){p.current.has(e.peerId)||(n.push(e.peerId),a.push(function(e){return{id:e.peerId,peerId:e.peerId,name:e.name,photo:e.photo}}(e)))})),a.length&&(r=p,i=w(a),r.current=new Map(j(Array.from(r.current.entries()),Array.from(i.entries()))),g(j(e,n)))}var r,i})).catch((function(){}))}),[l]);var C=function(e){a.delete(e),i((function(){return new Map(a)}))},T=function(e){a.has(e)?C(e):(!function(e){var t=p.current.get(e);t&&(a.set(e,E(t)),i((function(){return new Map(a)})))}(e),c(""))},S=Object(n.useCallback)((function(e){C(+e)}),[a]),I=Object(n.useCallback)((function(e){c(e.target.value)}),[l]),k=Array.from(a.values());return r.a.createElement(m,{query:l,tokens:k,usersList:l?u:f,onSelect:T,onChange:I,onRemoveToken:S,renderSuggest:function(e){var t=p.current.get(e);return t?r.a.createElement(v,{key:e,data:t,onSelect:T,isSelected:a.has(e)}):r.a.createElement(r.a.Fragment,null)}})};function w(e){return e.reduce((function(e,t){return t.name=Object(y.decodeHTMLEntities)(t.name),e.set(t.id,t)}),new Map)}function E(e){return{id:e.id.toString(),text:e.name}}var T=a("RXF5"),S=a("s0Wt"),I=a("h7Kf"),k=a("WfnU"),M=function(e){var t=e.onChangeTitle,a=e.onResetTitle,n=e.onShowSettings,s=e.onButtonClickHandler,o=e.title,l=e.photo,c=e.loading,d=e.onUploadAvatar,u=e.onRemoveAvatar,g=e.isButtonDisabled,m=e.buttonText;return r.a.createElement("div",{className:"ChatCreationInfo"},r.a.createElement("div",{className:"ChatCreationInfo__avatarWrapper"},r.a.createElement(T.default,{photo:l,title:o,className:"ChatCreationInfo__avatar",onClick:d}),l&&r.a.createElement(S.default,{text:Object(i.getLang)("mail_settings_remove_photo"),position:"t",align:"left"},r.a.createElement("button",{onClick:u,className:"ChatCreationInfo__avatarRemove"}))),r.a.createElement(I.default,{className:"ChatCreationInfo__titleInput",isControlledOutside:!0,value:o,onChange:function(e){return t(e.target.value)},onCancel:a,placeholder:Object(i.getLang)("mail_im_chat_title_intro")}),r.a.createElement(S.default,{text:Object(i.getLang)("mail_chat_creation_settings_icon_tooltip"),position:"t"},r.a.createElement("button",{className:"ChatCreationInfo__settings",onClick:n,"aria-label":Object(i.getLang)("mail_chat_creation_settings_icon_tooltip")})),r.a.createElement(k.default,{disabled:g,loading:c,onClick:s},m))},P=function(e){var t=e.title,a=e.photo,s=e.selectedUserIds,o=e.onShowSettings,l=e.onTitleChange,c=e.onCreateChat,d=e.onUploadAvatar,u=e.onRemoveAvatar,g=e.onGoToConvo,m=Object(n.useState)(!1),p=m[0],_=m[1],b=Object(n.useState)(!L(t)),h=b[0],f=b[1],v=1===s.length&&!h&&!a,O=0!==s.length||h,y=Object(n.useCallback)((function(e){f(!L(e)),l(e)}),[]),j=!v&&!O,C=v?Object(i.getLang)("mail_im_go_to_dialog"):Object(i.getLang)("mail_im_create_chat");return r.a.createElement(M,{title:t,onResetTitle:function(){return y("")},onChangeTitle:y,photo:a,onShowSettings:o,onButtonClickHandler:function(){if(_(!0),v){var e=s[0];g(+e)}else c().catch((function(){_(!1)}))},loading:p,isButtonDisabled:j,onUploadAvatar:d,onRemoveAvatar:u,buttonText:C})};function L(e){return!e.trim().replace("\n","")}var A,D=a("5PZO"),B=a("BiHW"),x=a("bTOO"),N=a("zjLC"),R=a("R5GP"),F=a("DM26"),H=a("shih"),U=a("Iqrf"),G=a("XLJO"),q=a("6x51"),K=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),r=0;for(t=0;t<a;t++)for(var i=arguments[t],s=0,o=i.length;s<o;s++,r++)n[r]=i[s];return n};!function(e){e[e.LOADING=0]="LOADING",e[e.LIST=1]="LIST",e[e.SETTINGS=2]="SETTINGS",e[e.PHOTO=3]="PHOTO",e[e.ERROR=4]="ERROR"}(A||(A={}));var V=function(e){var t=e.store,a=e.uploadAvatar,o=e.onClose,l=e.onBack,d=e.onCreateChat,g=e.onGoToConvo,m=e.preselectedUsers,p=Object(n.useState)([]),_=p[0],b=p[1],h=Object(n.useState)(A.LOADING),f=h[0],v=h[1],O=Object(n.useState)(0),y=O[0],j=O[1],w=Object(n.useState)(""),T=w[0],S=w[1],I=Object(n.useState)(""),k=I[0],M=I[1],L=Object(n.useState)(void 0),V=L[0],W=L[1],z=Object(n.useState)(m?new Map(m.map((function(e){return[e.id,E(e)]}))):new Map),Y=z[0],$=z[1];Object(n.useEffect)((function(){(function(e){return Object(R.unpackStore)(e).hintsTree.then((function(t){var a=t.list.map((function(e){var t=e[0];return{id:+t,peerId:+t,name:e[1],photo:e[2]}}));return function(e,t){return Object(G.checkContactListLoaded)(e).then((function(e){var a=e.get().contactsList.filter((function(e){return!e.user})).sort((function(e,t){return e.id<t.id?1:-1})).map((function(e){return{id:Object(q.getContactPeerId)(e.id),peerId:Object(q.getContactPeerId)(e.id),name:e.name,photo:""}})),n=a.splice(0,a.length<3?a.length:3);return K(t.slice(0,4),n,t.slice(4),a)}))}(e,a)}))})(t).then((function(e){if(m){var t=m.reduce((function(e,t){return e[t.peerId]=!0,e}),{}),a=m.concat(e.filter((function(e){return!t[e.peerId]})));b(a)}else b(e)})).then((function(){return v(A.LIST)})).catch((function(){v(A.ERROR)}))}),[]);var X=Object(F.debouncedPromise)(H.searchHints,300);switch(f){case A.SETTINGS:return r.a.createElement(c,{title:Object(i.getLang)("mail_chat_creation_settings"),onClose:o,onBack:function(){return v(A.LIST)}},r.a.createElement(u,{flags:y,setFlags:j,onClose:function(){return v(A.LIST)}}));case A.LIST:return r.a.createElement(c,{title:Object(i.getLang)("mail_im_create_chat"),onBack:l,onClose:o},r.a.createElement(C,{usersList:_,selectedMap:Y,setSelectedMap:$,onServerSearch:function(e,a){return X(e,a,U.HintsSearchType.FRIENDS_AND_CONTACTS,{},t.get())}}),r.a.createElement(P,{title:T,photo:k,selectedUserIds:Array.from(Y.keys()),onTitleChange:S,onShowSettings:function(){return v(A.SETTINGS)},onCreateChat:function(){var e=Array.from(Y.keys()),a=V||void 0;return t.set((function(t){return Object(N.createChatAction)(t,a,e,T,y)})).then((function(e){d(e.get().next_peer)})).catch((function(){}))},onUploadAvatar:function(){v(A.PHOTO),a().then((function(e){if(e.photo&&e.photoData){var t=e.photo,a=e.photoData;M(t),W(a)}else W(void 0);v(A.LIST)})).catch((function(){v(A.ERROR)}))},onRemoveAvatar:function(){M(""),W(void 0)},onGoToConvo:g}));case A.ERROR:return r.a.createElement(c,{title:Object(i.getLang)("global_error"),onClose:o},r.a.createElement(x.ModalBody,null,r.a.createElement("p",null,Object(i.getLang)("global_error"))),r.a.createElement(D.ModalFooter,{actionButtons:r.a.createElement(B.default,{onClick:o},Object(i.getLang)("global_close"))}));case A.LOADING:return r.a.createElement(s.default,null);case A.PHOTO:return r.a.createElement(r.a.Fragment,null)}}},"1nu5":function(e,t,a){"use strict";a.r(t),a.d(t,"VkIndexer",(function(){return n}));var n=function(){function e(e,t,a){this.delimiter=new RegExp("[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\#\\+\\?\\\\]+","g"),this.trimmer=new RegExp("^[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\+\\?\\\\]+|[\\s\\-,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\\\]+$","g"),this.toTranslit={1072:"a",1073:"b",1074:"v",1075:"g",1076:"d",1077:"e",1078:"zh",1079:"z",1080:"i",1081:"y",1082:"k",1083:"l",1084:"m",1085:"n",1086:"o",1087:"p",1088:"r",1089:"s",1090:"t",1091:"u",1092:"f",1093:"h",1094:"ts",1095:"ch",1096:"sh",1097:"sh",1099:"y",1101:"e",1102:"yu",1103:"ya",1105:"e",1098:"",1100:""},this.toLocalCase={f:"a",",":"b","<":"b",d:"v",u:"g",l:"d",t:"e",";":"zh",":":"zh",p:"z",b:"i",q:"y",r:"k",k:"l",v:"m",y:"n",j:"o",g:"p",h:"r",c:"s",n:"t",e:"u",a:"f","[":"h","{":"kh",w:"ts",x:"ch",i:"sh",o:"sh",s:"y","'":"e",'"':"e",".":"yu",">":"yu",z:"ya","`":"e","~":"e",m:"","]":"","}":""},this.toLocalTranslit={1072:"f",1074:"d",1075:"u",1076:"l",1077:"t",1079:"p",1080:"b",1081:"q",1082:"r",1083:"k",1084:"v",1085:"y",1086:"j",1087:"g",1088:"h",1089:"c",1090:"n",1091:"e",1092:"a",1094:"w",1095:"x",1096:"i",1097:"o",1099:"s",1103:"z",1098:"m"},this.list=e||[],this.iterCur=0,this.iterEnd=e?e.length:0,this.index={},this.callback=a||function(){},this.prepareFunc=t||function(e){return e},setTimeout(this.indexIteration.bind(this),10)}return e.prototype.indexIteration=function(){for(var e=Math.min(this.iterEnd,this.iterCur+200),t=this.iterCur;t<e;t++){var a=this.list[t];try{a._order=t}catch(e){}this.add(a)}this.iterCur=t,t>=this.iterEnd?this.callback(this):setTimeout(this.indexIteration.bind(this),10)},e.prototype.strToPrefixes=function(e){for(var t,a={},n=(t=e,t.replace(/&#(\d\d+);/g,(function(e,t){return(t=!0===(a=t)?1:parseInt(a)||0)>=32?String.fromCharCode(t):e;var a})).replace(/&quot;/gi,'"').replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&amp;/gi,"&")).toLowerCase().split(this.delimiter),r=n.length;r--;){var i=n[r],s="";if(i){for(var o=0;o<6;o++){var l=i.charCodeAt(o);if(l){var c=this.toTranslit[l],d=i.substr(o,1);s+=null!=c?c:d}}a[s]=1}}return a},e.prototype.strToSearchPrefixes=function(e){for(var t=[],a=e.toLowerCase().split(this.delimiter),n=a.length;n--;){var r={},i=a[n],s="",o="",l="",c=i.length>1;if(i){for(var d=0;d<6;d++){var u=i.charCodeAt(d);if(u){var g=this.toTranslit[u],m=i.substr(d,1);if(s+=null!=g?g:m,c){var p=this.toLocalCase[m],_=this.toLocalTranslit[u];o+=null!=p?p:m,l+=null!=_?_:m}}}r[s]=1,c&&(r[o]=2,r[l]=3),t.push(r)}}return t},e.prototype.toIndexTree=function(e,t){for(var a=this.index,n=0;n<6;n++){var r=e.substr(n,1)||-1;a=a[r]?a[r]:a[r]=5==n?[]:{}}a.push(t)},e.prototype.remove=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)if(a.hasOwnProperty(n)){for(var r=this.index,i=0;i<6;i++){var s=n.substr(i,1)||-1;if(!r[s])break;r=r[s]}if(r.length)for(var i in r)if(this.equals(r[i],e)){r.splice(i,1);break}}},e.prototype.equals=function(e,t){for(var a in e)if(e.hasOwnProperty(a))switch(typeof e[a]){case"object":if(!this.equals(e[a],t[a]))return!1;break;case"function":if(void 0===e[a]||e[a].toString()!=t[a].toString())return!1;break;default:if(e[a]!=t[a])return!1}for(var a in t)if(void 0===t[a])return!1;return!0},e.prototype.intersect=function(e,t){var a=[];if(r(e[0])||r(t[0]))return e.filter((function(e){return-1!==t.indexOf(e)}));for(;e.length>0&&t.length>0;)if(e[0]._order<t[0]._order)e.shift();else if(e[0]._order>t[0]._order)t.shift();else{if(this.equals(e[0],t[0])){var n=e.shift();n&&a.push(n)}t.shift()}return a},e.prototype.add=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)a.hasOwnProperty(n)&&this.toIndexTree(n,e)},e.prototype.search=function(e){var t=this.index,a=this.strToSearchPrefixes(e),n=[],r=!1;for(var i in a)if(a.hasOwnProperty(i)){if(r&&!n)break;var s=this.localSearch(a[i],0,t);s.sort((function(e,t){return e._order-t._order})),n=r?this.intersect(n,s):s,r=!0}for(var o=n[0],l=n.length+1,c=[],d=1;d<l;d++){var u=n[d];u!=o&&(c.push(o),o=u)}return c},e.prototype.localSearch=function(e,t,a){if(!a)return[];var n={};for(var r in e)e.hasOwnProperty(r)&&(n[s=r.substr(t,1)||-1]||(n[s]={}),n[s][r]=1);if(6==t++)return a;var i=[];for(var s in n)if("-1"===s)for(var o in a)a.hasOwnProperty(o)&&i.push.apply(i,this.localSearch(n[s],t,a[o]));else{var l=this.localSearch(n[s],t,a[s]);i.push.apply(i,l)}return i},e}();function r(e){return!isNaN(e)}},221:function(e,t,a){e.exports=a("V1UX")},"8h6g":function(e,t,a){"use strict";a.r(t),a.d(t,"VIDEO_UPLOAD_EXTS",(function(){return n})),a.d(t,"VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB",(function(){return r})),a.d(t,"VIDEO_UPLOAD_CHUNK_SIZE",(function(){return i}));a("KKXr");var n="avi mp4 3gp mpeg mov flv f4v wmv mkv webm vob rm rmvb m4v mpg ogv ts m2ts mts mxf".split(" "),r=5,i=4194304},"9KdC":function(e,t,a){"use strict";a.r(t),a.d(t,"EntityType",(function(){return n}));var n,r=function(){return(r=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};!function(e){e.Online="online"}(n||(n={}));var i=function(e){var t=this,a=e.getQueue,n=e.registerQueue;this.QUEUE_KEY_TTL=3e3,this.MAX_RETRIES=5,this.listeners=[],this.retriesLeft=this.MAX_RETRIES,this.restart=function(){t.intervalId&&clearInterval(t.intervalId),0!==t.retriesLeft&&(t.retriesLeft--,t.getQueue().then((function(e){t.retriesLeft=t.MAX_RETRIES;var a=r({},e);t.intervalId=window.setInterval((function(){t.registerQueue(a,(function(e,n){if(function(e){return void 0!==e.err}(n))t.restart();else{a.ts=n.ts;for(var r=0,i=n.events;r<i.length;r++)for(var s=i[r],o=0,l=t.listeners;o<l.length;o++)(0,l[o])(s)}}))}),t.QUEUE_KEY_TTL)})).catch((function(e){console.error(e),setTimeout(t.restart,t.QUEUE_KEY_TTL)})))},this.subscribe=function(e){return t.listeners.push(e),1===t.listeners.length&&t.restart(),function(){t.listeners=t.listeners.filter((function(t){return t!==e})),0===t.listeners.length&&(t.retriesLeft=t.MAX_RETRIES,t.intervalId&&clearInterval(t.intervalId))}},this.registerQueue=n,this.getQueue=a};t.default=i},J4gp:function(e,t,a){"use strict";a.r(t),a.d(t,"convoPickerMode",(function(){return w})),a.d(t,"ConvoPicker",(function(){return M}));var n=a("q1tI"),r=a.n(n),i=a("i8i4"),s=a.n(i),o=a("ZxpX"),l=a("CGHU"),c=a("8tCR"),d=a("3blr"),u=a("URsI"),g=a("h++7"),m=a("6krn"),p=a("5R8M"),_=a("Hri0"),b=a("P13b"),h=a("mvjr"),f=a("Aegd"),v=a("RXF5"),O=a("gdug"),y=function(){return(y=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},j=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a},C=function(e){var t=e.peerId,a=e.name,n=e.photo,i=e.online,s=e.memberCount,l=e.mode,c=void 0===l?w.DEFAULT:l,d=e.isSelected,u=e.isDisabled,g=e.isActive,m=e.isCasper,C=e.className,E=j(e,["peerId","name","photo","online","memberCount","mode","isSelected","isDisabled","isActive","isCasper","className"]),T=function(e,t,a,n){void 0===n&&(n=0);var i=Object(b.isContactPeer)(e);switch(!0){case Array.isArray(a):return r.a.createElement(h.default,{photos:a});case i:return r.a.createElement(f.ConversationNoPhoto,{id:e,text:Object(b.getUserInitials)(t),size:"34",specificType:7});default:return r.a.createElement(v.default,{isOnline:!!n,isMobile:!!O.mobPlatforms[n],title:t,photo:a,onlineSize:"s"})}}(t,a,n,i),S=m?'<span class="ConvoPickerRow__itemTitle ConvoPickerRow__itemTitle--casper">\n        <span class="ConvoPickerRow__itemTitleText">\n          '+a+"\n        </span>\n      </span>":a,I=c===w.RADIO?r.a.createElement("span",{className:Object(o.classNames)("ConvoPickerRow__radio",{"ConvoPickerRow__radio--selected":d})}):void 0,k=Object(o.classNames)("ConvoPickerRow",C,{"ConvoPickerRow--disabled":u});return r.a.createElement(p.default,y({active:g,selectable:!u,canBeHovered:!1,chevron:c===w.DEFAULT&&!u,aside:I,className:k},E),r.a.createElement(_.default,{size:"34",title:S,photo:T,description:s,className:"ConvoPickerRow__itemContent"}))};var w,E=a("rHUl"),T=a("d8ub"),S=function(){return(S=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},I=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]])}return a},k=m.default.getLang;!function(e){e.DEFAULT="default",e.RADIO="radio"}(w||(w={}));var M=function(e){var t,a=e.searchValue,i=void 0===a?"":a,m=e.isLoading,_=void 0!==m&&m,h=e.convos,f=e.mode,v=void 0===f?w.DEFAULT:f,O=e.selectedConvos,y=void 0===O?[]:O,j=e.checkDisabled,M=e.onSearchValueChange,P=e.onSearchInputKeydown,L=e.onConvoSelect,A=e.onListLoadMore,D=void 0===A?function(){}:A,B=e.onAddClick,x=e.searchInputGetter,N=e.className,R=e.style,F=I(e,["searchValue","isLoading","convos","mode","selectedConvos","checkDisabled","onSearchValueChange","onSearchInputKeydown","onConvoSelect","onListLoadMore","onAddClick","searchInputGetter","className","style"]),H=Object(o.classNames)("ConvoPicker",N),U=Object(n.createRef)(),G=Object(n.useState)(0),q=G[0],K=G[1],V=function(e){var t=Math.max(e-1,0);return j&&j(h[t])?V(t):t},W=function(e){var t=Math.min(e+1,h.length-1);return j&&j(h[t])?W(t):t},z=function(e){e!==q&&(K(e),function(e){if(t){var a=h[e].peerId,n=t.querySelector('[data-id="'+a+'"]');if(n&&n instanceof HTMLElement){var r=n.offsetTop,i=t.scrollTop;if(r<i)t.scrollTop=r;else{var s=t.offsetHeight,o=r+n.offsetHeight;o>i+s&&(t.scrollTop=o-s)}}}}(e))};Object(n.useEffect)((function(){x&&U.current&&x(U.current.element)}),[]);var Y=!!B&&!i,$=(Y?[r.a.createElement(p.default,{selectable:!1,key:"add","data-id":0},r.a.createElement(T.ListAddControl,{onClick:B},k("mail_new_convo_from_invite")))]:[]).concat(h.map((function(e,t){var a=e.peerId,n=e.photo,i=e.name,s=e.online,o=!!j&&j(e);return r.a.createElement(C,{key:a,"data-id":a,peerId:a,photo:n,name:i,online:s,memberCount:Object(b.getChatMemberCount)(e),mode:v,isCasper:Object(E.isCasperChatTab)(e),isSelected:y.includes(a),isActive:t===q,isDisabled:o,onClick:function(){o||L(a)},onMouseEnter:function(){return K(o?-1:t)}})})));return r.a.createElement("div",S({className:H,onMouseLeave:function(){return K(-1)},style:R},F),r.a.createElement(l.BlockSearchInput,{value:i,onChange:M,onKeyDown:function(e){switch(e.which||e.keyCode){case g.ARROW_UP:z(V(q)),e.preventDefault();break;case g.ARROW_DOWN:z(W(q)),e.preventDefault();break;case g.ENTER:L(h[q].peerId),e.preventDefault()}P(e)},placeholder:k("mail_top_search"),autoFocus:!0,key:"search",ref:U}),_&&r.a.createElement(c.default,{className:"ConvoPicker__stub",key:"loading"},r.a.createElement(d.default,null)),!_&&i&&0===h.length&&r.a.createElement(c.default,{className:"ConvoPicker__stub",key:"no-results"},k("mail_im_search_empty_chats")),!_&&(h.length>0||Y)&&r.a.createElement(u.default,{virtualized:!0,className:"ConvoPicker__results",loadMore:D,hasMore:!1,ref:function(e){var a=s.a.findDOMNode(e);a&&a instanceof HTMLElement&&(t=a)},key:"results"},$))}},LYnS:function(e,t,a){"use strict";a.r(t);a("pIFo");var n=a("86+7"),r=a("6krn"),i=a("ftTi"),s=r.default.getLang;t.default=()=>[{id:"user name",label:s("mail_community_templates_hint_name"),process:e=>Object(n.oCacheGet)(e,Object(i.getPeer)(e)).first_name},{id:"user surname",label:s("mail_community_templates_hint_last_name"),process(e){var t=Object(n.oCacheGet)(e,Object(i.getPeer)(e));return t.name.replace(t.first_name,"").trim()}},{id:"admin name",label:s("mail_community_templates_hint_your_name"),process:e=>Object(n.oCacheGet)(e,vk.id).first_name},{id:"admin surname",label:s("mail_community_templates_hint_your_last_name"),process(e){var t=Object(n.oCacheGet)(e,vk.id);return t.name.replace(t.first_name,"").trim()}},{id:"community",label:s("mail_community_templates_hint_community"),process:e=>Object(n.oCacheGet)(e,e.get().id).name},{id:"greeting",label:s("mail_community_templates_hint_greeting"),process(e){var t=(new Date).getHours();return s(t>=3&&t<12?"mail_greeting_good_morning":t>=12&&t<17?"mail_greeting_good_afternoon":t>=17&&t<=23?"mail_greeting_good_evening":"mail_greeting_good_night")}}]},RQ7Z:function(e,t,a){"use strict";a.r(t),a.d(t,"screenfull",(function(){return n}));var n=function(){var e=function(){for(var e,t,a=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],n=0,r=a.length,i={};n<r;n++)if((e=a[n])&&e[1]in document){for(n=0,t=e.length;n<t;n++)i[a[0][n]]=e[n];return i}return!1}(),t={request:function(t){var a=e.requestFullscreen;(t=t||document.documentElement)[a]()},exit:function(){document[e.exitFullscreen]()},toggle:function(e){this.isFullscreen?this.exit():this.request(e)},raw:e};return!!e&&(Object.defineProperties(t,{isFullscreen:{get:function(){return Boolean(document[e.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[e.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[e.fullscreenEnabled])}}}),t)}()},V1Nw:function(e,t,a){"use strict";function n(e,t,a){var n=0,r=e,i=[],s=!1;function o(){!i.length||n>0||s||(t(i),i=[])}return{pause:function(){n++},resume:function(){n>0&&(n--,o())},onLp:function(e,t,n){s||(r>=e?(r=t,i.push.apply(i,n),o()):a&&(s=!0,a(r).then((function(e){var t=e[1],a=e[2];r=t,s=!1,i.push.apply(i,a),o()}))))}}}a.r(t),a.d(t,"createLongpollEventsQueue",(function(){return n}))},V1UX:function(e,t,a){"use strict";a.r(t);a("rE2o"),a("ioFf"),a("HEwt"),a("a1Th"),a("91GP"),a("VRzm"),a("Vd3H"),a("pIFo"),a("SRfc"),a("T39b"),a("OEbY"),a("rGqo"),a("Btvt"),a("9AAn"),a("OG14");var n=a("vT4u"),r=a("P13b"),i=a("rHUl"),s=a("MhhX"),o=a("UIlX"),l=a("aong"),c=a("ofcU"),d=a("rDjD");function u(e,t,a){var i=intval(domData(a,"msgid"));if(!Object(l.getSelectionText)()&&!Object(r.checkSelectClick)(t)){var s=intval(domData(a,"peer"));return e.set(n.cancelSearch.bind(null,s)),e.get().longpoll.push([Object(d.changePeer)(s,i)]),!1}}function g(e,t){return{isAll:e=>Object(n.isSearchAllLoaded)(e.get().peer,e.get()),loadMore:e=>function(e){return Object(n.isSearchAllLoaded)(e.get().peer,e.get())?Promise.resolve(""):Object(n.searchMessagesInplace)(e.get().peer,e.get())}(e),unmount(){Object(c.destroyModule)(t)}}}function m(e){return e.findIndex(e=>"number"==typeof e.peerId&&e.href)>-1}function p(e,t){var a=u.bind(null,t);return g(0,Object(c.createModule)({handlers:(t,n)=>{n(e,"click","_im_mess",a)}}))}var _=a("h++7"),b=a("R5GP"),h=a("+/AQ");function f(e,t){return Object(l.toArray)(e).find(e=>domData(e,"list-id")===t)}function v(e,t){return Object(l.toArray)(e).findIndex(e=>domData(e,"list-id")===t)}function O(e,t,a,n){if(a){y(e,t,n);var r=domData(a,"list-id"),i=r&&f(t.children,r);i&&n.forEach(e=>addClass(i,e)),e.setState({hoveredListItemId:r})}}function y(e,t,a){var n=domQuery("."+a.join("."),t);n&&Object(l.toArray)(n).forEach(e=>{a.forEach(t=>removeClass(e,t))}),e.setState({hoveredListItemId:null})}function j(e,t){var a=t&&domQuery("."+t.join("."),e)[0];return a?domData(a,"list-id"):null}function C(e,t,a){return e.map(t).reduce((e,t)=>(e[t]=!0,e),a)}function w(e,t,a){return{ids:C(a.get().elements,e,{}),scrolls:t,activated:!0}}function E(e,t,a){return a.elements=a.elements.filter(a=>t(a)!==e),delete a.ids[e],Promise.resolve(a)}function T(e,t,a){var n=[];a.elements=a.elements.map(a=>{var r=t(a),i=e.filter(e=>t(e)===r)[0];return n.push(r),i||a});var r=e.filter(e=>!inArray(t(e),n));return a.elements=a.elements.concat(r),Promise.resolve(a)}function S(e){var t={};return e.forEach(e=>{"r"===e[0]&&t["a,"+e[1]]?delete t["a,"+e[1]]:t[`${e[0]},${e[1]}`]=e}),Object.keys(t).map(e=>t[e])}function I(e,t,a,n,r,i,s){for(var o=0;o<n;o++)e=domNS(e);var l=se(r(t));return domData(l,"list-id",a),e?i.insertBefore(l,e):i.appendChild(l),s&&s(l),e}function k(e,t,a,n,r){var i=n.get(),s=i.limit,o=i.offset,c=function(e,t){var a=t.get();return!a._sortedEls&&e&&t.setState({elements:a.elements.sort(e),_sortedEls:!0}),t.get().elements}(a().sortFn,n).slice(0,o+s),d=function(e,t){for(var a=[],n=Math.max(e.length,t.length),r=0;r<n;r++){var i=e[r],s=t[r];!i&&s?a.push(["a",s,r]):i&&!s?a.push(["r",i,r]):i!==s&&(a.push(["r",i,r]),a.push(["a",s,r]))}var o=S(a),l=S(a.reverse());return o.length>l.length?l:o}(Object(l.toArray)(e.children).map(e=>domData(e,"list-id")).filter(e=>!!e),c.map(e=>a().idFn(e).toString()));if(function(e,t,a,n,r){if(0!==t.length){var i=(t=t.sort((e,t)=>e[2]-t[2])).filter(e=>"a"===e[0]);if(t.filter(e=>"r"===e[0]).map(t=>e.children[t[2]]).forEach(e=>re(e)),0!==i.length)for(var s=i.shift(),o=s[2],l=(I(e.children[o],a[s[2]],s[1],0,n,e,r),0);l<i.length;l++)s=i[l],I(e.children[o],a[s[2]],s[1],s[2]-o,n,e,r),o=s[2]}}(e,d,c,a().renderFn,a().onRenderFn),function(e,t){e.get().loading?t.update(!1,!0):(e.get().loading=!0,t.update(!1,!0),e.get().loading=!1)}(n,t),r)return d.filter(e=>"a"==e[0]).map(e=>parseInt(e[1]))}function M(e,t,a,n){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=e.get(),l=t.getContainer().children,c=v(l,n||o.hoveredListItemId);c<0||(o.limit+o.offset<c?e.setState({offset:c-o.limit+1}).then(k.bind(null,t.getContainer(),t,a)):Promise.resolve()).then(()=>{var e=l[c],a=t.scrollTop(),n=t.getScrollHeight(),o=e.offsetHeight;i="center"===i?-.5*n:i,s="center"===s?n/2:s;var d=r?function(e){t.smoothScroll(e-t.scrollTop())}:t.scrollTop.bind(t),u=a+i>e.offsetTop,g=o+e.offsetTop>a+n-s;u?d(e.offsetTop-i):g&&d(e.offsetTop-n+o+s)})}function P(e,t){if(e.get().loading||e.get().stop||!e.get().activated)return Promise.resolve([]);e.get().loading=!0;for(var a=arguments.length,n=new Array(a>2?a-2:0),r=2;r<a;r++)n[r-2]=arguments[r];return t(...n).then(()=>{e.get().loading=!1})}function L(e,t,a){return a.scrolls||(a.scrolls={}),a.scrolls[e]&&!t||(a.scrolls[e]={scrolled:a.scrolled||0,scrollItem:a.scrollItem}),Promise.resolve(a)}function A(e,t,a,n){var i=e.get(),s=i.elements,o=n.getContainer(),l=e.setState({offset:i.offset+i.limit}).then(()=>{var a,r=i.offset,l=i.limit;return l+r>s.length?a=t().more(r,l).then(t=>!1===t?[]:(0===t.length&&e.setState({stop:!0}),t)).then(B.bind(null,e,o,n,t,i.pipeId)):(a=Promise.resolve(),k(o,n,t,e)),a});if(!a){var c=s.length>0?"im-preloader_fixed-bottom":"im-preloader_fixed-center";Object(r.wrapLoading)(o)(l,"bottom",c)}return l}function D(e,t){var a=e.get().pipeId;return!(void 0!==a&&void 0!==t&&a!==t)}function B(e,t,a,n,r,i){return!!D(e,r)&&e.setState(function(e,t,a){var n=e.filter(e=>!a.ids[t(e)]);return{_sortedEls:!1,els:n,ids:C(n,t,a.ids),elements:a.elements.concat(n)}}(i,n().idFn,e.get())).then(k.bind(null,t,a,n))}function x(e,t,a){var n=P.bind(null,t,A.bind(null,t,a)),r=(e,n)=>{(t.get().activated||e)&&(void 0!==n&&t.get().elements.length>0&&t.setState({scrolled:n}),a().onScroll&&a().onScroll())},i=Object(h.createScroll)(e,{noScroll:t.get().noScroll,nativeScroll:t.get().nativeScroll,scrollChange:r.bind(null,!1),more:!!a().more&&n.bind(null,!1)}),s=Object(c.createModule)({handlers:(n,r)=>{r(e,"click",t.get().elCls,a().onClick)}});return t.setState(w(a().idFn,{},t)),{pipe:(e,n)=>(t.setState({pipeId:n}),e.then(B.bind(null,t,i.getContainer(),i,a,n))),replacePreserveOrder:e=>t.set(T.bind(null,e,a().idFn)).then(k.bind(null,i.getContainer(),i,a)),pipeReplace(e,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.setState({pipeId:n,stop:!1}),e.then(e=>{if(D(t,n))return t.setState({elements:e,_sortedEls:!1,ids:C(e,a().idFn,{})}).then(k.bind(null,i.getContainer(),i,a,t,r))})},wipe(){i.getContainer().innerHTML=""},deactivate(){t.setState({activated:!1})},activate(){t.setState({activated:!0})},saveScroll:(e,a)=>t.set(L.bind(null,e,a)),updateScroll(){i.update(!1,!0)},toTop(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?i.smoothScroll(-i.scrollTop()):i.scrollTop(0),e&&r(e,0)},scrollTop:e=>i.scrollTop(e),restoreScroll(e){var a=t.get().scrolls,n=a[e];return n&&(t.setState({scrolls:extend({},a,{[e]:null})}),i.scrollTop(n.scrolled)),!!n},unsetScroll(e){t.setState({scrolls:extend({},t.get().scrolls,{[e]:null})})},scrollPage(e,t){var a=i.scroll.scroller,n=i.scrollTop(),r=n+("up"===e?-1:1)*a.clientHeight;t?i.smoothScroll(r-n):i.scrollTop(r)},scrollToElement(e,n,r,s){M(t,i,a,e,n,r,s)},getScroller:()=>i.getScroller(),checkMore:e=>t.get().elements.length<t.get().limit?n(e,i):Promise.resolve([]),add:(e,n)=>B(t,i.getContainer(),i,a,n,e),hoverNextElement(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=i.getContainer(),o=s.children,c=v(o,t.get().hoveredListItemId||j(s,n)),d=Object(l.toArray)(o).slice(c+1).find(a().hoverableFn);O(t,s,d,e),M(t,i,a,null,!1,r.top,r.bottom)},hoverPrevElement(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=i.getContainer(),o=s.children,c=v(o,t.get().hoveredListItemId||j(s,n)),d=c>=0&&Object(l.toArray)(o).slice(0,c).reverse().find(a().hoverableFn);O(t,s,d,e),M(t,i,a,null,!1,r.top,r.bottom)},hoverFirstElement(e,n){var r=i.getContainer(),s=r.children,o=Object(l.toArray)(s).findIndex(a().hoverableFn),c=s[o];!t.get().hoveredListItemId&&c&&(O(t,r,c,e),M(t,i,a,o,!1,n.top,n.bottom))},hoverElement(e,n,r){var s=i.getContainer(),o=s.children,l=v(o,e),c=o[l];c&&(O(t,s,c,n),M(t,i,a,l,!1,r.top,r.bottom))},unhoverElements(e){y(t,i.getContainer(),e)},reset(){var e=t.get().scrolls;t.reset(),t.setState(w(a().idFn,e,t))},getHoveredElement:()=>f(i.getContainer().children,t.get().hoveredListItemId),getCurrentElements:()=>t.get().elements,isLoading:()=>t.get().loading,isEmpty:()=>0===t.get().elements.length,remove(e){t.set(E.bind(null,e,a().idFn)).then(k.bind(null,i.getContainer(),i,a))},unmount(){Object(c.destroyModule)(s),i.destroy()}}}var N=a("eaP7"),R=a("1y80"),F=a("86+7"),H=a("kxld"),U=a("FWc3"),G=a("3qfP"),q=a("rudk"),K=a("6x51");function V(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return W(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return W(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var z=["_im_dialog_selected","nim-dialog_selected"],Y=["_im_dialog_hovered","nim-dialog_hovered"];function $(e,t,a){removeClass(t.parentNode,"im-page--dialogs_with-mess");var n=a.getCurrentElements().filter(e=>e.message);a.toTop(),a.reset(),Object(R.statlogsProbValueEvent)(.01,"im_search_stat",1,"search_messages_only"),n.length>0?(n=[{type:"sep_messages"}].concat(n),e.setState({searchOnlyMessages:!0})):n=[Ce()],a.pipeReplace(Promise.resolve(n))}function X(e){return hasClass(e,"_im_search")}function Q(e,t,a,s){if(Object(i.isSearching)(e)&&e.get().searchAllLoaded||Object(i.isRecentSearchesActive)(e))return Promise.resolve([]);if(e.get().dialog_search_going||Object(r.isClassicInterface)(e)&&0!==e.get().peer)return Promise.resolve(!1);if(Object(i.isSearching)(e))return Object(n.searchMessages)(Object(i.getSearchText)(e),e.get()).then(e=>{var t=V(e,2),a=t[0];return je(t[1],a)});var o=e.get().active_tab,l=e.get().dialog_tabs_all;return![_.FOLDER_MESSAGE_REQUEST,_.FOLDER_PEER_TAGS].includes(o)&&l[_.FOLDER_ALL]&&!Object(r.isReversedDialogs)(e)||l[o]?0===Ne(e).length?Object(i.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):Promise.resolve([{type:"empty_dialogs"}]):Promise.resolve([]):e.set(n.loadDialogs).then(t=>{var a=Ne(e);return 0===a.length?Object(i.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):[{type:"empty_dialogs"}]:a})}function J(e,t,a,s,o,l){var c=parseInt(domData(l,"peer"),10),u=Object(i.getTab)(a,c),g=hasClass(l,"_im_sugg_"+c);if(u||g){var m=gpeByClass("_im_peer_target",o.target)&&checkEvent(o),p=Object(r.isCommunityInterface)(a),_=p&&gpeByClass("_im_dialog_peer_tags",o.target);if(!m&&!_){var b=a.get(),h=X(l),f=parseInt(domData(l,"msgid"),10);if(u&&Object(i.tabIsMessageRequestToChat)(u))return e().showChatInvitationBox(a,c),cancelEvent(o);var v="";if(Object(i.isSearching)(a)&&(v="conversations_search"),Object(i.isRecentSearchesActive)(a)&&(v="recent_searches"),g&&(v="popular_suggestions"),h&&(v="message_search"),u&&checkEvent(o))return window.open(function(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=Object(r.getBaseLink)(e),s=()=>`${i}?sel=${Object(r.convertPeerToUrl)(t.peerId)}${n&&a?"&msgid="+a:""}`;if(n)return s();if(Object(r.isUserPeer)(t.peerId)||Object(r.isCommunityPeer)(t.peerId))return Object(r.isClassicInterface)(e)?s():t.href;return s()}(a,u,f,h));if(s.saveScroll("list"),h&&b.msgid!==f)b.longpoll.push([Object(d.changePeer)(c,f,!1,!1,v)]);else if(c!==b.peer){b.longpoll.push([Object(d.changePeer)(c,!1,!0,!0,v)]);var O=Object(i.isSearching)(a);O&&!hasClass(l,"_dont_add_recent")&&Object(n.saveRecentSearchPeer)(c,cur.imDb),O&&u&&!Object(r.isClassicInterface)(a)&&setTimeout(()=>{var e=u.message?u.message.messageId:u.peerId;s.scrollToElement(e.toString(),!0,0,"center")},100)}else c===b.peer&&e().goToHistoryEnd();!p&&b.pin_convo_promo_tt_hash&&u&&!Object(q.isPinnedSortId)(u.major_sort_id)&&b.hintsTree.then(e=>{e.list.slice(0,5).map(e=>e[0]).includes(c)&&Object(r.showPinConvoPromoTooltip)(b,b.pin_convo_promo_tt_hash)}),cancelEvent(o)}}}function Z(e,t,a,n){var s,o="string"==typeof a.photo&&""!==a.photo,l=Object(r.isContactPeer)(t),c=a.tab||a.name,d=l?Object(r.prepareContactName)(c):c;if(Object(r.isChatPeer)(t)&&!o)s=Object(r.renderPhotosFromTab)(e,a,n);else{if(l){var u=Object(r.getUserInitials)(c);s=`<div class="nim-peer--contact-avatar nim-peer--contact-avatar_${Object(i.isSearching)(e)&&!a.message?34:n?50:46}">${u}</div>`}else s=`<img src="${a.photo}" alt="">`;n&&(s=getTemplate("im_dialogs_link_img",{href:a.href||a.link,photo:s}))}return{photo:s,userLink:`<span class="_im_dialog_link">${d}</span>`}}function ee(e){return!Object(r.isPendingForward)(e)}function te(e,t,a,n){return a?"":n?getTemplate("im_img_prebody",{photo:t}):e+":"}function ae(e,t,a,n,s,o,l,c,d,u){var g="",m=Object(i.isChannelPeer)(Object(i.getTab)(e,a));return t&N.FLAG_OUTBOUND?g=te(getLang("mail_by_you"),u,m,d):Object(r.isChatPeer)(a)&&0!==n&&(g=te(Object(F.oCacheGet)(e,n).first_name,Object(F.oCacheGet)(e,n).photo,m,d)),l=Object(r.renderShortText)(a,c,l,s,o),g?getTemplate("im_drow_prebody",{prebody:g,body:l}):l}function ne(e,t,a,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o=[];return Object(r.isClassicInterface)(n)&&o.push("nim-dialog_classic"),Object(i.isRecentSearchesActive)(n)&&o.push("nim-dialog_recent"),o.push("nim-dialog_empty"),s.search&&o.push("_im_search"),getTemplate("im_drow",{peer:e.peerId,msg_id:"",photo:t,user_link:a,date:"",body:"",unread:"",more:o.join(" "),is_star:"",unread_message_string:"",is_online:onlinePlatformClass(e.online),is_unread:"",is_unread_out:"",is_selected:e.peerId==n.get().peer?"nim-dialog_selected _im_dialog_selected":""})}function ie(e,t,a){return!!(a&N.FLAG_OUTBOUND)&&(!Object(r.isSelfMessage)(t.peerId,e.get().gid)&&(!(Object(r.isChatPeer)(t.peerId)&&t.data&&t.data.closed)&&(!t.unread&&!(!t.lastmsg||t.lastmsg<=t.out_up_to))))}function oe(e){var t=be(e);return!!(e.unread>0&&t)||!!Object(i.isTabMarkedUnread)(e)}function le(e){return!(!e.mentions||!e.mentions.length)}function de(e){return function(e){return!(!e.expiring_messages||!e.expiring_messages.length)}(e)&&!le(e)}function ue(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=a||be(t),l=Z(e,t.peerId,t,Object(r.isClassicInterface)(e)),c=l.photo,d=l.userLink;if(!o)return ne(t,c,d,e,n);var u=o.flags,g=Object(r.isFvkcomgroup)(e,t.peerId),m=Object(i.tabIsMessageRequestToChat)(t),p=Object(i.isCasperChat)(e,t.peerId),_=Object(r.isContactPeer)(t.peerId),b=_e(t,e,a),h=Object(i.isCommunityChat)(e,t.peerId),f=t.major_sort_id,v=[];n.search&&v.push("_im_search","nim-dialog_search"),inArray(t.peerId,e.get().mutedPeers)&&v.push("nim-dialog_muted"),t.verified&&v.push("nim-dialog_verified"),p&&v.push("nim-dialog_casper"),Object(i.isRecentSearchesActive)(e)&&v.push("nim-dialog_recent"),Object(s.isMessageEmpty)(o)&&!p&&v.push("nim-dialog_empty"),Object(r.isClassicInterface)(e)&&v.push("nim-dialog_classic"),t.folders&N.FOLDER_IMPORTANT&&v.push("nim-dialog_starred"),!n.search&&Object(r.isUnrespond)(e,t.peerId,t)&&v.push("nim-dialog_unrespond"),(g||h)&&e.get().gid&&v.push("nim-dialog_deny-remove"),le(t)&&v.push("nim-dialog_unread-mentions"),de(t)&&v.push("nim-dialog_unread-expiring"),t.callInProgress&&v.push("nim-dialog_active-call"),t.callInProgress&&t.callInProgress.participants.count<1&&v.push("nim-dialog_active-call-empty"),Object(q.isPinnedSortId)(f)&&v.push("nim-dialog_pinned");var O=Object(i.tabIsMessageRequestToChat)(t)?t.mr&&t.mr.request_date:o.date,y=e.get().timeshift,j=O?getShortDateOrTime(O,y,!0,getLang("months_sm_of","raw")):"",C=!ie(e,t,u)||m||Object(i.isSearching)(e)?"":"nim-dialog_unread-out",w=t.unread>0?getLang("mail_im_new_messages",t.unread):"",E=_?Object(r.prepareContactName)(t.tab):t.tab;return getTemplate("im_drow",{peer:t.peerId,msg_id:o.messageId,photo:c,user_link:d,date:j,body:b,unread_message_string:w,tab_name:stripHTML(E),unread:Object(r.simplifyCounter)(t.unread),more:v.join(" "),is_online:onlinePlatformClass(t.online),is_unread:oe(t)?"nim-dialog_unread":"",is_unread_out:C,is_selected:n.noselect||m||t.peerId!=e.get().peer?"":"nim-dialog_selected _im_dialog_selected"})}function me(e,t,a,n,o){if(!t.deletedDialog)if(hasClass(e,"nim-conversation-search-row"))pe(e,t,a);else{var c=a.get(),d=be(t),u=d.flags,g=_e(t,a),m=Z(a,t.peerId,t,Object(r.isClassicInterface)(a)),p=m.photo,_=m.userLink,b=a.get().timeshift,h=d.date?getShortDateOrTime(d.date,b,!0,getLang("months_sm_of","raw")):"";Te(e,t),val(geByClass1("_dialog_body",e),g),val(geByClass1("_im_dialog_date",e),h),val(geByClass1("_im_dialog_unread_ct",e),Object(r.simplifyCounter)(t.unread));var f=geByClass1("_im_dialog_link",e);f&&val(f.parentNode,_);var v=geByClass1("_im_dialog_photo",e);v.innerHTML!==p&&val(v,p),c.is_peer_profile_enabled&&(c.peer||Ae(e,a));var O=Object(i.isCasperChat)(a,t.peerId);toggleClass(e,"nim-dialog_verified",!!t.verified),toggleClass(e,"nim-dialog_casper",O),toggleClass(e,"nim-dialog_muted",inArray(t.peerId,a.get().mutedPeers)),toggleClass(e,"nim-dialog_unrespond",Object(r.isUnrespond)(a,t.peerId,t)),toggleClass(e,"nim-dialog_classic",Object(r.isClassicInterface)(a)),toggleClass(e,"nim-dialog_unread",oe(t)),toggleClass(e,"nim-dialog_unread-mentions",le(t)),toggleClass(e,"nim-dialog_unread-expiring",de(t)),toggleClass(e,"nim-dialog_active-call",!!t.callInProgress),toggleClass(e,"nim-dialog_active-call-empty",!!t.callInProgress&&t.callInProgress.participants.count<1),toggleClass(e,"nim-dialog_pinned",Object(q.isPinnedSortId)(t.major_sort_id)),toggleClass(e,"nim-dialog_deny-remove",a.get().gid>0&&(Object(r.isFvkcomgroup)(a,t.peerId)||Object(i.isCommunityChat)(a,t.peerId))),removeClass(e,"nim-dialog_failed"),removeClass(e,"nim-dialog_deleted"),addClass(e,"_im_dialog"),Object(l.toggleOnline)(geByClass1("_im_peer_online",e),t.online),toggleClass(e,"nim-dialog_recent",Object(i.isRecentSearchesActive)(a)),toggleClass(e,"nim-dialog_empty",Object(s.isMessageEmpty)(d)&&!O),toggleClass(e,"nim-dialog_unread-out",ie(a,t,u)&&!Object(i.isSearching)(a)),Le(e),toggleClass(e,"nim-dialog_starred",t.folders&N.FOLDER_IMPORTANT),o&&setTimeout((function(){addClass(geByClass1("_im_dialog_"+t.peerId,n),"nim-dialog_injected")}),100)}}function pe(e,t,a){Te(e,t),toggleClass(e,"nim-dialog_recent",Object(i.isRecentSearchesActive)(a)),val(geByClass1("_im_dialog_unread_ct",e),Object(r.simplifyCounter)(t.unread)),toggleClass(e,"nim-dialog_unread",oe(t)),toggleClass(e,"nim-dialog_unread-expiring",de(t)),toggleClass(e,"nim-dialog_unread-mentions",le(t));var n=Z(a,t.peerId,t,Object(r.isClassicInterface)(a)).photo,s=geByClass1("_im_dialog_photo",e);s.innerHTML!==n&&val(s,n),Object(l.toggleOnline)(geByClass1("_im_peer_online",e),t.online)}function _e(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=a||be(e),o=Object(i.tabIsMessageRequestToChat)(e),l=Object(i.isCasperChat)(t,e.peerId);if(o){var c=Object(r.isClassicInterface)(t),d=e.mr&&e.mr.inviter_id,u=Object(F.oCacheGet)(t,d),g=c?u.name:u.short_name,m=c?getTemplate("im_img_prebody",{photo:u.photo}):"",p=getLang("mail_mr_service_message").replace(/{user}/,g);return m+p}if(Object(r.isPeerBlocked)(e.peerId,t)){var _=t.get().block_states[e.peerId].name,b=getLang("mail_community_answering").replace("{username}",_);return getTemplate("im_drow_prebody",{prebody:b,body:""})}return Object(s.isServiceMsg)(n)&&!o?Object(r.renderServiceMsg)(t,n,e.peerId,!1):l&&Object(s.isMessageEmpty)(n)?getLang("mail_empty_casper_message"):Object(s.isExpiredCasperMessage)(n)?getLang("mail_expired_message"):ae(t,n.flags,e.peerId,n.userId,!0,n.attaches,n.text,n.subject,Object(r.isClassicInterface)(t),Object(F.oCacheGet)(t,t.get().id).photo)}function be(e){var t=e.lastmsg_meta;return Array.isArray(t)&&(t=Object(G.getMessageFromTuple)(t)),t||Object(G.getMessageFromTuple)([-1,0,e.peerId,0,"",{},{},-1,-1,0])}function he(e,t,a){var s=Object(i.getTab)(e,t),o=Object(i.tabIsMessageRequestToChat)(s),l=Object(r.showLeaveDialog)(e,t,i=>{a().updateMenu(e);var s=Promise.resolve();Object(r.isChatPeer)(t)&&(s=o?e.set(n.rejectMessageRequest.bind(null,t)):e.set(n.leaveChat.bind(null,t))),i&&s.then(()=>Object(r.cleanHistory)(e,l,a,n.flushHistory,t)),l.hide()})}function fe(e,t,a,i,s,o){var l=gpeByClass("_im_dialog",o,a);if(cancelEvent(s),!l)return!1;var c=intval(domData(l,"peer")),d=t.get(),u=Object(r.isCommunityPeer)(c)||Object(r.isUserPeer)(c);if(d.recentSearch){var g=Object(n.removeFromRecentSearch)(c,cur.imDb);re(l),0===g.length&&Pe(t,i,e)}else Object(r.isClassicInterface)(t)&&u?Object(n.deleteDialog)(c,d).then(a=>{var n=V(a,2),r=n[0],i=n[1];r?(!function(e,t,a,n,r){var i=geByClass1("_dialog_body",t);addClass(t,"nim-dialog_deleted"),removeClass(t,"_im_dialog"),val(i,getTemplate("im_delete_actions",{text:langNumeric(a,getLang("mail_im_X_message_deleted","raw")),peer:e,spam_id:n}))}(c,l,r,i),e().updateMenu(t)):he(t,c,e)}):he(t,c,e);return!1}function ve(e,t){Object(r.toggleMessageRequestsTab)(e,e=>{t().restoreDialogs(e,!0)},n.changeDialogsTab)}function Oe(e,t){switch(t.type){case"sep_btn_search_msg":return Object(r.renderBtnSearchOnlyMessages)(e);case"sep_messages":return Object(r.renderMessagesSep)();case"sep_conversations":return Object(r.renderConversationsSep)();case"sep_popular":return Object(r.renderPopularSuggSep)();case"popular_sugg":return Object(r.renderPopularSuggestions)(e);case"clear_recent":return Object(r.renderClearRecent)();case"empty_dialogs":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_list_empty")});case"empty_message_requests":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_mr_empty")});case"empty":return getTemplate("im_dialogs_none",{msg:getLang("mail_im_search_empty")});case"message_request_notice":return getTemplate("im_dialogs_message_requests_notice",{msg:getLang("mail_message_request_tab_notice")});case"message_request_button_go":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_tab_mr")});case"message_request_button_return":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_go_to_all_tab")});default:return t.message?ue(e,t,t.message,{noselect:!0,search:!0}):t.local_index||Object(i.isSearching)(e)?function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=Z(e,t.peerId,t,Object(r.isClassicInterface)(e)),s=n.photo,o=n.userLink,l=Object(r.isContactPeer)(t.peerId)?Object(r.prepareContactName)(t.tab):t.tab,c=ee(e),d=""===a?[]:[a];return Object(i.isRecentSearchesActive)(e)&&d.push("nim-dialog_recent"),Object(r.isClassicInterface)(e)&&d.push("nim-csr_classic"),inArray(t.peerId,e.get().mutedPeers)&&d.push("nim-dialog_muted"),Object(i.isCasperChatTab)(t)&&d.push("nim-dialog_casper"),le(t)&&d.push("nim-dialog_unread-mentions"),de(t)&&d.push("nim-dialog_unread_expiring"),getTemplate("im_conversation_search_row",{peer:t.peerId,msg_id:t.lastmsg||"",photo:s,user_link:o,unread:Object(r.simplifyCounter)(t.unread),tab_name:stripHTML(l),is_unread:oe(t)?"nim-dialog_unread":"",is_online:onlinePlatformClass(t.online),is_selected:t.peerId==e.get().peer&&c?"nim-dialog_selected _im_dialog_selected":"",more:d.join(" ")})}(e,t):ue(e,t)}}function ye(e,t,a,i,s,o){var l=intval(domData(o,"peer")),c=domData(o,"action"),d=domData(o,"sid"),u=geByClass1("_im_dialog_"+l,t),g=intval(domData(o,"spam"));switch(c){case"restore":u&&e.set(n.restoreDialog.bind(null,l,d,g)).then(()=>{addClass(u,"_im_dialog"),removeClass(u,"nim-dialog_deleted"),me(u,e.get().tabs[l],e,t,!1),i().updateMenu(e)});break;case"spam":var m=`${getLang("mail_im_dialog_marked_spam")}\n        <button type="button" class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction"\n          data-action="restore"\n          data-spam="1"\n          data-sid="${d}" data-peer="${l}">\n            ${getLang("mail_restore")}\n        </button>`;if(u){var p=geByClass1("_dialog_body",u);val(p,m),Object(n.spamDialog)(l,d,e.get())}break;case"block":(Object(r.isCommunityInterface)(e)?Object(r.showBlacklistBox)(l,e):Object(r.showBlacklistBoxUser)(l,e)).once("success",(function(){e.set(n.flushHistory.bind(null,l)).then(()=>{a().restoreDialogs(e)})}))}cancelEvent(s)}function je(e,t){return e.map(e=>Object(G.getMessageFromTuple)(e)).map(e=>extend({},t[e.peerId],{message:e}))}function Ce(e){return{type:"empty",lang:e}}function we(e,t,a,r){var i=gpeByClass("_im_dialog",r,t),s=intval(domData(i,"peer"));return e.set(n.toggleDialogImportant.bind(null,s)),setTimeout((function(){Ee(e,t,a,r)}),100),cancelEvent(a),!1}function Ee(e,t,a,n){Object(U.showTooltip)(n,{text:function(){var a=gpeByClass("_im_dialog",n,t),r=domData(a,"peer");return e.get().tabs[r].folders&N.FOLDER_IMPORTANT?getLang("mail_im_toggle_important_off"):getLang("mail_im_toggle_important")},black:1,zIndex:1,shift:[14,8],toup:Re(e,n.getBoundingClientRect().top)})}function Te(e,t){var a=t.unread>0?getLang("mail_im_new_messages",t.unread):"",n=geByClass1("_im_unread_blind_label",e);val(n,a)}function Se(e,t,a,r,s){var o=gpeByClass("_im_dialog",s,t),l=intval(domData(o,"peer")),c=e.get().tabs[l].lastmsg;return e.set(n.markDialogAnswered.bind(null,l,c)).then(()=>{me(o,e.get().tabs[l],e,t),Object(i.isRecentSearchesActive)(e)||a().restoreDialogs(e)}),showDoneBox(getLang("mail_marked_as_answered"),{out:1e3}),cancelEvent(r),!1}function Ie(e){var t=Object(i.isSearching)(e),a=e.get().searchOnlyMessages;return Object(r.isClassicInterface)(e)?{top:t&&!a?96:60,bottom:Object(r.isCommunityInterface)(e)?42:87}:{top:t&&!a?36:0,bottom:0}}function ke(e,t){e.hoverFirstElement(Y,Ie(t))}function Me(e){e.unhoverElements(Y)}function Pe(e,t,a){if(Object(i.doPopularSuggExist)(e)){t.pipeReplace(Promise.resolve([{type:"sep_popular"},{type:"popular_sugg"}])),t.toTop()}else a().cancelSearch(e),cancelStackFilter("im_search")}function Le(e){var t=geByClass1("_im_dialog_star",e),a=geByClass1("_im_dialog_date",e);if(t&&a){var n=a.offsetWidth;t.style.right=15+n+14+"px"}}function Ae(e,t){var a=t.get(),n=parseInt(domData(e,"peer")),s=Object(i.getTab)(a,n);if(a.is_peer_profile_enabled&&Object(r.isCommunityInterface)(a)&&s&&!Object(i.isChannelPeer)(s)&&!Object(i.isCommunityChat)(a,n)){var l=geByClass1("_im_dialog_peer_tags",e);if(s.ad_id||a.peer_profile_tags&&s.peer_tags&&s.peer_tags.ids){var c=s.peerTagsMaxWidth||0;if(!c){var d=geByClass1("_im_dialog_name_w",e).offsetWidth;c=340-(d+6+(s.verified?16:0)),t.set(e=>(e.tabs[n].peerTagsMaxWidth=c,Promise.resolve(e)))}Object(o.renderPeerTags)(l,c,t,n)}else l.innerHTML&&(l.innerHTML="")}}function De(e,t){if(Object(r.isCommunityInterface)(e)){["empty_dialogs","empty"].includes(domData(t,"list-id"))?Object(o.updateEmptyDialogsMargin)():hasClass(t,"_im_dialog")&&(Le(t),Ae(t,e))}}function Be(e){checkEvent(e)||cancelEvent(e)}function xe(e,t,a,n,s){return{selectPeer(t,a){for(var n=geByClass("_im_dialog",e),r=a.get().peer,i=0;i<n.length;i++){var s=n[i],o=intval(domData(s,"peer")),l=intval(domData(s,"msgid"));o===r&&(!X(s)||t===l&&X(s))?(addClass(s,"nim-dialog_selected"),addClass(s,"_im_dialog_selected")):hasClass(s,"_im_dialog_selected")&&(removeClass(s,"nim-dialog_selected"),removeClass(s,"_im_dialog_selected"))}},appendFastDialogs(t,n,s){removeClass(e.parentNode,"im-page--dialogs_with-mess"),a.saveScroll("list"),s?(a.reset(),Object(r.isPendingForward)(t)||Object(i.isRecentSearchesActive)(t)||!m(n)?Object(i.isRecentSearchesActive)(t)&&(m(n)&&(n=[{type:"clear_recent"}].concat(n)),Object(i.doPopularSuggExist)(t)&&(n=[{type:"sep_popular"},{type:"popular_sugg"}].concat(n))):n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n),t.setState({searchOnlyMessages:!1}),a.pipeReplace(Promise.resolve(n)).then(()=>ke(a,t))):a.pipe(Promise.resolve(n)),Object(r.isClassicInterface)(t)&&!Object(r.isReservedPeer)(t.get().peer)||a.toTop()},deactivate(){a.deactivate()},activate(){a.activate()},hoverFirstDialog(e){ke(a,e)},hoverNextDialog(e){a.hoverNextElement(Y,z,Ie(e))},hoverPrevDialog(e){a.hoverPrevElement(Y,z,Ie(e))},unhoverDialogs:Me.bind(a),selectHoveredDialog(t){var r=geByClass1("_im_dialog_hovered",e);r||(r=geByClass1("_im_dialog",e)),r&&J(n,0,t,a,{},r)},appendSearch(t,n,r){var i=je(r,n);r.length>0?(addClass(e.parentNode,"im-page--dialogs_with-mess"),a.pipe(Promise.resolve([{type:"sep_messages"}].concat(i))).then(()=>ke(a,t))):(0===a.getCurrentElements().length&&a.pipeReplace(Promise.resolve([Ce()])),removeClass(e.parentNode,"im-page--dialogs_with-mess"))},update(e){a.pipeReplace(Promise.resolve(Ne(e)))},updateDialog(t,a){var n=geByClass1("_im_dialog_"+t,e);n&&!X(n)&&me(n,Object(i.getTab)(a,t),a,e)},focusOnSelected(t){var n=t.get().peer;if(n){var r=geByClass1("_im_dialog_"+n,e);r?a.scrollTop(r.offsetTop-r.offsetHeight):a.toTop()}},restoreScroll(e){a.restoreScroll("list")||a.toTop()},forceScrollReinit(){var e=a.getScroller();e&&(e.style.overflowY="hidden",setTimeout(()=>e.style.overflowY="",0))},restoreDialogs:(t,i,s)=>(removeClass(e.parentNode,"im-page--dialogs_with-mess"),t.setState({searchOnlyMessages:!1}),0!==Ne(t).length||a.isLoading()||(i=!0),i&&a.reset(),s&&a.wipe(),a.pipeReplace(Promise.resolve(Ne(t))).then(()=>{if(i&&(!Object(r.isClassicInterface)(t)||!t.get().peer)){var e=function(e,t,a){return Object(r.isClassicInterface)(a)||t().toggleSettingsLoader(a,!0),e.checkMore(!Object(r.isClassicInterface)(a)).then(()=>{Object(r.isClassicInterface)(a)||t().toggleSettingsLoader(a,!1)})}(a,n,t);return a.toTop(),e}}).then(()=>Me(a))),appendDialogs(t,n){removeClass(e.parentNode,"im-page--dialogs_with-mess"),n.forEach(a=>{var n=geByClass1("_im_dialog_"+a.peerId,e);n&&pe(n,a,t)}),Object(r.isPendingForward)(t)||Object(i.isRecentSearchesActive)(t)||!m(n)||(n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n)),t.setState({searchOnlyMessages:!1}),a.isEmpty()&&0===n.length&&Object(r.isPendingForward)(t)&&(n=[Ce(getLang("mail_im_search_empty_chats"))]),a.replacePreserveOrder(n)},updateCounter(t,a){var n=geByClass1("_im_dialog_"+a,e),s=Object(i.getTab)(t,a);if(n&&!X(n)&&(Te(n,s),val(geByClass1("_im_dialog_unread_ct",n),Object(r.simplifyCounter)(s.unread)),toggleClass(n,"nim-dialog_unread",oe(s)),toggleClass(n,"nim-dialog_unread-out",ie(t,s,be(s).flags)),toggleClass(n,"nim-dialog_unread-mentions",le(s)),toggleClass(n,"nim-dialog_unread-expiring",de(s))),Object(i.isRecentSearchesActive)(t)){var o=geByClass1("_im_sugg_"+a,e);o&&(val(geByClass1("_sugg_unread_ct",o),Object(r.simplifyCounter)(s.unread)),toggleClass(o,"sugg-is_unread",s.unread>0))}},removeDialog(e,t){a.remove(t)},updateOnline(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n){var r=a.get().tabs[t],i=geByClass1("_im_peer_online",n);Object(l.toggleOnline)(i,r.online)}},setDialogFailed(t,a,n){var r=geByClass1("_im_dialog_"+t,e);r&&(n.get().tabs[t].lastmsg===a&&(addClass(r,"nim-dialog_failed"),val(geByClass1("_im_dialog_unread_ct",r),"!")))},scrollUp(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];a.toTop(e,t),a.saveScroll("list",!0)},saveScroll(e){a.saveScroll("list",!0)},promoteDialog(n,r){var s=geByClass1("_im_dialog_"+r,e);s&&!X(s)||!Object(i.isSearching)(n)?(a.pipeReplace(Promise.resolve(Ne(n)),void 0,!0).then(t=>{!inArray(r,t)&&s&&me(s,Object(i.getTab)(n,r),n,e)}),t().updateTyping(r,n)):a.unsetScroll("list")},removeSelection(t){var n=t.get().peer.toString(),i=`._im_dialog_${n}.${z.join(".")}`,s=domQuery(i,e)[0];z.forEach(e=>removeClass(s,e)),Object(r.isClassicInterface)(t)||a.hoverElement(n,Y,Ie(t))},updateScroll(){a.updateScroll()},updateTyping(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n&&!X(n)&&!a.get().tabs[t].deletedDialog){var s=geByClass1("_im_dialog_typing",n),o=!Object(r.isClassicInterface)(a),l=Object(r.formatTyper)(Object(i.getTab)(a,t).activity,t,!Object(r.isChatPeer)(t),a.get(),1,o);val(s,l),toggleClass(n,"nim-dialog_typing",l)}},updateStarPosition(){!function(e){geByClass("_im_dialog",e).forEach(e=>{Le(e)})}(e)},renderPeerTags(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;a?Ae(geByClass1("_im_dialog_"+a,e),t):function(e,t){var a=t.get();a.is_peer_profile_enabled&&Object(r.isCommunityInterface)(a)&&geByClass("_im_dialog",e).forEach(e=>{Ae(e,t)})}(e,t)},unmount(){a.unmount(),Object(c.destroyModule)(s)}}}function Ne(e){var t=e.get(),a=t.active_tab,n=t.dialog_tabs[a],i=t.tabs,s=n.map(e=>i[""+e]).sort(K.sortFn.bind(null,e)),o=t.dialog_tab_cts.mr;if(a===_.FOLDER_MESSAGE_REQUEST&&s.unshift({type:"message_request_notice"}),!Object(r.isClassicInterface)(e))switch(a){case _.FOLDER_ALL:o>0&&s.unshift({type:"message_request_button_go"});break;case _.FOLDER_MESSAGE_REQUEST:s.unshift({type:"message_request_button_return"})}return s}function Re(e,t){var a=e.get().gid?220:150;return!(Object(o.isPeerTagsFolder)(e)&&t<=a+46)&&(t>a||Object(i.isSearching)(e))}function Fe(e,t,a,s){var d=Object(c.createMutations)(xe),u=d.callMutations,g=d.bindMutations,m=function(e,a){Object(U.showTooltip)(a,{text:()=>{if(Object(i.isRecentSearchesActive)(t))return getLang("mail_hide_from_recent");var e=Number(a.getAttribute("data-peer")),n=Object(i.getTab)(t,e),s=Object(i.tabIsMessageRequestToChat)(n);return Object(r.isChatPeer)(e)&&!s?Object(H.doesChatTabHaveFlag)(Object(i.getTab)(t,e),1024)?getLang("mail_unfollow_channel"):Object(i.isChatActive)(n)?getLang("mail_leave_chat"):getLang("mail_delete"):getLang("mail_delete")},black:1,[Object(r.isClassicInterface)(t)?"center":"needLeft"]:!0,shift:Object(r.isClassicInterface)(t)?[-4,10]:[0,10],toup:Re(t,a.getBoundingClientRect().top),zIndex:1})},p=function(e,a){Object(U.showTooltip)(a,{text:getLang("mail_end_conversation"),black:1,center:!0,zIndex:1,shift:[1,4],toup:Re(t,a.getBoundingClientRect().top)})},_=Ee.bind(null,t,e),h=we.bind(null,t,e),f=Se.bind(null,t,e,u),v={idFn:e=>function(e,t){return t.message?t.message.messageId:Object(i.isSearching)(e)&&t.peerId?t.peerId+"cr":t.peerId||t.type}(t,e),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:Oe.bind(null,t),more:Q.bind(null,t,u),onScroll:!!Object(r.isClassicInterface)(t)&&(()=>{(bodyNode.scrollTop||document.documentElement.scrollTop)<=0&&!layers.visible&&browser.safari?addClass(s,"im-page--header_static"):removeClass(s,"im-page--header_static")}),onRenderFn:De.bind(null,t)},O=x(e,Object(b.default)({limit:40,offset:0,nativeScroll:!!Object(r.isClassicInterface)(t),height:64,elements:Ne(t)}),()=>v),y=J.bind(null,a,u,t,O),j=$.bind(null,t,e,O),C=ye.bind(null,t,e,u,a),w=fe.bind(null,a,t,e,O),E=ve.bind(null,t,a),T=Object(c.createModule)({handlers:(i,s)=>{s(e,"click","_im_dialog_close",w),s(e,"click","_im_dialog_markre",f),s(e,"click","_im_dialog_star",h),s(e,"click","_im_dialog",y),s(e,"click",r.MESSAGE_SEARCH_CLASS,j),s(e,"mouseover","_im_dialog_close",m),s(e,"mouseover","_im_dialog_markre",p),s(e,"click",r.CLEAR_RECENT_CLASS,()=>{Object(n.resetRecentSearch)(cur.imDb),Pe(t,O,a)}),s(e,"click",r.TOGGLE_MR_TAB,E),s(e,"mouseover","_im_dialog_star",_),s(e,"click","_im_dialog_daction",C),s(e,"click","_im_peer_target",Be),Object(r.isCommunityInterface)(t)&&t.get().is_peer_profile_enabled&&(s(e,"mouseover","_im_peer_tags_extra",e=>Object(o.onPeerTagsExtraHover)(e,t)),s(e,"click","_im_dialog_peer_tag",e=>Object(o.onDialogPeerTagClick)(e,t))),i(e,"mouseover",Object(l.throttle)(O.unhoverElements.bind(O,Y),100))}});return g(e,u,O,a,T)}a("KKXr"),a("hhXQ");var He,Ue,Ge,qe,Ke,Ve,We,ze,Ye,$e,Xe,Qe,Je,Ze,et,tt=a("O8ze"),at=a("hC3G"),nt=a("ftTi"),rt=a("/eGY"),it=a("RQ7Z"),st=a("XLJO"),ot=(a("/8Fb"),a("ZVxX")),lt=a("EasH"),ct=browser.msie&&intval(browser.version)<10?window.XDomainRequest:window.XMLHttpRequest;function dt(e){var t=e%60;return parseInt(e/60)+":"+(t<10?"0":"")+t}var ut=!1,gt=!1,mt=100;function pt(e){var t=e.get().peer;Object(r.isFullyLoadedTab)(e,t)&&!Object(r.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(r.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendRecordingAudio.bind(null,t))}function _t(e){if(!gt){gt=!0,Object(r.lockButton)(Ve);var t={peer:Ye.get().peer,from_place:cur.docsChooseFrom,imhash:cur.docsChooseImHash,blockPersonal:cur.docsChooseBlockPersonal,mail_add:cur.docsChooseMailAdd};(function(e){return new Promise((t,a)=>{var n=e.getFormData(),r=new ct;r.onload=r.onerror=function(e){var n=e.currentTarget.response;200==this.status&&n.length>0&&"{"==n[0]?(n=JSON.parse(n),t(n)):a()},r.open("POST",et.upload_url,!0),r.send(n)})})(e).then(e=>e.file?new Promise((a,n)=>{ajax.post("/docs.php",extend({act:"a_save_doc",from:"choose",from_place:t.from_place,imhash:t.imhash,blockPersonal:t.blockPersonal,mail_add:t.mail_add},e),{onDone:(e,n)=>{Ot(),Qe([["doc",e+"_"+n,"audiomsg"]],{},t.peer),Tt(),a()},onFail:function(e){n(e)},progress:null})}):Promise.reject()).then(()=>{Object(r.unlockButton)(Ve),gt=!1}).catch(()=>{gt=!1,Object(r.unlockButton)(Ve),Object(lt.showFastBox)(getLang("global_error"),getLang("mail_audio_message_upload_error"))})}}function bt(){Ze(),Ue.innerHTML=dt(ut.duration),ut.duration>=600&&Et()}function ht(e){e.set(n.cancelRecording).then(Ct)}function ft(){Ze(),stManager.add(["voice_message_player.js","speech.js"],(function(){ut||(ut=Speech.newRecorder(),addEvent(ut,"progress",bt)),AudioMessagePlayer.detachPlayer(),AudioMessagePlayer.pauseGlobalMedia(),ut.record().then(()=>{var e;e=Ye,et.isRecording=!0,cancelStackPush("audio_message_cancel",ht.bind(null,e)),hideProgress(geByClass1("im-audio-message-send-wrapper",He)),Ue.innerHTML="0:00",addClass(He,"im-audio-message_recording"),removeClass(He,"im-audio-message_recorded"),function(){He&&He.classList&&He.classList.remove("im-audio-message-input--hidden");geByClass1("_im_chat_input_parent",ze).classList.add("im-chat-input--hidden")}(),(Xe=Speech.createVisualization("wave",ut.source,Ge)).start();var t=Ge.getBoundingClientRect();mt=(t.right-t.left)/3}).catch(e=>{AudioMessagePlayer.resumeGlobalMedia();var t=e.name;switch(e.name){case"DevicesNotFoundError":case"NotFoundError":case"NotAllowedError":t="mail_audio_message_device_error";break;case"PermissionDeniedError":case"PermissionDismissedError":t="mail_audio_message_permission_error";break;case"Unsupported":t="mail_audio_message_unsupported_error"}Object(lt.showFastBox)(getLang("global_error"),getLang(t)),console.error(e)})}))}function vt(){ut&&ut.stop(),Xe&&(Xe.destroy(),Xe=null)}function Ot(){et.isRecording=!1,cancelStackFilter("audio_message_cancel")}function yt(){jt(),_t(ut)}function jt(){var e;AudioMessagePlayer.loaded&&AudioMessagePlayer.resumeGlobalMedia(),removeEvent(ut,"finish",jt),removeEvent(ut,"finish",yt),e=URL.createObjectURL(ut.buffer),domData($e,"duration",ut.duration),domData($e,"ogg",e),domData($e,"mp3",e),geByClass1("audio-msg-track--duration",$e).innerHTML=dt(ut.duration),geByClass1("audio-msg-track--wave-wrapper",$e).innerHTML=AudioMessagePlayer.getWave(ut.wave,mt),removeClass(He,"im-audio-message_recording"),addClass(He,"im-audio-message_recorded")}function Ct(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Ot(),AudioMessagePlayer.loaded&&(AudioMessagePlayer.resumeGlobalMedia(),AudioMessagePlayer.detachPlayer()),removeEvent(ut,"finish",jt),removeEvent(ut,"finish",yt),vt(),Tt(),e&&Je()}function wt(){ut.isRecording?(addEvent(ut,"finish",yt),removeEvent(ut,"finish",jt),vt()):_t(ut)}function Et(){addEvent(ut,"finish",jt),removeEvent(ut,"finish",yt),vt()}function Tt(){removeClass(He,"im-audio-message_recorded"),removeClass(He,"im-audio-message_recording"),He&&He.classList&&He.classList.add("im-audio-message-input--hidden"),geByClass1("_im_chat_input_parent",ze).classList.remove("im-chat-input--hidden")}function St(){ge("audiomsg_record"),$e=ge("audiomsg_player"),ze=geByClass1("_im_chat_input_w"),He=geByClass1("im-audio-message-input",ze),Ue=geByClass1("audio-msg-track--duration",He),Ge=geByClass1("audio-msg-track--wave",He),Ke=geByClass1("im-audio-message--cancel-btn",He),Ve=geByClass1("_im_audio_send",He),We=geByClass1("audio-msg-track--btn",He),geByClass1("im-chat-input--text",ze);var e=geByClass1("im-chat-input--textarea",ze);addClass(e,"_voice_field_wrap"),addEvent(qe,"click",ft),addEvent(Ke,"click",Ct),addEvent(Ve,"click",wt),addEvent(We,"click",Et)}function It(){!function(){ut&&removeEvent(ut,"progress",bt);removeEvent(qe,"click",ft),removeEvent(Ke,"click",Ct),removeEvent(Ve,"click",wt),removeEvent(We,"click",Et)}(),$e=He=Ue=Ge=qe=Ke=Ve=We=null}function kt(e,t,a){return{cancelRecording:Ct,start:function(){ft()},unmount(){Ct(!1),It()}}}function Mt(e,t,a,i,s){return Ye=t,et=t.get().audio_msg,Ze=pt.bind(null,t),Qe=a,Je=s,Object(ot.initFailBack)(),Object(r.getAvailableMicrophones)().then(e=>{var a=e.length>0;a?(St(),i()):setCookie("remixvoice","0",7),t.set(n.setVoiceMessageAvail.bind(null,a))}).catch(e=>{throw setCookie("remixvoice","0",7),e}),(0,Object(c.createMutations)(kt).bindMutations)(e,t,a)}var Pt=a("q1tI"),Lt=a.n(Pt),At=a("i8i4"),Dt=a.n(At),Bt=a("1Ot2"),xt=a("Jbbb"),Nt=a("ZxpX"),Rt=a("BiHW"),Ft=a("N4ZS"),Ht=a("Egk5");a("17x9");function Ut(){return(Ut=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function Gt(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}class qt extends Pt.Component{constructor(){super(...arguments),this.onLinkClick=e=>{var t=this.props.action.link;if(/^https:\/\/(.+\.)?vk\.com\/gifts580392144\?act=send&ref=[^&]+$/.test(t))return Object(lt.showBox)("al_gifts.php",{act:"get_gift_box",mid:580392144,fr:0,ref:t.split("&ref=")[1]},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(Ht.cancelEvent)(e)},this.onButtonClick=()=>{var e=this.props,t=e.action,a=e.sendMessage,n=e.appHash,r=e.keyboardAuthorId,i=e.store;return Object(rt.handleButtonClick)(t,a,{appHash:n,keyboardAuthorId:r,store:i})}}render(){var e=this.props,t=e.action,a=(e.sendMessage,e.appHash,e.keyboardAuthorId,Gt(e,["action","sendMessage","appHash","keyboardAuthorId"])),n=Object(rt.getButtonAppearance)(this.props),r=Object(rt.getButtonLabel)(this.props),i=t.type,s=Pt.createElement(Rt.default,Ut({wide:!0,overflow:!0},a,{type:t.type,appearance:n,className:"BotButton BotButton--"+i,onClick:this.onButtonClick}),Pt.createElement("span",{className:"BotButtonLabel Button--overflow",dangerouslySetInnerHTML:{__html:r}}));switch(t.type){case rt.BUTTON_TYPE_OPEN_LINK:return this.wrapLinkButton(s);default:return s}}wrapLinkButton(e){var t=this.props.action,a=Object(Ft.wrapAwayIfExternal)(t.link,!0);return Pt.createElement("a",{href:a,className:"Keyboard__buttonWrapper",target:"_blank",rel:"nofollow noopener",onClick:this.onLinkClick},e)}}qt.defaultProps={color:rt.BUTTON_COLOR_DEFAULT};var Kt=qt;class Vt extends Pt.Component{static getButtonWidth(e){return`calc(100% / ${e} - 10px)`}render(){var e=this.props.store,t=this.props.send,a=e.get(),n=Object(i.getCurrentKeyboard)(e),r=a.keyboard_app_hash;return n&&n.buttons?Pt.createElement("div",{className:Object(Nt.classNames)("Keyboard",{"Keyboard--hidden":n.hide})},Pt.createElement(Bt.Scroll,{className:"Keyboard__scroll-wrapper"},Pt.createElement("div",{className:"Keyboard__container"},n.buttons.map((a,i)=>Pt.createElement("div",{key:"row-"+i,className:"Keyboard__row"},a.map((i,s)=>Pt.createElement("div",{className:"Keyboard__button",key:"cell-"+s,style:{width:Vt.getButtonWidth(a.length)}},Pt.createElement(Kt,{sendMessage:t,appHash:r,keyboardAuthorId:n.author_id,action:i.action,type:i.action.type,color:i.color,store:e})))))))):null}}var Wt=Object(xt.connect)(Vt);function zt(){return document.getElementById("_im_keyboard_container")}function Yt(e,t,a){return{init(){return new Promise(e=>{this.isMounted=!0,function(e,t,a){var n=zt();if(n){var r=Pt.createElement(xt.default,{value:e},Pt.createElement(Wt,{send:t}));At.render(r,n,a)}}(t,a,e)})},toggle:(e,a,r)=>t.set(n.toggleKeyboard.bind(null,e,a,r)),unmount(){var t=zt();t&&this.isMounted&&At.unmountComponentAtNode(t),this.isMounted=!1,Object(c.destroyModule)(e)}}}var $t=a("LYnS"),Xt=a("nAFc"),Qt=a("fD+e").default,Jt=a("m5nf").default,Zt=a("m5nf"),ea=Zt.MAIN,ta=Zt.EDIT;function aa(e,t){return Object($t.default)().reduce((function(t,a){return t.replace(new RegExp("({"+a.id+"})","gi"),a.process(e))}),t).replace(/&lt;br&gt;/gi,"<br>")}function na(e,t,a,r,s){var o;return{closeSettingsPopup:function(){o&&o.hide()},showSettingsPopup:function(e){var a=this,n={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow:function(){var n=document.getElementById("TemplatesSettings");n&&At.render(Pt.createElement(xt.default,{value:t},Pt.createElement(Jt,{popup:o,section:e,getTemplates:function(){return Object(i.getTemplates)(t)},saveTemplate:a.saveTemplate.bind(a),deleteTemplate:a.deleteTemplate.bind(a),closePopup:a.closeSettingsPopup.bind(a)})),n),requestAnimationFrame((function(){return o.updateBoxCoords()}))}};(o=new lt.MessageBox(n).content('<div id="TemplatesSettings"></div>')).show()},applyTemplate:function(e){var a=Object(i.getTemplates)(t).find((function(t){return t.id===e}));Object(tt.statlogsCommunityTemplatesClickEvent)(),r(aa(t,Object(Xt.prepareToWriting)(a.text)))},getPreparedTemplates:function(){return Object(i.getTemplates)(t).map((function(e){return Object.assign({},e,{name:e.name,text:aa(t,e.text)})}))},saveTemplate:function(e){var a=Object(Xt.decodeHTMLEntities)(e.name),r=Object(Xt.decodeHTMLEntities)(e.text);return t.set(e.id?n.updateTemplate.bind(null,e.id,a,r):n.createTemplate.bind(null,a,r))},deleteTemplate:function(e){return t.set(n.deleteTemplate.bind(null,e))},isNeedRenderTemplates:function(){var e=Object(nt.getPeer)(t);if(!e)return!1;if(!Object(i.isCommunityInterface)(t))return!1;var a=Object(H.getCurrentTab)(t);return(!a||!Object(i.isChannelPeer)(a))&&!Object(i.isCommunityChat)(t,e)},toggleImText:function(e){void 0===e&&(e=this.isNeedRenderTemplates()),s(e)},update:function(){this.toggleImText()},unmount:function(){this.toggleImText(!1)}}}var ra=a("DM26");function ia(e,t){return t.queues[e].currEv=!1,Promise.resolve(t)}function sa(e,t){var a=t.queues[e].currEv;return a?(t.queues[e].errored.push(a),ia(e,t)):Promise.resolve(t)}function oa(e,t,a){return a.queues[e]?(a.queues[e].errored=t?[]:a.queues[e].errored.concat(a.queues[e].evs),a.queues[e].evs=[],ia(e,a)):Promise.resolve(a)}function la(e,t,a,n){var r=n.get().queues[e];if(r&&!r.currEv&&r.evs.length>0&&!r.pause){var i=la.bind(null,e,t,a,n),s=r.evs.shift();r.currEv=s,t(e,s).then(()=>{n.get().opts.waitCommit||n.set(ia.bind(null,e))}).then(i).catch(t=>n.set(sa.bind(null,e)).then(()=>{a(e,function(e,t){var a=ga(e,t.get()).errored;return a.length>0&&a[a.length-1]}(e,n),t)}).then(i))}}function ca(e,t,a){var n=a.queues[e];return n.errored.filter(e=>e.mess.messageId===t).forEach(e=>{e.failed=!1,n.evs.push(e)}),n.errored=n.errored.filter(e=>e.mess.messageId!==t),Promise.resolve(a)}function da(e){var t=Date.now();return Object.keys(e.queues).forEach(a=>ua(a,e,t,18e5)),Promise.resolve(e)}function ua(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=t.queues[e],i=[];return r.errored.forEach(e=>{e.ts>=a-n?(e.failed=!1,r.evs.push(e)):i.push(e)}),r.errored=i,Promise.resolve(t)}function ga(e,t){return t.queues[e]||(t.queues[e]={evs:[],pause:!1,errored:[],currEv:!1}),t.queues[e]}function ma(e,t,a){return ga(e,a).pause=t,Promise.resolve(a)}function pa(e,t,a){return t.ts=Date.now(),ga(e,a).evs.push(t),Promise.resolve(a)}function _a(e){Object.keys(e.get().queues).forEach(t=>{e.set(sa.bind(null,t)),e.set(oa.bind(null,t,!1))})}function ba(e,t,a){var n=Object(b.default)({queues:{},debug:a&&a.debug,opts:extend({},a)},a);return a&&a.store?(n.setState(function(e){for(var t={},a=Object.keys(e.queues),n=a.length,r=0;r<n;r++){var i=a[r],s=e.queues[i];(s.currEv||s.evs.length||s.errored.length)&&(t[i]=s)}return{queues:t,opts:e.opts}}(n.get())),_a(n)):_a(n),{pushMessage:(a,r)=>n.set(pa.bind(null,a,r)).then(n=>{la(a,e,t,n)}),resend(a){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n.set(ca.bind(null,a,r)).then(()=>{var i=n.get().queues[a].evs.filter(e=>e.mess.messageId===r)[0];return la(a,e,t,n),i})},resendAll:()=>n.set(da).then(()=>{Object.keys(n.get().queues).forEach(a=>{la(a,e,t,n)})}),resendPeer:a=>n.set(ua.bind(null,a)).then(()=>{la(a,e,t,n)}),reset:a=>n.set(oa.bind(null,a,!0)).then(n=>{la(a,e,t,n)}),setErrored:(e,t)=>n.set(a=>(ga(e,a).errored=t,Promise.resolve(a))),pause(e){n.set(ma.bind(null,e,!0))},isPaused:e=>!!ga(e,n.get()).pause,complete(a,r){var i=n.get();i.queues[a].currEv&&i.queues[a].currEv.rid===r&&n.set(ia.bind(null,a)).then(()=>{la(a,e,t,n)})},resume(a){n.set(ma.bind(null,a,!1)).then(Object(ra.pause)(.1)).then(()=>{la(a,e,t,n)})},inspectQueue(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!n.get().queues[e])return[];var a=n.get().queues[e];return(t&&a.currEv?[a.currEv]:[]).concat(a.evs.slice()).concat(a.errored.slice().map(e=>extend({},e,{failed:!0}))).sort((e,t)=>e.ts-t.ts)}}}var ha=a("hOuX"),fa=a("4+be"),va=a("QGEU"),Oa=a("BJj/"),ya=(a("Oyvg"),a("rCUf")),ja="jpg jpeg png gif heic heif".split(" "),Ca=["application/vnd.rn-realmedia-vbr","application/vnd.rn-realmedia"];function wa(e){var t=ja.slice(0,ja.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+ja.join(",."):"mask"===e?ja.join("|"):""}function Ea(e,t,a){var n=void 0!==t.ind?t.ind:t,r=t.fileName?n+"_"+t.fileName:t;if(re("upload"+r+"_progress_wrap"),e().unchoose(r),!geByClass1("popup_box_container")){var i=Object(fa.getLang)("mail_add_doc_error");"wrong_music_file"===a?i=Object(fa.getLang)("mail_upload_music_fail"):"wrong_arch_file"===a||"wrong_arch_mp3_file"===a?i=Object(fa.getLang)("mail_upload_arch_fail"):"photo"===Upload.options[n].file_name?i=Object(fa.getLang)("mail_add_photo_error"):"video_file"===Upload.options[n].file_name&&(i=Object(fa.getLang)("video_upload_error")),setTimeout(Object(lt.showFastBox)({title:Object(fa.getLang)("global_error")},i).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+n)||{}).action}),Upload.embed(n)}function Ta(e){var t=void 0!==e.ind?e.ind:e,a=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),n=a?t+"_"+a:e,r=ge("upload"+n+"_progress_wrap");return r&&hide(geByClass1("progress_x",r)),n}function Sa(e,t){if(!e().canAddMedia())return"none";if(!t.items||!t.items.length)return"media";var a="^("+wa("mask")+")";return[].slice.call(t.items).every(e=>{var t=e.type.split("/");return new RegExp(a,"i").test(t[1])})?"photo":[].slice.call(t.items).every(e=>"video"===e.type.split("/")[0]||~Ca.indexOf(e.type))?"video":"doc"}function Ia(e){var t=geByClass1("_im_upload_dropbox"),a=geByClass1("im-page--chat-header").getBoundingClientRect(),n=geByClass1("im-chat-input").getBoundingClientRect();(a.width<10||n.bottom-a.bottom<10)&&(e="none"),t.style.top=a.bottom+"px",t.style.left=a.left+1+"px",t.style.width=a.width-2+"px",t.style.height=n.bottom-a.bottom+"px",t.setAttribute("data-mode",e),"none"!==e&&t.classList.add("im-dropbox--visible")}function ka(){geByClass1("_im_upload_dropbox").classList.remove("im-dropbox--visible")}function Ma(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}function Pa(e,t,a,n){"string"==typeof t&&t.indexOf("TERMINATED")>-1||(t=JSON.parse(t),Upload.onUploadError(e,t.error)),n().reHeight(a)}function La(e,t,a,n,r){var i=t.get().upload_opts,s=geByClass1("_im_upload_photo",r),o=geByClass1("_im_drop_photo",r);return Upload.init(s,i.url,i.params,{accept:wa("accept"),file_name:"photo",file_size_limit:26214400,file_types:wa("types"),file_match:i.opts.ext_re,lang:i.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"photo",max_attempts:3,server:i.opts.server,error:i.opts.default_error,error_hash:i.opts.error_hash,dropbox:o,dragEl:bodyNode,onNoFilteredCallback(e){Upload.onFileApiSend(n,e)},onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var r=window.parseJSON(n);r.photos?function(e,t,a,n){var r=Ta(e);ajax.post("al_photos.php",extend({act:"choose_uploaded"},t),{onDone:function(e,t){n().choose("photo",e,extend(t,{upload_ind:r}))},onFail:Ea.bind(null,n,e)})}(e,r,0,a):Pa(e,n,t,a)},onUploadProgress(e,t,n){var r=void 0!==e.ind?e.ind:e;a().progress("photo",r,Ma(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_photo_fails",1,i.opts.server,t),Ea(a,e,t)},onDragEnter(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Ia(Sa(a,e.dataTransfer))},onDragOut(){ka()},onDrop(){ka()}})}function Aa(e,t,a,n){var r=t.get().upload_doc_opts,i=geByClass1("_im_upload_doc",n),s=geByClass1("_im_drop_doc",n);return Upload.init(i,r.url,r.params,{file_name:"file",file_size_limit:1024*(parseInt(r.file_size_limit_in_MB)||2048)*1024,file_types:"*.*;",lang:r.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"doc",max_attempts:3,server:r.opts.server,error:r.opts.default_error,error_hash:r.opts.error_hash,dropbox:s,dragEl:bodyNode,onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var i=window.parseJSON(n);i.file?function(e,t,a,n){var r=Ta(e),i={act:"a_save_doc",blockPersonal:1,from:"choose",mail_add:1};a.opts.imhash&&(i=extend(i,{from_place:"from_gim",imhash:a.opts.imhash})),ajax.post("docs.php",extend(i,t),{onDone:function(e,t,a){n().choose("doc",e+"_"+t,extend(a,{upload_ind:r}))},onFail:Ea.bind(null,n,e)})}(e,i,r,a):Pa(e,n,t,a)},onUploadProgress(e,t,n){var r=void 0!==e.ind?e.ind:e;a().progress("doc",r,Ma(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_doc_fails",1,r.opts.server,t),Ea(a,e,t)}})}function Da(e,t,a){removeEvent(bodyNode,"dragover dragenter");var r=geByClass1("_im_upload_dropbox"),i=Aa(0,t,a,r),s=function(e,t,a,r,i){var s=t.get().upload_video_params;if(s){var o=geByClass1("_im_upload_video",i),l=geByClass1("_im_drop_video",i);return s.options.visible_dropbox=!1,Object(ya.getUploadModule)(o,l,s,null,{onUploadStart:function(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete:function(e,r){var i=window.parseJSON(r);i.video_id?Object(ya.onVideoUploaded)(e,i,t.get().textMediaSelector,(e,a)=>{var r=document.querySelector('[data-video="'+a+'"]'),i=e.editable.sizes.x[0]||e.thumb;if(r&&i){r.style.backgroundImage=`url(${i})`;var s=gpeByClass("_im_mess",r);"im"===cur.module&&s&&Object(n.updateVideoThumb)(t,s)}}):Pa(e,r,t,a)},onUploadProgress:function(e,t,n){var r=void 0!==e.ind?e.ind:e;a().progress("video",r,Ma(e,t,n))},onUploadError:function(e,t){statlogsValueEvent("upload_video_fails",1,s.options.server,t),Ea(a,e,t)},onNoFilteredCallback:function(e){Upload.onFileApiSend(r,e)},onDragEnter:function(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Ia(Sa(a,e.dataTransfer))},onDragOut:function(){ka()},onDrop:function(){ka()}})}}(0,t,a,i,r),o=La(0,t,a,s,r);cur.lang.attachments_limit=t.get().upload_opts.opts.lang.max_files_warning;var l=Object(c.createModule)({handlers:e=>{var t=ge("im_full_upload");e(t,"change",(function n(r){if(window.Upload&&r.target.files){if(a().canAddMedia()){var i=Array.from(r.target.files),d=i.filter(e=>Upload.checkFileType(e.name,wa("types"))),u=i.filter(e=>Upload.checkFileType(e.name,Object(ya.getUploadVideoExtMasks)("types")));Upload.onFileApiSend(o,d),Upload.onFileApiSend(s,u)}else Object(lt.showFastBox)(Object(fa.getLang)("global_error"),Object(fa.getLang)("global_error"));Object(c.destroyModule)(l);var g=t.cloneNode();g.value="",t.parentNode.replaceChild(g,t),e(t=g,"change",n)}}))}});return{paste(e){Upload.onFileApiSend(o,e)},unmount(){Object(c.destroyModule)(l),Upload.deinit(o),Upload.deinit(s),Upload.deinit(i)}}}var Ba=a("wSs/"),xa=a("rjmT"),Na=a("V1lx");function Ra(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Fa(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Fa(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Fa(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Ha(e,t){if(!e)return!1;window.tooltips&&tooltips.hide(e,t)}function Ua(e){return e.map(e=>({id:e[1],type:e[0],kind:e[2]||null}))}function Ga(e,t,a,n,s,o){var l=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];if(vn(t,n))return Promise.resolve(!1);var c=Xa(n),d=Object(i.getTab)(n,t);c.getBoundAttach(a.message)&&(a.message=""),a.share_url=c.getShareUrl(),a.cancelled_shares=c.getCancelledShares();var u=Object(ha.random)(),g={peerId:t,messageId:"rid"+u,flags:N.FLAG_OUTBOUND,date:intval(Date.now()/1e3)-n.get().timeshift,subject:"",text:Object(r.replaceSpecialSymbols)(clean(a.message)).replace(/\n/gi,"<br>"),local:!0,kludges:{emoji:!0,from_admin:n.get().gid?vk.id:null},type:N.ADD_MESSAGE,attaches:Ua(a.attaches),minorSortId:d.minor_sort_id};return a.rid=u,a.mess=g,e(t,a),n.get().longpoll.push([g]),l&&o().clearText(t,n),s().newMessage(n),Promise.resolve(!0)}function qa(e,t,a,n,r,i,s){var o=arguments.length>7&&void 0!==arguments[7]&&arguments[7];o||(o=e.get().peer);var l=Xa(e),c=Ka(l,s),d=c?l.dData.attaches.map(e=>[e.type,e.id]):[],u={message:"",attaches:[].concat(d,i)};s&&extend(u,s),Va(e,t,!1).then(()=>Ga(a,o,u,e,t,n,!1).then(a=>(c&&ln(e,r,t),Promise.resolve(a)))).catch(t=>{debugLog(t),$a(e,r)})}function Ka(e,t){var a=e.dData,n=t&&t.sticker_referrer,r=n&&0===n.indexOf("suggestion"),i=t&&t.is_hintach_item;return(!a.txt.trim()||r||i)&&0===a.attaches.filter(e=>"reply"!==e.type).length}function Va(e,t,a){return e.get().tabs[e.get().peer].skipped>0?(t().loadingPeer(e),e.setState({no_moving_down:!0}),e.set(n.changePeer.bind(null,e.get().peer,!1,!1)).then(()=>e.set(n.loadPeer.bind(null,e.get().peer,!0,-1,!1))).then(()=>(t().changePeer(e,!1),e.setState({no_moving_down:!1}),a))):Promise.resolve(a)}function Wa(e,t,a){var r=!!intval(domData(a,"val"));r!==cur.ctrl_submit&&(cur.ctrl_submit=r,e.set(n.changeSubmitSettings.bind(null,r)))}function za(e,t,a,r){return!e.get().delayed_ts&&setTimeout(()=>{e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{a(...r)})},t)}function Ya(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(fa.getLang)("mail_send_error"),t=Object(fa.getLang)("global_error");Object(lt.showFastBox)({title:t},e,Object(fa.getLang)("mail_ok"),()=>{nav.reload({force:!0})})}function $a(e,t){document.activeElement&&document.activeElement.blur(),Ya();var a=geByClass1("_im_send",t);return e.set(n.toggleSendingAbility.bind(null,!0)).then(()=>{Object(r.lockButton)(a)})}function Xa(e){return e.get().tfdraft||new xa.ImDraft}function Qa(e,t,a,s,o,c){var d=Object(nt.getPeer)(e),u=Object(i.getCurrentKeyboard)(e)||{},g=u.one_time,m=void 0!==g&&g,p=geByClass1("_im_send",s);return Promise.resolve().then(()=>{if(Object(i.isSendingAvailable)(e)){if(Object(n.isAnythingLoading)(e.get())||!Object(r.isFullyLoadedTab)(e,e.get().peer)){var s=za(e,2e3,Qa,Object(l.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,s)).then(()=>{Object(r.lockButton)(p)})}return clearTimeout(e.get().delayed_ts),e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>Object(r.unlockButton)(p)).then(Va.bind(null,e,t)).then(()=>{var n=c.keyboardAuthorId,i=c.action||{},s=i.attaches||[],l=Object(Xt.decodeHTMLEntities)(i.payload||""),u=Object(Xt.decodeHTMLEntities)(i.label||"");Object(r.isChatPeer)(d)&&(u=`@${Object(F.oCacheGet)(e,n).link.slice(1)} ${u}`);return Object(R.statlogsValueEvent)("message_send_from_keyboard",0,e.get().id,d,n),Ga(a,d,{message:u,attaches:s,payload:l},e,t,o,!1)}).then(()=>m?e.set(n.deleteKeyboard.bind(null,d)):Promise.resolve()).then(()=>o().fixKeyboard())}}).catch(t=>{debugLog(t),$a(e,s)})}function Ja(e,t,a,s,o,c){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];return Promise.resolve().then(()=>{var g=geByClass1("_im_send",s);if(!Object(i.isSendingAvailable)(e))return!1;if(Object(n.isAnythingLoading)(e.get())||!Object(r.isFullyLoadedTab)(e,e.get().peer)){var m=za(e,2e3,Ja,Object(l.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,m)).then(()=>{Object(r.lockButton)(g)})}clearTimeout(e.get().delayed_ts),o().saveText(e);var p=!1,_=Xa(e),b=_.dData.attaches.map(e=>{if("poll"==e.type){var t=c.pollData();return t||(p=!0),[e.type,e.id,t]}return[e.type,e.id]}).concat(u);if(p)return!1;var h=e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{Object(r.unlockButton)(g)}),f=Object(nt.getPeer)(e);return h.then(()=>{var n=_.dData.txt,i=t().getEditingMessage();if(i||n||b.length){if(i)return n||b.length&&!_.hasOnlyReplies(i)?Object(r.isMessageTooLong)(n)?void Object(lt.showFastBox)(Object(fa.getLang)("global_error"),Object(fa.getLang)("mail_err_edit_too_long")):(t().cancelEditing(),void(Object(Ba.wasMessageReallyModified)(e,i,_)&&(Object(Ba.replaceMsgAfterEdit)(e,i,n,b,_.getShareUrl(),_.getCancelledShares()),t().sendEditMessage(e,i),e.get().longpoll.push([Object(d.editMessageLocallyEvent)(i)])))):void Za(e,t,s,i.messageId);var l=Object(r.splitMessageToParts)(n,b).map(n=>Ga(a,f,{message:n.msgText||"",attaches:n.attaches||[]},e,t,o));return Promise.all(l)}}).then(Va.bind(null,e,t))}).catch(t=>{debugLog(t),$a(e,s)})}function Za(e,t,a,r){var i=e.get(),s=i.peer,o=Object(lt.showFastBox)({title:Object(fa.getLang)("mail_dialog_msg_delete_title"),dark:1},Object(fa.getLang)("mail_dialog_msg_delete_for_all"),Object(fa.getLang)("mail_delete"),(function(e){Object(n.removeMessageSend)([r],s,null,"deleteforall",i),o.hide(),t().cancelEditing()}),Object(fa.getLang)("global_cancel"),(function(){o.hide(),rn(geByClass1("_im_text",a))}))}function en(e,t,a){return e.set(n.deliverMessage.bind(null,t,a,{}))}function tn(e,t,a,n){e.get().longpoll.push([Object(d.failedMessage)(t,a.mess,n)])}function an(e,t,a,s,o,l,c,d,u){var g,m=Object(Oa.debounce)(On.bind(null,e,a),500);var p=Emoji.init(geByClass1("_im_text",t),{ttDiff:93,rPointer:!0,ref:"im",onSend:()=>En(e,t).then(e=>e&&s([])),controlsCont:t,forceTxt:!e.get().editable,checkEditable:function(a,s){var o=e.get().peer,l=Emoji.val(s);Object(r.isReservedPeer)(o)||vn(o,e)||Xa(e).dData.txt==l||!l||function(e){var t=e.get().peer;Object(r.isFullyLoadedTab)(e,t)&&!Object(i.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(i.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendTyping.bind(null,t))}(e),Tn(e,t,l),In(e,t,l),m(s);var c=t.offsetHeight;if(g&&g!==c){var u=d().updateScroll();d().scrollFix(e,e.get().peer,u)}g=c},onStickerSend:(e,t,a)=>o([["sticker",e,a]],{sticker_referrer:t}),onHintachSend:(e,t)=>l([[e,t]],{is_hintach_item:!0}),uploadActions:c,suggestionsConfig:e.get().suggestionsConfig,clearText:function(){u().clearText(e.get().peer,e)}});return Emoji.emojiLoadMore(p),e.setState({emojiOptId:p}),p}function nn(e,t,a){var n=Emoji.val(geByClass1("_im_text",t));Object(i.isAnyMessageBeingEdited)(e)&&""!==n||En(e,t).then(t=>{var r=intval(domData(a.target,"tttype"));(2===r&&!0!==t||1===r&&!0===t||3!==r&&""===n)&&window.tooltips&&tooltips.destroy(a.target,{fasthide:!0});var s=Xa(e).dData.attaches.length>0;if(Object(i.isAnyMessageBeingEdited)(e)&&""===n&&!s)return domData(a.target,"tttype",3),Object(U.showTooltip)(a.target,{text:Object(fa.getLang)("mail_delete_for_all"),black:!0,force:3!==r,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});if(!0!==t)return domData(a.target,"tttype",1),Object(U.showTooltip)(a.target,{text:Object(fa.getLang)("mail_added_audiomsg"),black:!0,force:1!==r,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});domData(a.target,"tttype",2);var o=e.get().ctrl_submit?1:0;return Object(U.showTooltip)(a.target,{text:getTemplate("ctrl_submit_hint",{enter_on:o?"":"on",ctrl_on:o?"on":""}),dir:"down",shift:[-28,-5],needLeft:!0,className:"im-chat-input--tt",hasover:!0,force:2!==r,showdt:700,zIndex:200,hidedt:700,appendParentCls:"_im_chat_input_parent",onCreate(){radioBtns.im_submit={els:Object(l.toArray)(geByClass("_im_submit_btn")),val:o}}})})}function rn(e){Emoji.focus(e,!0),setTimeout(Emoji.correctCaret.pbind(e),10)}function sn(e,t,a,n){var o=e.getFwdRaw(),l=t.querySelector("._im_media_fwd"),c=t.parentNode.querySelector("._im_replied_content");if(!(Object(i.getCurrentKeyboard)(n)||{}).hide&&o&&a.toggleKeyboard(!0),l.innerHTML="",c.innerHTML="",o){var d=function(e,t){if(e.get().isEditing){var a=Object(r.getNowEditingMessage)(e);return a&&Object(s.hasReply)(a)}return"reply"===t.type}(n,o),u=d?c:l,g=o.object;u.innerHTML=d?on(g):function(e,t,a,n){if(a.object&&a.object.authorName){var i=Object(r.renderShortText)(0,"",n.text,!0,Object(q.convertKludgesToAttaches)(n.kludges,0));return getTemplate("im_attach_mess",{messages:i,text:n.authorName,date:getSmDate(n.date,e.get().timeshift),modifier:"im-fwd_msg"})}return getTemplate("im_attach_mess",{messages:Object(fa.getLang)("mail_title_X_msgs",t.getFwdCount()),text:Object(fa.getLang)("mail_im_fwd_msgs_title"),date:"",modifier:""})}(n,e,o,g)}}function on(e){var t=Object(r.renderShortText)(0,"",e.text,!0,Object(q.convertKludgesToAttaches)(e.kludges,0));return getTemplate("im_replied_message",{authorName:e.authorName,text:t})}function ln(e,t,a){return e.set(n.forwardMessages.bind(null,null,Xa(e),!1)).then(()=>{var n=t.querySelector("._im_media_fwd"),r=t.parentNode.querySelector("._im_replied_content"),i=document.querySelector("._im_chat_audio_input_parent ._im_replied_content");r&&r.children.length&&(r.innerHTML="",un(e,a)),i&&i.children.length&&(i.innerHTML="",un(e,a)),n&&n.children.length&&(n.innerHTML="",un(e,a)),Tn(e,t)})}function cn(e,t,a){var r=Object(nt.getPeer)(e);e.set(n.acceptMessageRequest.bind(null,r)).then(()=>{wn(e,r,t),a()}).catch(()=>Ya())}function dn(e,t,a){var i=Object(nt.getPeer)(e);e.set(n.rejectMessageRequest.bind(null,i)).then(()=>{Object(r.isClassicInterface)(e)&&t(e),a(e,i),i===e.get().peer&&e.get().longpoll.push([Object(d.resetPeer)()])}).catch(()=>Ya())}function un(e,t){var a=t().updateScroll();t().scrollFix(e,e.get().peer,a)}function gn(e,t,a,r){var i=e.get().peer,s=inArray(i,e.get().mutedPeers);e.set(n.toggleMutePeer.bind(null,i,!s,-1)).then(a().updateState.bind(null,i)),cancelEvent(r)}function mn(e,t,a,r){var i=e.get().peer;e.set(n.returnToChat.bind(null,i)).then(e=>e.set(n.getPinnedMessage.bind(null,i))).then(a().updateChatTopic.bind(null,i)),cancelEvent(r)}function pn(e,t,a,n,s,o,l,c){if("close"!==l&&"open"!==l&&"hide"!==l)throw new Error(`Action "${l}" not found`);var d=e.get(),u=Object(i.getCurrentKeyboard)(e);(Object(r.isCommunityInterface)(e)||!u||d.isEditing)&&(l="hide");var g="close"===l||"hide"===l,m=Promise.resolve();g||a.isMounted||(m=a.init());var p=!u&&"open"!==l;return m.then(()=>(toggleClass(t,"im-chat-input_open-keyboard",!g),toggleClass(t,"im-chat-input_close-keyboard",g&&"hide"!==l),toggleClass(n,"im_chat-input--keyboard-button_hidden","hide"===l),a.toggle(d.peer,g,o))).then(()=>{if(!p||c){var t=s().updateScroll();return s().scrollFix(e,d.peer,t)}})}function _n(e,t){if(Object(i.isAnyMessageBeingEdited)(e))return!1;var a=e.get();if(Object(r.isCommunityInterface)(e))return!1;if(!Object(H.getCurrentTab)(e).moneyTransferAvail)return!1;if(Object(r.isCommunityPeer)(t))return a.moneyTransferCommAvail;if(Object(r.isUserPeer)(t)){var n=inArray(t,a.moneyTransferExcept);return t!=vk.id&&!n&&!Object(r.isContactPeer)(t)}return!1}function bn(e,t){return!Object(i.isAnyMessageBeingEdited)(e)&&(!!e.get().moneyRequestAvail&&(!!Object(H.getCurrentTab)(e).moneyRequestAvail&&(!(!Object(r.isCommunityPeer)(t)&&!Object(r.isChatPeer)(t))||!!Object(r.isUserPeer)(t)&&(t!=vk.id&&!Object(r.isContactPeer)(t)))))}function hn(e,t,a,n,s,o,l,d,u,g,m,p,_,b,h,f){return{restoreKeyboard(){this.toggleKeyboard(!!(ls.get("is_keyboards_hide")||{})[Object(nt.getPeer)(e)])},toggleKeyboard(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!Object(i.getCurrentKeyboard)(e).hide,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return pn(e,n,p,m,o,a,t?"close":"open")},initKeyboard(){if(!e.get().peer||!Object(i.getCurrentKeyboard)(e))return Promise.resolve();var t=!!(ls.get("is_keyboards_hide")||{})[Object(nt.getPeer)(e)];return pn(e,n,p,m,o,!0,t?"close":"open")},fixKeyboard(){var t,a=Object(i.getCurrentKeyboard)(e);return t=a?a.hide?"close":"open":"hide",pn(e,n,p,m,o,!0,t,!0)},hideKeyboard:()=>pn(e,n,p,m,o,!1,"hide"),restoreDraft(e,s,l){t.chosenMedias.length>0&&(e.setState({removingMedias:!0}),t.unchooseMedia(),t.chosenMedias=[],e.setState({removingMedias:!1}));var c=e.get().peer,d={gift:Object(r.isGiftOptionAvailableForPeer)(e,c)&&!Object(i.isAnyMessageBeingEdited)(e),money:Object(r.isMoneyOptionAvailableForPeer)(e,c)&&!Object(i.isAnyMessageBeingEdited)(e),poll:Object(r.isChatPeer)(c)},u=geByClass1("ms_items_more",n);Object.entries(d).forEach(e=>{var t=Ra(e,2),a=t[0],n=t[1],r=geByClass1("ms_item_"+a,u);toggleClass(r,"ms_item--hidden",!n)});var g={im:!0,fromId:-Object(i.getGroupId)(e)||vk.id,peer:c,moneyTransfer:{request:bn(e,c),send:_n(e,c)}},m=e.get().emojiOptId;if(void 0===m?e.setState({suggestionsConfig:g}):Emoji.setSuggestionsConfig(m,g),Object(r.isReservedPeer)(c))return Promise.resolve();var p=Xa(e);return Emoji.val(a)!==p.dData.txt?(!function(e,t){Emoji.val(e,clean(t)),rn(e)}(a,p.dData.txt),In(e,n,p.dData.txt)):rn(a),p.prepareObjects(e.get().gid,s&&s.messageId).then(()=>{if(!wn(e,c,a)&&c==e.get().peer){for(var r=p.dData.attaches,i=0;i<r.length;i++)t.chooseMedia(r[i].type,r[i].id,r[i].object||{});if(sn(p,n,this,e),l){var s=o().updateScroll();o().scrollFix(e,c,s)}Tn(e,n,p.dData.txt)}})},sendMessage(){s([])},sendMessageFromKeyboard(){for(var t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];return Qa.call(null,e,o,b,n,...a)},choose(e,a,n){t.chooseMedia(e,a,n)},updateChosenMedia(e,a,n){t.updateChosenMedia(e,a,n)},canAddMedia:()=>!t.hasRestrictingAttach()&&!vn(e.get().peer,e),isEmpty:e=>!trim(Emoji.val(a))&&!Xa(e).hasAttaches(),unchoose(e){t.unchooseMedia(e)},attachCount:()=>t.attachCount(),progress(e,a,n){t.showMediaProgress(e,a,n)},updateState(e){this.restoreKeyboard(),wn(e,e.get().peer,a)},focusOn(e){Emoji.editableFocus(a,!1,!0)},setDraft(e,t){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=Object(i.getTab)(e,e.get().peer);Object(H.doesChatTabHaveFlag)(n,1024)&&!e.get().gid||(_&&_.update(),e.setState({tfdraft:t}),t&&this.restoreDraft(e,o().getEditingMessage(),a))},clearText(e,r){Xa(r).clear(),t.cancelCheckUrl(),t.unchooseMedia(),t.chosenMedias=[],Emoji.val(a,""),ln(r,n,o);var i=o().updateScroll();o().scrollFix(r,r.get().peer,i)},attachMessages(e,t){if(e.get().peer===t){sn(Xa(e),n,this,e);var a=o().updateScroll();o().scrollFix(e,t,a),Tn(e,n)}},detachMessages(t){var a=Xa(e).getFwdRaw();if(a&&!!a.id.split(";").find(e=>Math.abs(e)===t.messageId))return ln(e,n,o).then(()=>{var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)});return Promise.resolve()},cancelRecording(){g.cancelRecording()},reHeight(e){var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)},isBlocked:()=>vn(e.get().peer,e),toggleStickers(e,t){Emoji.toggleStickers(e.get().emojiOptId,!t)},saveText(e){Xa(e).setText(Emoji.val(geByClass1("_im_text",n)))},resendAll(){h()},resendPeer(){f(e.get().peer)},unmount(){Object(c.destroyModule)(u),t.destroy(),d.unmount(),p.unmount(),_&&_.unmount(),Emoji.destroy(e.get().emojiOptId),g.unmount()}}}function fn(e,t){return!!Object(r.isChatPeer)(e)&&t.get().tabs[e].data.kicked}function vn(e,t){return fn(e,t)||Object(i.getTab)(t,e)&&Object(i.getTab)(t,e).block_error>0||Object(r.isLocksAvailable)(t)&&Object(r.isPeerBlocked)(e,t)}function On(e,t,a){var n=e.get().peer,i=Emoji.val(a);Object(r.isReservedPeer)(n)||Xa(e).dData.txt==i||vn(n,e)||(t.checkMessageURLs(i,!0,2e3),Xa(e).setText(i))}function yn(e){var t=Xa(e).getFwdRaw();t&&window.showForwardBox({act:"a_show_forward_box",will_fwd:t.id,gid:e.get().gid})}function jn(e,t){e.disabled=!0,e.contentEditable="false",addClass(e,"im-chat-input--text_disabled"),addClass(t,"im-chat-input_error"),addClass(geByClass1("_im_page_history"),"is_tf_blocked")}function Cn(e,t){e.disabled=!1,e.contentEditable="true",removeClass(e,"im-chat-input--text_disabled"),removeClass(t,"im-chat-input_error"),removeClass(geByClass1("_im_page_history"),"is_tf_blocked")}function wn(e,t,a){var n=gpeByClass("_im_chat_input_parent",a),s=geByClass1("_im_chat_input_error",n),o=Object(i.getTab)(e,t);if(vn(t,e)){jn(a,n);var l=function(e,t,a){switch(a.block_error){case 7:case 5:return Object(fa.getLang)("mail_peer_deleted");case 14:return Object(fa.getLang)("mail_community_deleted");case 11:return Object(fa.getLang)("mail_group_banned_messages");case 28:return Object(fa.getLang)("mail_cant_send_messages_by_time");case 29:return Object(fa.getLang)("mail_cant_send_messages_by_web_bot");case 4:case 6:case 9:case 19:case 20:case 13:return Object(r.isCommunityPeer)(t)?Object(fa.getLang)("mail_send_privacy_community_error"):Object(fa.getLang)("mail_send_privacy_error");case 23:var n=Object(F.oCacheGet)(e,t);return langSex(n.sex,Object(fa.getLang)("mail_blacklist_user","raw")).replace("{user}",n.kick_name);case 12:return Object(fa.getLang)("mail_cant_send_messages_to_community");case 16:return Object(fa.getLang)("mail_chat_youre_kicked");case 26:return Object(fa.getLang)("mail_chats_is_disabled");case 0:if(fn(t,e))return Object(fa.getLang)("mail_chat_youre_kicked");var i=e.get().block_states[t].name;return Object(fa.getLang)("mail_community_answering").replace("{username}",i);default:return Object(fa.getLang)("mail_send_privacy_error")}}(e,t,o);if(Object(i.isChannelPeer)(o)&&addClass(geByClass1("_im_page_history"),"is_channel"),Object(r.isFvkcomgroup)(e,t)&&!e.get().gid){addClass(n,"is-f-vkcomgroup");var c=inArray(t,e.get().mutedPeers);l=Object(i.isChatActive)(o)?getTemplate("sImPeerMuteUnmute",{text:c?Object(fa.getLang)("mail_im_unmute"):Object(fa.getLang)("mail_im_mute"),type:c?"unmute":"mute"}):getTemplate("sImPeerReturnToChat",{text:Object(fa.getLang)("mail_return_to_vkcomgroup")})}else removeClass(n,"is-f-vkcomgroup");return val(s,l),!0}return o&&Object(r.tabIsMessageRequest)(o)&&!Object(r.tabIsRejectedMessageRequest)(o)?(jn(a,n),addClass(n,"is-message_request"),val(s,getTemplate("sImPeerAcceptOrRejectMessageRequest",{cls_accept:"_mr_button_accept",cls_reject:"_mr_button_reject"})),!0):(n.classList.contains("is-message_request")&&(Cn(a,n),removeClass(n,"is-message_request"),val(s,"")),a.disabled&&(removeClass(n,"is-f-vkcomgroup"),removeClass(geByClass1("_im_page_history"),"is_channel"),Cn(a,n),removeClass(n,"is-message_request"),val(s,"")),!1)}function En(e,t,a){return Promise.resolve().then(()=>{var n=null!=a?a:Emoji.val(geByClass1("_im_text",t));if(trim(n))return!Object(i.isAnyMessageBeingEdited)(e)||!Object(r.isMessageTooLong)(n);var s=Xa(e),o=Object(r.getNowEditingMessage)(e);return s.hasAttaches()&&!s.hasOnlyReplies(o)})}function Tn(e,t,a){var n=geByClass1("_im_send",t.parentNode);Ha(n,{fasthide:!0}),Promise.all([En(e,t,a),Object(r.isVoiceMessageAvailable)(e)]).then(t=>{var a=Ra(t,2),r=a[0],s=a[1];if(Object(i.isAnyMessageBeingEdited)(e))toggleClass(n,"is_input_empty",!r),attr(n,"aria-label",Object(fa.getLang)("mail_im_edit"));else{toggleClass(n,"im-send-btn_audio",!r&&s),toggleClass(n,"im-send-btn_send",r),r&&removeClass(n,"im-send-btn_saudio");var o=r?Object(fa.getLang)("mail_send2"):Object(fa.getLang)("mail_added_audiomsg");attr(n,"aria-label",o)}})}function Sn(e){var t=geByClass1("MassMentionWarning",e);t.classList.contains("MassMentionWarning--hidden")||t.classList.add("MassMentionWarning--hidden")}function In(e,t,a){var n=Object(H.getCurrentTab)(e);if(n){if(!Object(r.isChatPeer)(n.peerId)||Object(i.isChannelPeer)(n))return Sn(t);var s=(a.match(at.MASS_MENTION_REGEXP)||[]).map(e=>e.slice(1));if(0===s.length)return Sn(t),void e.set(e=>(n.dontReopenWarningForCurrentMassMention=!1,Promise.resolve(e)));var o=geByClass1("MassMentionWarning",t),l=geByClass1("MassMentionWarning__title",o),c=geByClass1("MassMentionWarning__text",o),d=(e,t)=>{n.dontReopenWarningForCurrentMassMention||(l.innerHTML!==e&&(l.innerHTML=e),c.innerHTML!==t&&(c.innerHTML=t),o.classList.remove("MassMentionWarning--hidden"))},u=at.MASS_MENTION_ALIASES.all.some(e=>s.includes(e)),g=at.MASS_MENTION_ALIASES.online.some(e=>s.includes(e));switch(!0){case u&&n.membersCount>=11:return d(Object(fa.getLang)("mail_im_mass_mention_warning_title"),Object(fa.getLang)("mail_im_mass_mention_warning_many_people_mentioned_text",n.membersCount-1));case g&&n.membersCount>=30:return d(Object(fa.getLang)("mail_im_mass_mention_warning_title"),Object(fa.getLang)("mail_im_mass_mention_warning_maybe_many_people_mentioned_text"));default:return Sn(t)}}}function kn(e,t,a,s,o){cur.share_timehash=t.get().share_timehash;var l=Object(c.createMutations)(hn),u=l.callMutations,g=l.bindMutations,m=Da(0,t,u),p=en.bind(null,t);ls.remove("im_send_queue_2"+vk.id),ls.remove("im_send_queue_1"+vk.id);var _=ba(p,tn.bind(null,t),{store:!0,key:"im_send_queue_"+vk.id,waitCommit:!0}),b=_.pushMessage,h=_.inspectQueue,f=_.resend,v=_.resendAll,O=_.resendPeer,y=_.setErrored,j=_.complete,C=qa.bind(null,t,o,b,u,e),w=qa.bind(null,t,o,b,u,e),E=yn.bind(null,t);hide(geByClass1("ms_items_more_helper",e));var T=t.get().mediaTypes||[["photo",Object(fa.getLang)("mail_added_photo")],["video",Object(fa.getLang)("profile_wall_video")],["audio",Object(fa.getLang)("profile_wall_audio")],["doc",Object(fa.getLang)("profile_wall_doc")],["map",Object(fa.getLang)("profile_wall_map")],["gift",Object(fa.getLang)("profile_wall_gift")]];(t.get().moneyTransferAvail||t.get().moneyRequestAvail)&&T.push(["money",Object(fa.getLang)("profile_wall_money")]);var S=new MediaSelector(geByClass1("_im_media_selector",e),"_im_media_preview",T,{from:"message",maxShown:0,vectorIcon:!0,ignoreMobile:!0,onAddMediaChange:function(a,r,i,s){return a&&u().toggleKeyboard(!0),function(e,t,a,r,i,s,o,l,c){if(!t.get().removingMedias){if("album"===i||"page"===i||"mail"===i||"reply"===i)return!1;if("share"===i&&!o.title)return!1;var d,u;s&&"string"==typeof i?(l&&Xa(t).addBindUrl(l,i,s),Xa(t).addAttach(i,s,o)):(Xa(t).syncWithSelector(c),"number"==typeof s&&c.chosenMedias[s]&&(d=c.chosenMedias[s],u=Xa(t),("string"==typeof d[0]&&"string"==typeof d[1]&&d[1]||"string"==typeof d[0]&&"group"===d[0])&&u.dData.cancelled.push(`${d[0]},${d[1]}`)));var g=e().updateScroll();if(e().scrollFix(t,t.get().peer,g),t.get().delayed_message&&!Object(n.isAnythingLoading)(t.get()))return a([]),!1;Tn(t,r)}}(o,t,I,e,a,r,i,s,S)},onMediaChange:function(){return function(e,t,a,n,r){if(!t.get().removingMedias){var i=r.getMedias().find(e=>"poll"===e[0]);i&&Xa(t).addAttach(i[0],i[1],r.pollData(!0,!0)),Tn(t,n)}}(0,t,0,e,S)},editable:1,onChangedSize:function(){var a,n,r=o().updateScroll();o().scrollFix(t,t.get().peer,r),a=e,n=ge("_im_media_preview").offsetHeight,toggleClass(a,"im-chat-input--overflowed",n>400)},sortable:1,teWidth:150,mail:1,teHeight:100,toId:t.get().gid?-t.get().gid:void 0,blockPersonal:t.get().gid?1:0,docParams:t.get().gid?{imhash:t.get().upload_doc_opts.opts.imhash,from:"from_gim"}:{}}),I=Ja.bind(null,t,o,b,e,u,S),k=nn.bind(null,t,e),M=geByClass1("_im_send",e),P=qa.bind(null,t,o,b,u,e),L=Mt(e,t,P,()=>{addClass(M,"im-send-btn_audio"),removeClass(M,"im-send-btn_static")},()=>{u().restoreKeyboard()});!function(e,t){var a=geByClass1("_im_text",e),n=Object(ra.promisify)(stManager.add);(window.Wall?Promise.resolve():n(["page.js"])).then((function(){Wall.initComposer(a,{lang:{introText:Object(fa.getLang)("profile_mention_start_typing"),noResult:Object(fa.getLang)("profile_mention_not_found")},toup:!0,getValue:()=>t.get().peer>2e9?(window.Emoji&&Emoji.editableVal||val)(a):"",onShow:()=>{addClass(e,"im_mention_shown");var t=data(a,"composer");if(t&&t.wdd&&t.wdd.shown){var n=0,r=!1,i=function(){t.ignoredTerm=t.curTerm,t.curTerm=!1,val(t.wddInput,""),Composer.toggleSelectList(t)};each(t.wdd.shown,(function(){this[0]&&(n++,"@"+t.curTerm==this[2]&&(r=!0))})),!n||r&&1==n?i():cancelStackPush("im_mention",i)}},onHide:()=>{removeClass(e,"im_mention_shown"),cancelStackFilter("im_mention")},searchKeys:[1,7,9],wddOpts:{}})}))}(e,t),t.get().textMediaSelector=S,t.set(n.initTextStore.bind(null,h,f,y,j));var A=geByClass1("_im_text",e);setTimeout(()=>{Object(nt.getPeer)(t)&&u().setDraft(t,Object(i.getTabDraft)(Object(H.getCurrentTab)(t))),an(t,e,S,I,C,w,m,o,u)},0);var D=ln.bind(null,t,e,o),B=cn.bind(null,t,A,()=>{var e=o().updateScroll();o().scrollFix(t,Object(nt.getPeer)(t),e)}),x=dn.bind(null,t,a,s),N=gn.bind(null,t,e,o),R=mn.bind(null,t,e,o),F=Wa.bind(null,t);wn(t,t.get().peer,A);var G=e.querySelector("._im_keyboard_button"),q=function(e,t,a,n,r){return(0,Object(c.createMutations)(Yt).bindMutations)(Object(c.createModule)({handlers:(e,t)=>{}}),t,n)}(0,t,0,Qa.bind(null,t,o,b,e,u)),K=Object(r.isCommunityInterface)(t)?function(e,t,a,n){var r=(0,Object(c.createMutations)(na).bindMutations)(Object(c.createModule)({handlers:function(){}}),e,t,a,n);if("function"!=typeof r){r.toggleImText();var i=Pt.createElement(xt.default,{value:e},Pt.createElement(Qt,{getTemplates:r.getPreparedTemplates,applyTemplate:r.applyTemplate.bind(r),isNeededRendering:r.isNeedRenderTemplates,showSettingsPopup:r.showSettingsPopup.bind(r,ea),showCreatingTemplatePopup:r.showSettingsPopup.bind(r,ta)}));At.render(i,t)}return r}(t,e.querySelector("._message_templates_container"),e=>Object(Na.setHTML)(A,e),t=>toggleClass(e,"im-chat-input--textarea_show-templates",t)):null,V=Object(c.createModule)({handlers:(a,s)=>{a(M,"click",()=>{Sn(e),Promise.resolve().then(()=>En(t,e)).then(e=>{e||Object(i.isAnyMessageBeingEdited)(t)?I([]):Object(r.isVoiceMessageAvailable)(t).then(e=>{if(e){var a=Xa(t);Ka(a)&&function(e){var t=document.querySelector("._im_chat_audio_input_parent ._im_replied_content"),a=e.getFwdRaw();if(a){var n=a.object;t&&(t.innerHTML=on(n))}else t.innerHTML=""}(a),Ha(M,{fasthide:!0}),L.start(),setTimeout(()=>removeClass(M,"im-send-btn_saudio"),300)}})})}),a(M,"mouseover",k),a(A,"focus",()=>{t.get().longpoll.push([Object(d.transitionEvent)("message")]),cur.focused=t.get().peer}),a(A,"blur",()=>{var e=0===t.get().peer?"search":"default";t.get().longpoll.push([Object(d.transitionEvent)(e)]),cur.focused=!1}),a(G,"click",()=>u().toggleKeyboard(void 0)),a(G,"mouseover",()=>{Object(U.showTooltip)(G,{text(){var e=Object(i.getCurrentKeyboard)(t);return!e||e.hide?Object(fa.getLang)("mail_show_keyboard"):Object(fa.getLang)("mail_hide_keyboard")},black:!0,shift:[4,5]})}),a(geByClass1("MassMentionWarning__close"),"click",()=>{!function(e,t){Sn(t),e.set(e=>(Object(H.getCurrentTab)(e).dontReopenWarningForCurrentMassMention=!0,Promise.resolve(e)))}(t,e),rn(A)}),s(e.parentNode,"click","_im_peer_mute_unmute",N),s(e.parentNode,"click","_im_peer_return_to_chat",R),s(e.parentNode,"click","_im_remove_replied",D),s(e.parentNode,"click","_mr_button_accept",B),s(e.parentNode,"click","_mr_button_reject",x),s(e,"click","_im_fwd_close",D),s(e,"click","_im_will_fwd",E),s(e,"keydown","_im_text",e=>function(e,t,a,r){if(38===r.which&&a().isEmpty(e)&&!t().getEditingMessage()&&!Emoji.shown&&!Object(va.hasAccessibilityMode)()&&!Object(n.isAnythingLoading)(e.get())){var s=Object(Ba.findLastMessageToEdit)(e,Object(H.getCurrentTab)(e));s&&t().startEditing(Object(i.getMessage)(e,e.get().peer,s))}}(t,o,u,e)),s(bodyNode,"click","_im_submit_btn",F)}}),W=g(t,S,A,e,I,o,h,m,V,L,G,q,K,b,v,O);return W.initKeyboard(),W}function Mn(e,t,a,n,r,i){return{focus(e){uiSearch.focus(t),function(e,t,a,n){cancelStackPush("im_hist_search",Bn.bind(null,e,t,a,n))}(e,t,a,n)},changePeer(e,a){uiSearch.getFieldEl(t).value=a.get().tabs[e].searchText||""},search(){i({})},unmount(){Object(c.destroyModule)(r),cancelStackFilter("im_hist_search"),n.then(e=>e.destroy())}}}function Pn(e,t,a,r){e.set(n.setCurrentSearchDate.bind(null,e.get().peer,`${r.d}.${r.m}.${r.y}`)).then(An.bind(null,e,t,a))}function Ln(e,t){e.then(e=>{triggerEvent(geByClass1("datepicker_control",t),"mousedown",!1,!0)})}function An(e,t,a){var r=e.get().peer;uiSearch.showProgress(a),Object(n.searchMessagesInplace)(r,e.get()).then(n=>{uiSearch.hideProgress(a),t().insertSearch(n,e)}).catch(()=>{uiSearch.focus(a),uiSearch.hideProgress(a)})}function Dn(e,t,a,r,i,s){if("keyup"!==s.type||13==s.which){var o=clean(uiSearch.getFieldEl(t).value);e.set(n.setCurrentSearch.bind(null,o,e.get().peer)).then(i.bind(null,e,r,t))}}function Bn(e,t,a,r){cancelStackFilter("im_hist_search"),r.then(e=>{e.hide()}),e.set(n.cancelSearch.bind(null,e.get().peer)).then(()=>{uiSearch.getFieldEl(t).value="",a().cancelSearch(e)})}function xn(e,t,a,r){a.then(e=>{e.hide()}),e.set(n.clearDate.bind(null,e.get().peer)).then(An.bind(null,e,t,r))}function Nn(e,t,a){var n=geByClass1("_im_search_date_input",e),r=geByClass1("_im_search_history_input",e),i=function(e,t,a,n){var r='<td class="cal_clear" colspan="7"><button type="button" class="im_cal_clear_lnk _im_clear_date">'+getLang("wall_clear_date_filter")+"</button></td>";return new Promise(e=>{stManager.add(["ui_controls.js",window.jsc("web/datepicker.js"),"datepicker.css"],(function(){var t=new Datepicker(a,{width:140,resfmt:"plain",addRows:'<tr id="im_day_clear">'+r+"</tr>",addRowsM:'<tr id="im_month_clear">'+r+"</tr>",onUpdate:n,pastActive:!0,noFuture:!0});e(t)}))})}(0,0,n,Pn.bind(null,t,a,r)),s=Ln.bind(null,i,e),o=Dn.bind(null,t,r,n,a,Object(Oa.debounce)(An,300)),l=Bn.bind(null,t,r,a,i),d=xn.bind(null,t,a,i,r),u=Object(c.createModule)({handlers:(t,a)=>{t(geByClass1("_im_search_date",e),"click",s),t(uiSearch.getFieldEl(r),"keyup",o),t(geByClass1("_im_start_inplace_search",e),"click",o),t(geByClass1("_im_cancel_inplace_search",e),"click",l),a(e,"click","_im_clear_date",d)}});return Mn(0,r,a,i,u,o)}var Rn=a("t7TG");function Fn(e,t,a,n,i){var s=Object(r.getHistoryTopIndent)(e);Object(U.showTooltip)(t,{shift:[a,10],black:1,className:"_im_history_tooltip "+n,appendParentCls:"_im_mess_stack",toup:t.getBoundingClientRect().top>s+37,text:i})}function Hn(e,t,a){var r=gpeByClass("_im_mess",a),o=intval(domData(r,"msgid")),l=e.get().peer,c=Object(i.getMessage)(e,l,o),d=!Object(s.isImportant)(c);return e.get().longpoll.push([{peerId:l,messageId:o,type:d?N.SET_FLAGS:N.RESET_FLAGS,flags:N.FLAG_IMPORTANT}]),e.set(n.favMessage.bind(null,[o],d,l)),Un(e,-10,t,a,!0),!1}function Un(e,t,a,n,r){var o=domData(gpeByClass("_im_mess",n),"msgid"),l=Object(i.getMessage)(e,e.get().peer,o),c=getLang("mail_im_unmark_important"),d=getLang("mail_im_toggle_important"),u=Object(s.isImportant)(l)?c:d,g=u.length>16;r&&window.tooltips&&tooltips.destroy(n),Fn(e,n,g?84:34,g?"im-star-tt_long":"im-star-tt",l?u:"")}function Gn(e,t,a,i){var s=e.get().peer,o=+domData(domClosest("im-mess",i.target),"msgid");if(Object(r.canForwardMessages)(e,[o]))return Object(tt.statlogsForwardFromChannel)(),Object(n.processFwd)([o],s,e).then(t=>e.set(n.prepareForward.bind(null,t))).then(()=>{Object(Rn.mount)(a,e)}),!1}function qn(e,t,a){var r=e.get().peer,i=+domData(domClosest("im-mess",a.target),"msgid");return Object(n.processFwd)([i],r,e).then(t=>e.set(n.forwardMessages.bind(null,t,e.get().tfdraft,!0))).then(()=>t().respond(e,r)),!1}function Kn(e,t,a,n){Fn(e,n,18,"im-reply-tt",getLang("mail_im_mark_forward"))}function Vn(e,t,a,n){Fn(e,n,18,"im-reply-tt",getLang("mail_im_reply"))}function Wn(e,t,a,n){var r=intval(domData(gpeByClass("_im_mess",n),"msgid")),s=Object(i.getMessage)(e,e.get().peer,r);return s&&t().startEditing(s),!1}function zn(e,t,a){Fn(e,a,18,"im-edit-tt",getLang("mail_im_edit"))}function Yn(e,t,a){var n=Un.bind(null,t,0),i=Hn.bind(null,t),s=Kn.bind(null,t,0),o=Gn.bind(null,t,e.querySelector("_im_dialog_actions"),a),l=Vn.bind(null,t,0),d=qn.bind(null,t,a),u=zn.bind(null,t),g=Wn.bind(null,t,a),m=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess_fav",i),a(e,"mouseover","_im_mess_fav",n),a(e,"click","_im_mess_forward",o),a(e,"mouseover","_im_mess_forward",s),a(e,"click","_im_mess_reply",d),a(e,"mouseover","_im_mess_reply",l),a(e,"click","_im_mess_edit",g),a(e,"mouseover","_im_mess_edit",u)}});return function(e,t){return{markImportant(t,a,n){Object(r.updateStar)(t,a,e)},unmount(){Object(c.destroyModule)(t)}}}(e,m)}function $n(e,t,a,s,o){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())&&!(hasClass(o,r.FAILED_CLASS)||hasClass(o,r.SENDING_CLASS)||hasClass(o,"_im_mess_srv")||Object(r.checkSelectClick)(s,o)||Object(i.isAnyMessageBeingEdited)(e)||"A"===s.target.tagName||domClosest("_im_replied_message",s.target)||s.target.classList.contains("_im_retry_media")||s.target.closest("."+r.MESSAGE_KEYBOARD_BUTTON_CLASS))){var l,c,d=intval(domData(o,"msgid")),u=e.get().peer;if(!Object(r.isAlreadyDeleted)(e,u,d))l=s.shiftKey?Object(i.getMessageRangeFromSelection)(e,u,d):[d],e.set(n.addSelection.bind(null,l)).then(()=>{var n=Object(i.getSelectedMessages)(e),r=!1;l.forEach(e=>{var t=geByClass1("_im_mess_"+e,a);if(t){var i=inArray(e,n);r|=i,toggleClass(t,"im-mess_selected",i);var s=i?getLang("mail_deselect_message"):getLang("mail_select_message"),o=geByClass1("_im_mess_blind_label_select",t);attr(o,"aria-label",s)}}),r&&(window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()),t().changedMessageSelection(e)}).then(()=>{1!==e.get().selectedMessages.length||c?c&&c.hide():c=function(e){var t=e.get();if(t.pinnedMessagesPromo&&Object(r.isChatPeer)(t.peer)){var a=geByClass1("_mess-action-promo"),i=new ElementTooltip(a,{autoShow:!1,appendTo:a,content:getTemplate("im_pinned_messages_promo",{content:getLang("mail_pinned_messages_promo_tooltip")}),forceSide:"bottom",cls:"feature_intro_tt",width:260,onHide:function(){e.setState({pinnedMessagesPromo:!1}),Object(n.hidePromoTooltip)()}});return i.show(),i}}(e)})}}function Xn(e,t,a){var n=$n.bind(null,t,a,e),r=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess",n)}});return function(e,t){return{cleanSelection(t){t&&Array.isArray(t)&&t.length&&t.map(t=>geByClass1("_im_mess_"+t,e)).filter(e=>e).forEach(e=>removeClass(e,"im-mess_selected"))},unmount(){Object(c.destroyModule)(t)}}}(e,r)}function Qn(e,t,a){var n=a.get(),r=n.observer,o=n.targets;o.length&&o.forEach(r.unobserve.bind(r));var l=function(e,t){var a=Object(nt.getPeer)(e);if(!Object(i.isFullyLoadedTab)(e,a))return[];var n=Object(i.getTab)(e,a);return Object.keys(n.msgs).reduce((e,a)=>{var r=n.msgs[a],o=t||document;if(Object(s.isUnread)(n,Object(i.parserMessage)(r))){var l=o.querySelector("._im_mess_"+a);l&&e.push(l)}return e},[])}(e,t);a.setState({targets:l}),l.length&&l.forEach(r.observe.bind(r))}var Jn=a("Syd7"),Zn=a("Wu9C");var er={onNewMessagesChunk:function(e){var t=geByClass("post");LongView.clearElemsCache&&LongView.clearElemsCache(),t.forEach(e=>LongView.register(e,"im"))},onHistoryScroll:function(e){LongView.onScroll(e,window.innerHeight)}};function tr(){return(tr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function ar(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return nr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return nr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function rr(e,t,a,n){var r=e instanceof Array?e:geByClass("_im_bar_date",e),i=t.contHeight();er.onNewMessagesChunk();var s=r.reduce((e,t)=>(e[domData(t,"date")]=[t.offsetTop+10,i,t],e),{}),o=!a&&n.barMap?n.barMap:{};return n.barMap=extend(o,s),n.barMapKeys=Object.keys(n.barMap).sort(),Promise.resolve(n)}function ir(e,t){return t.barMapKeys.forEach(a=>{t.barMap[a][0]-=e}),Promise.resolve(t)}function sr(e,t,a,n,i){var s=e.get().barMap[t],o=Object(r.isClassicInterface)(i)?68:20;return a-(s[0]+a-s[1])+n-o}function or(e,t,a,n){return n.barTransition=n.barMap[t][2],a>0?(addClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),addClass(e,"im-page--date-bar-transition-inverse")):a<0&&(removeClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),removeClass(e,"im-page--date-bar-transition-inverse")),addClass(n.barMap[t][2],"im-page--date-bar-transition"),addClass(e,"im-page--date-bar-transition"),Promise.resolve(n)}function lr(e,t){return t.barTransition&&(removeClass(t.barTransition,"im-page--date-bar-transition"),t.barTransition=null),removeClass(e,"im-page--date-bar-transition"),Promise.resolve(t)}function cr(e,t,a,n,r){var i,s,o=e.get(),l=a-t;o.barMapKeys.forEach(t=>{var o=sr(e,t,a,n,r);if(o>=l){var c=i?sr(e,i,a,n,r):a;i=c>o?t:i}else if(o<l){var d=s?sr(e,s,a,n,r):0;s=o>d?t:s}});var c={};return[[s,"prev"],[i,"cur"]].forEach(t=>{var i=ar(t,2),s=i[0],o=i[1];s&&(c[o+"Bar"]=function(e,t){var a=e.get().barMap[t][2];return{text:a.textContent,date:domData(a,"date")}}(e,s),c[o+"Left"]=sr(e,s,a,n,r)-l)}),c}function dr(e,t,a,i,s){var o=e.get(),l=Object(n.isEverythingLoaded)(o),c=t.get(),d=s.scrollTop(),u=c.lastTop?c.lastTop-d:0;c.lastTop=d;var g=Object(Zn.isPinnedMessageVisibleInTab)(o,o.peer)?Object(r.getPinnedMessageHeight)(e):0,m=Object(n.isSearchingInplace)(o.peer,o)&&o.tabs[o.peer]&&o.tabs[o.peer].top_banner?50:0,p=(Object(r.isClassicInterface)(e)?68+g+m:0)-16,_=cr(t,d,s.contHeight(),p,e),b=_.prevBar,h=_.curBar,f=_.prevLeft,v="translateY(0px)",O=!1,y=!1,j=!1;h||l||(h=function(e){var t=geByClass1("_im_mess",e),a=domData(t,"ts");return t&&a?{text:getShortDate(intval(a),!1,!0,getLang("months_of","raw")),date:a}:null}(i)),h?O=h:y=!0,b&&h&&f>-32&&f<0&&(j=!0,y=!1,O=h,v=`translateY(${-32-f}px)`),O&&function(e,t){domData(e,"ts")!==t.date&&(e.innerHTML=t.text,domData(e,"ts",t.date),e.style.visibility="visible")}(a,O),j?t.set(or.bind(null,a,b.date,u)):t.set(lr.bind(null,a)),v&&(a.style.transform=v),toggleClass(a,"im-page--top-date-bar_no-b",y)}function ur(e,t){var a=geByClass1("_im_top_date_bar",t),n={lastTop:!1,barMap:{},barMapKeys:[],isDisabled:!1},r=Object(b.default)(n),i=null,s=null,o=null,l=Object(Oa.debounce)(e=>{var a=r.get();Object.keys(a).length&&!a.isDisabled&&r.set(rr.bind(null,t,e,!1))},500);return{reset(n){r.get().isDisabled||r.set(rr.bind(null,t,n,!0)).then(dr(e,r,a,t,n))},disable(){r.setState(tr({},n,{isDisabled:!0}))},enable(){r.setState({isDisabled:!1})},heightIncreased(e,t){r.get().isDisabled||(l(t),r.set(ir.bind(null,e)))},parseMore(n,i){r.get().isDisabled||r.set(rr.bind(null,n,i,!1)).then(()=>{dr(e,r,a,t,i)})},toggle(e){r.get().isDisabled&&e||a.classList.toggle("im-page--top-date-bar--hidden",!e)},show(){r.get().isDisabled||(s=Date.now(),o||(addClass(t,"im-page--top-date-bar_visible"),o=setInterval((function(){Date.now()-s>2e3&&(removeClass(t,"im-page--top-date-bar_visible"),clearInterval(o),o=null)}),100)))},update(n){r.get().isDisabled||(i&&(clearTimeout(i),i=null),i=setTimeout((function(){dr(e,r,a,t,n)}),300),dr(e,r,a,t,n))},unmount(){i&&(clearTimeout(i),i=null),o&&(clearInterval(o),o=null),r.unmount()}}}var gr=a("bIHZ"),mr=a("uytb"),pr=a("S2bU"),_r=a("t7n3"),br=a("zxIV");function hr(){return(hr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function fr(e){return!e.children.length}function vr(e,t){var a=geByClass1("_im_dialog_actions",e);Object(br.toggleClass)(a,"im-page--chat-header_top-banner",t)}function Or(e,t){var a=geByClass1("_im_top_banner_hide",e);a&&window.tooltips&&tooltips.hide(a),vr(e,!1),t.innerHTML=""}function yr(e,t,a){var n=t.participants,i=n.count>0?langNumeric(n.count,getLang("mail_im_n_chat_members","raw")):"";return Object(_r.getTemplate)("sImCallBannerContent",{user_list:Object(r.renderCallUserList)(e,n.list),title:getLang("calls_group_call_banner_title"),desc:i,cls:a?"CallBanner--classic":""})}function jr(e){var t=e.peerId;if(Object(r.isChatPeer)(e.peerId)&&!Object(i.isChatActive)(e))return!1;var a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners");return n?!(!a||n[t]&&n[t]===a.join_link):!!a}function Cr(e,t,a){var s=geByClass1("_im_top_banner",e),o=Object(c.createModule)({handlers:(o,l)=>{var c=geByClass1("_im_dialog_actions",e);l(e,"click","_im_top_banner_hide",()=>{var o=t.get().peer,l=Object(i.getTab)(t,o);jr(l)?function(e){var t=e.peerId,a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners")||{};cur.imDb.updateByKey("hiddenCallBanners",hr({},n,{[t]:a.join_link}))}(l):t.set(e=>Object(n.hideTopBannerAction)(o,e)),Or(e,s);var c=!!Object(r.renderPinnedMessage)(t);Object(r.compensateHistoryHeightChange)(t,c,!0,a)}),l(e,"click","_im_top_banner_button",i=>{var o=function(e,t,a,i){var s=e.target,o=t.get().peer;if(s.classList.contains("_im_call_banner_join_btn")){var l=s.dataset.link;return Object(r.joinCallFromIm)(t,o,l,!1,r.CALL_ENTRY_POINT_JOIN_BANNER),!1}var c=s.dataset.payload;return c?(t.set(e=>Object(n.callbackTopBannerAction)(o,c,e)),Or(a,i),!0):(s.classList.contains("_im_top_banner_button_gifts")&&(showBox("al_gifts.php",{act:"get_gift_box",mid:o,ref:"im_birthday_banner"},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(R.statlogsValueEvent)("gifts_im_birthday_banner","click",o),e.originalEvent.preventDefault()),!1)}(i,t,e,s),l=!o,c=!!Object(r.renderPinnedMessage)(t)||!o;Object(r.compensateHistoryHeightChange)(t,c,l,a)}),l(c,"mouseover","_im_top_banner_hide",(e,t)=>{Object(U.showTooltip)(t,{text:getLang("mail_top_banner_hide"),black:1,shift:[8,4],appendEl:bodyNode})})}});return{renderPeer(t){var n=Object(i.getTab)(t,t.get().peer),o=n.top_banner,l=n.callInProgress,c=!fr(s),d=jr(n);!d&&!o||Object(i.isSearchShown)(t)?c&&Or(e,s):(vr(e,!0),s.innerHTML=d?function(e,t){return Object(_r.getTemplate)("im_top_banner",{text:yr(e,t,Object(i.isClassicInterface)(e)),icon:"",buttons:[Object(_r.getTemplate)("sImCallBannerButton",{call_link:t.join_link}),Object(_r.getTemplate)("im_top_banner_hide_btn",{})].join(""),classes:"im-top-banner_call"})}(t,l):function(e){var t=e.icon?Object(_r.getTemplate)("im_top_banner_icon",{icon:e.icon}):"",a=e.text;"employees_banner"===e.name&&(a=Object(pr.replaceHyperLinks)(a,e=>Object(pr.linksReplacer)(!1,e)),a=Object(pr.replaceMentions)(a));var n=(e.buttons||[]).map(e=>{var t="";switch(e.layout){case"tertiary":t="im-top-banner--button-tertiary";break;case"secondary":t="secondary";break;default:t="blue_button"}switch(e.type){case"link":return Object(_r.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});case"gifts_link":return t+=" _im_top_banner_button_gifts",Object(_r.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});default:return Object(_r.getTemplate)("im_top_banner_button",{callback_data:e.callback_data,text:e.text,css_class:t})}});return n=n.concat([Object(_r.getTemplate)("im_top_banner_hide_btn",{})]),Object(_r.getTemplate)("im_top_banner",{text:a,icon:t,buttons:n.join("")})}(o),o&&"birthday"===o.name&&Object(R.statlogsValueEvent)("gifts_im_birthday_banner","view",t.get().peer));var u=!fr(s);Object(r.compensateHistoryHeightChange)(t,u,c,a)},unmount(){Object(c.destroyModule)(o)}}}var wr=a("cGUQ"),Er=a("W9Tc");function Tr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Sr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Sr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Sr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Ir="im-audio-message_recorded",kr=!1,Mr={};function Pr(e){return e.get().isMassMentionsMessageAllowed}function Lr(e){var t=Object(i.getTab)(e,e.get().peer);return!!Object(i.getPinnedMessage)(e)||!(!t||!t.top_banner)}function Ar(e,t){var a=Object(l.unpackStore)(e),n=Object(i.getTab)(a,t);return Object(r.isChatPeer)(t)&&Object(Zn.isPinnedMessageVisibleInTab)(a,t)||!!n.top_banner&&!Object(i.isSearchShown)(t,a)}function Dr(e){return Object(r.getPinnedMessageHeight)(e)}function Br(e,t,a){var n=a||window.clientHeight();return Math.min(n-15,Math.max(0,e,742+t.offsetTop))}function xr(e,t){var a=intval(domData(t.target,"msgid")),n=gpeByClass("_im_mess_"+a,t.target),r=geByClass1("_im_log_body",n),i=geByClass1("_im_mess_susp_cont",n);r.innerHTML=i.innerHTML}function Nr(e,t){return geByClass1("_im_mess_"+t,e)}function Rr(e,t,a){var n,i,s,o,l,c,d,u,g,m=geByClass1(e,t);o={onStartDrag:(e,t)=>{addClass(bodyNode,"cursor_ns_resize"),n=t,i=t},onDrop:()=>{removeClass(bodyNode,"cursor_ns_resize")},onDrag:(e,s)=>{var o=Br(i-n+s,t);Object(r.setClassicChatHeight)(o),a().fixHeight()}},d=function(e){l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onDrag&&o.onDrag.call(s,l,c)},u=function e(t){o.onDrop&&o.onDrop.call(s,l,c),removeEvent(document,"mouseup touchend mouseleave",e),removeEvent(document,"mousemove touchmove",d)},g=function(e){(1===e.which||e.touches&&e.touches[0])&&(addEvent(document,"mouseup touchend mouseleave",u),addEvent(document,"mousemove touchmove",d),l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onStartDrag&&o.onStartDrag.call(s,l,c),o.onDrag&&o.onDrag.call(s,l,c),cancelEvent(e))},(s=m).beginDragHandler=g,addEvent(s,"mousedown touchstart",g)}function Fr(e,t){var a;a=geByClass1(e,t),removeEvent(a,"mousedown touchstart",a.beginDragHandler)}function Hr(e){e().hideError()}function Ur(e,t,a,r,i){if(checkEvent(r))return!0;var s=Object(wr.fromQueryString)(i.getAttribute("href")),o=intval(s.msgid);o&&e.set(n.changePeer.bind(null,e.get().peer,o,!1)).then(()=>ei(a,t,o,e)),cancelEvent(r)}function Gr(e,t,a){var r=Object(i.getTab)(t,a),s=Object(n.strHistory)(r.history);toggleClass(e,"im-page--history_empty-hist",!s)}function qr(e,t,a,n){if(hasClass(a.target,"_im_mess_marker")){var i=a.target,s=Object(l.toArray)(geByClass(r.FAILED_CLASS,t));window.tooltips&&s.map(e=>geByClass1("_im_mess_marker",e)).filter(e=>e!==i).forEach(e=>tooltips.hide(e,{fasthide:!0}));var o=domData(n,"msgid");Object(U.showTooltip)(i,{content:getTemplate("im_failed_menu",{count:s.length,modifiers:Object(Nt.classNames)("im-settings_failed",{"im-settings_no_delete":o>0,"im-settings_single":1===s.length}),id:o}),className:"im-page--failed-tt",appendParentCls:"_chat_body_wrap",dir:"down",noZIndex:!0,shift:[12,8],hasover:!0,force:!0})}}function Kr(e){return geByClass1("_im_peer_history",e)}function Vr(e,t){var a=t.contHeight(),n=e.scrollTop+(a-e.contHeight);t.scrollTop(n)}function Wr(e,t,a,s,o,l,c,d,u){var g=!(arguments.length>9&&void 0!==arguments[9])||arguments[9],m=arguments.length>10&&void 0!==arguments[10]&&arguments[10],p=(t.get().tabs||{})[a];o().hideError(),l.renderPeer(t),d.renderPeer(t),u.render(t);var _=Object(i.isCasperChat)(t,a);if(toggleClass(e,"im-page--history_casper",_),!t.get().tabHistoryNotChanged){l.reRenderTitle(t),Gr(e,t,a);var b=Object(n.strHistory)(p.history);if(b){var h=geByClass1("_im_peer_history",e);val(h,b)}else o().showEmptyScreen();getAudioPlayer().isPlaying()&&getAudioPlayer().updateCurrentPlaying(),bi(t,s,e)}if(Object(n.isSearchingInplace)(a,t.get())?o().showSearch(t):o().cancelSearch(t,!1),c.changePeer(a,t),t.get().msgid)ei(s,e,t.get().msgid,t);else if(p.scrollBottom&&g){Vr(p,s);var f=Object(r.isMessagesVisible)(t,e,s),v=Tr(f,1),O=v[0];p.skipped||setTimeout(()=>{p.unread&&!O&&(ni(t,e,!0),ri(t,e,!0)),$r(t,s,e),Xr(t,s,e)},100)}else Zr(s,e,o,t,m)||s.scrollBottom(-30);window.LazyLoad&&window.LazyLoad.scan(!!s.scroll&&s.scroll.scroller)}function zr(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=a||t.scrollTop(),i=t.scrollBottom(),s=t.contHeight(),o=e.get().peer;e.set(n.saveHistoryScroll.bind(null,o,r,i,s))}function Yr(){return it.screenfull.isFullscreen}function $r(e,t,a){var n=Object(i.isGoToMentionVisible)(e),r=Object(i.isGoToEndVisible)(e),s=t.getScrollHeight()/4,o=t.scrollTop()>0;t.scrollBottom()>s&&(!r||n)&&o&&ni(e,a,!0,40)}function Xr(e,t,a){if(Pr(e)){var n=t.getScrollHeight()/4,r=t.scrollTop()>0,s=Object(i.isGoToMentionVisible)(e);t.scrollBottom()>n&&!s&&r&&ri(e,a,!0,40)}}function Qr(e,t,a,s,o,l,c,d){var u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if((e.get().history_init||(e.get().history_init=!0,!(d.scrollTop()>0)))&&!Yr()){o.update(d),o.show();var g=e.get().peer;if(0!==g&&Object(r.isFullyLoadedTab)(e.get(),g)&&(er.onHistoryScroll(d.scrollTop()),!layers.visible)){var m=Object(i.getTab)(e,g);m&&!m.skipped&&d.scrollBottom()>40?($r(e,d,l),Xr(e,d,l)):m.skipped||m.unread||(Oi(e,l),yi(e,l));var p=Object(r.wrapLoading)(a);if(!Object(n.isSearchingInplace)(g,e.get())&&u&&s(d),!kr&&(c<0||0===d.scrollBottom())&&d.scrollBottom()<1e3){if(Object(n.isSearchingInplace)(g,e.get()))return;if(m.skipped>0&&!e.get().no_moving_down){var _=gpeByClass("_im_page_history",l),b=e.get();kr=!0;var h=e.set(n.loadLessHistory).then(t().loadHistory.bind(null,b.peer,{reversed:!0})).then(()=>{t().updateObserver(),kr=!1,ni(e,_),ri(e,_),m.skipped||e.set(n.changePeer.bind(null,e.get().peer,!1,!1))});return mi(_,!0),void h.then(mi.bind(null,_,!1))}}if(!kr&&d.scrollTop()<1e3){if(Object(n.isSearchingInplace)(g,e.get())){kr=!0;var f=t().getSearchResulstModule();return f.isAll(e)?void(kr=!1):void p(f.loadMore(e).then(a=>{kr=!1,a&&(t().loadHistory(e.get().peer,{},e,a),s(d))}),"up")}var v=e.get();m.allShown||(kr=!0,p(e.set(n.loadMoreHistory.bind(null,0,0)).then(t().loadHistory.bind(null,v.peer,{})).then(()=>{kr=!1,s(d)}),"up"))}c<0&&Ii(e,g,d.scrollBottom(),l,t),Object(n.videoAutoPlayHandler)()}}}function Jr(e,t){return window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle?Promise.resolve():e.set(n.readTillSpecificMessage.bind(null,t,e.get().peer))}function Zr(e,t,a,i,s){var o=geByClass1("_im_unread_bar_row",t);if(o){var l=i.get(),c=l.peer,d=o.getBoundingClientRect(),u=geByClass1("_im_chat_body_abs",t).getBoundingClientRect().top+20;Object(r.isClassicInterface)(i)&&(u+=47+(Ar(l,c)?Dr(i):0));var g=e.scrollTop()-u+d.top;return e.scrollTop(g),zr(i,e,g),setTimeout(()=>{c===i.get().peer&&Qr(i,a,Kr(t),(function(){}),s,t,0,e)},80),Object(Er.partConfigEnabled)("mail_history_unread_counter_observer")?a().updateObserver():function(e){var t=e.get().peer;if(!(window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle)&&t)e.set(n.readLastMessages.bind(null,t))}(i),!0}return!1}function ei(e,t,a,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"top",s=Nr(t,a);if(s){var o=Object(r.isClassicInterface)(n),l=n.get().peer,c=o?window.clientHeight():geByClass1("_im_chat_body_abs",t).offsetHeight,d=s.offsetTop+domPN(s).offsetTop+domPN(domPN(s)).offsetTop+domPN(domPN(domPN(s))).offsetTop;o&&Ar(n,l)&&(d-=Dr(n)),"top"===i?e.scrollTop(d-e.getScrollHeight()/2+c/2):e.scrollTop(d-e.getScrollHeight()+c/4),addClass(s,"im-mess_light"),setTimeout(()=>{removeClass(s,"im-mess_light")},2e3)}}function ti(e,t,a){a.updateLastSeen(e)}function ai(e,t,a,r,i,s){var o=domData(s,"action"),l=domData(s,"msgid"),c=geByClass1("_im_mess_marker",Nr(a,l)),d=Number(l)>0?"edit":"send",u=e.get().peer,g=Kr(a);switch(o){case"resend":Object(tt.statlogsSendingRetry)("retry",d),t(i,s);break;case"resend_all":Object(tt.statlogsSendingRetry)("retry",d),r().resendPeer();break;case"delete":Object(tt.statlogsSendingRetry)("delete",d),e.set(t=>Object(n.removeFailed)(e,g,u,l,t));break;case"delete_all":Object(tt.statlogsSendingRetry)("delete",d),e.set(t=>Object(n.removeFailed)(e,g,u,void 0,t))}tooltips.hide(c,{fasthide:!0})}function ni(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=e.get(),o=s.peer;if(!Object(r.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_end"),d=!1;(a||l.skipped>0||l.unread>0)&&!Object(n.isSearchingInplace)(o,e.get())?(d=!0,ii(t,e),addClass(c,"im-navigation_shown")):vi(c,!0),e.set(n.updateGoToEndVisibility.bind(null,[d,+i]))}}function ri(e,t,a){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!Pr(e))return!1;var s=e.get(),o=s.peer;if(!Object(r.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_mention"),d=oi(e).length,u=!1;l.unread>0&&d>0&&!Object(n.isSearchingInplace)(o,e.get())?(u=!0,si(t,e,d),addClass(c,"im-navigation_shown")):vi(c,!0),e.set(n.updateGoToMentionVisibility.bind(null,[u,+i]))}}function ii(e,t){var a=t.get().peer,n=Object(i.getTab)(t,a);(e||document).querySelector("._im_to_end").querySelector("._im_to_end_label").innerHTML=Number(n.unread)>0?Object(_r.formatCount)(n.unread):""}function si(e,t,a){(e||document).querySelector("._im_to_mention").querySelector("._im_to_mention_label").innerHTML=a>0?Object(_r.formatCount)(a):""}function oi(e){var t=e.get(),a=t.id,n=t.peer,r=Object(i.getTab)(e,n);if(!n||!r)return[];var o=r.msgs||{};return Object.values(o).filter(e=>!(!e||Array.isArray(e)||Object(s.isOut)(e)||!Object(s.isUnread)(r,e))&&Object(G.hasUserMentions)(e,a))}function li(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e.scrollTop()&&0===e.scrollBottom())return!1;var a=e.scrollBottom();return a<(t?30+t:30)}function ci(e,t,a,n,r){var s=domData(r,"msgid"),o=e.get().peer,l=Object(i.getMessage)(e,o,s);l.type===N.EDIT_MESSAGE?(a().sendEditMessage(e,l),a().resendMessage(o,s)):e.get().imQueueResend(o,s).then(t=>{e.get().longpoll.push([Object(d.resendEvent)(o,t.mess)])})}function di(e,t,a,s,o,l){var c=intval(domData(l,"peer")),d=intval(domData(gpeByClass("_im_mess",l),"msgid")),u=Object(i.getTab)(e,c);return e.set(n.restoreMessage.bind(null,d,c)).then(r.restoreMessage.bind(null,d,c,Kr(t))).then(()=>bi(e,a,t)),Object(n.restoreMessageSend)(d,c,u.hash,e.get().gid).then(()=>{d>u.lastmsg&&Object(n.loadActualLastMessage)(e,c).then(()=>s().updateState(c,e))}),!1}function ui(e,t){e().showCreation(t)}function gi(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function mi(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function pi(e,t,a,o){var l=t.get().peer,c=Object(i.getTab)(t,l);if(Object(r.isFullyLoadedTab)(t,l)){var d=Object.keys(c.msgs).find(e=>{var t=c.msgs[e];return!Array.isArray(t)&&Object(s.isUnread)(c,t)});if(!c.skipped)return d?ei(o,a,d,t):o.scrollBottom(-30),ni(t,a),ri(t,a),Ii(t,l,0,a,e),void Object(n.readTillSpecificMessage)(c.lastmsg,l,t.get());gi(a,!0),t.set(n.changePeer.bind(null,l,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,l,!0,-1,!1))).then(()=>{gi(a,!1),e().changePeer(t,!1,!1)})}}function _i(e,t,a,r){var s=Object(i.getTab)(t,t.get().peer),o=oi(t),l=!!o.length&&o[0].messageId;if(!s.skipped)return l&&ei(r,a,l,t,"center"),ni(t,a,!0),ri(t,a),Jr(t,l),void Ii(t,t.get().peer,0,a,e);gi(a,!0),t.set(n.changePeer.bind(null,t.get().peer,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,t.get().peer,!0,-1,!1))).then(()=>{gi(a,!1),e().changePeer(t,!1,!1),Jr(t,l)})}function bi(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(Object(r.isClassicInterface)(e)){var i=t.contHeight(),s=geByClass1("_im_chat_input_w",a),o=geByClass1("_im_chat_resize",a);if(!1!==(n=!1!==n?n:Object(r.getClassicChatHeight)())&&n>0){var l=window.clientHeight(),c=geByClass1("_im_chat_audio_input_parent",a),d=Br(n,a,l),u=hasClass(c,"im-audio-message_recording")||hasClass(c,Ir),g=u?c:geByClass1("_im_chat_input_parent",a),m=d-g.offsetHeight;o.style.height=l-d-15+"px",setStyle(s,{top:m+"px",bottom:"auto"})}else o.style.height="0px",setStyle(s,{top:"auto",bottom:"0px"});var p=geByClass1("_im_peer_history_w",a);return setStyle(p,{borderBottomWidth:s.offsetHeight-15-1}),t.contHeight()-i}var _=t.getScrollHeight();t.update(!1,!0);var b=t.getScrollHeight();return _-b}function hi(e,t,a,n){var r=t.offsetHeight;n(),e.heightIncreased(t.offsetHeight-r,a)}function fi(e,t){var a=t.getBoundingClientRect().top;Object(U.showTooltip)(t,{className:"im-page--admin-tt",text:getLang("mail_only_admin_see"),appendParentCls:"_chat_body_wrap",shift:[20,5],dir:"auto",showdt:400,noZIndex:!0,toup:a>200})}function vi(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];hasClass(e,"im-navigation_shown")&&(t&&addClass(e,"im-navigation_fast"),removeClass(e,"im-navigation_shown"),t&&(e.offsetHeight,removeClass(e,"im-navigation_fast")))}function Oi(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.querySelector("._im_to_end");e.set(n.updateGoToEndVisibility.bind(null,[!1,0])),vi(r,a)}function yi(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.querySelector("._im_to_mention");e.set(n.updateGoToMentionVisibility.bind(null,[!1,0])),vi(r,a)}function ji(e,t,a){it.screenfull.isFullscreen||0===t.get().peer||Object(r.isClassicInterface)(t)||e().restoreScroll(t,t.get().peer)}function Ci(e,t){var a=e.get(),o=a.peer,l=domClosest("_im_mess_srv",t.target),c=intval(domData(l,"msgid")),d=Object(i.getMessage)(e,o,c),u=d&&Object(s.isServiceMsg)(d)&&d.kludges.source_act;if(u===r.CHAT_PIN_MESSAGE||u===r.CHAT_UNPIN_MESSAGE){var g=l.querySelector(".im_srv_mess_link");if(g&&"A"!==g.tagName){var m=d.kludges.source_chat_local_id;if(!m||Mr[m])return;Mr[m]=Object(n.getMessageLocalId)(o,m,a).then(e=>{var t=Tr(e,1)[0];if(t){var a=`/im?sel=${Object(r.convertPeerToUrl)(o)}&msgid=${t}`,n=g.innerHTML;domReplaceEl(g,Object(r.serviceLink)(a,n,!0,"im_srv_mess_link")),delete Mr[m]}})}}}function wi(e,t,a){var n=e.get(),s=n.peer,o=a.target.href&&a.target.href.match(/msgid=([\d]+)/),l=o&&o[1];"A"!==a.target.tagName||!l||Object(r.isAlreadyDeleted)(e,s,l)||checkEvent(a)||(Object(i.getMessage)(e,s,l)?(e.setState({msgid:l}),Object(gr.updateLocation)({msgid:l}),t().focusOnMessage()):n.longpoll.push([Object(d.changePeer)(s,l)]));cancelEvent(a)}function Ei(e){var t=Object(H.getCurrentTab)(e);Object(r.isChatPeer)(t.peerId)&&(t.pinHideId=cur.imDb.select(mr.PIN_HIDDEN_ID_OP,t.peerId))}function Ti(e,t,a,n,r){e.setState({isEditing:!1}),removeClass(n,"im-mess_is_editing"),removeClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackFilter("cancel_edit"),a.setDraft(e,Object(nt.getPeer)(e)?Object(i.getTabDraft)(Object(H.getCurrentTab)(e)):null),a.toggleStickers(e,!0),a.restoreKeyboard(),Si(t)}function Si(e){Object(l.toArray)(geByClass("_im_history_tooltip",e)).forEach(hide)}function Ii(e,t,a,r,s){var o=Object(i.getTab)(e,t);if(!(Date.now()-(o.lastReset||0)<1e3)&&(o&&o.msgs&&o.history&&!kr&&o.offset>300&&0==o.skipped&&a<50&&a>=0&&0===(e.get().selectedMessages||[]).length)){var l=Object.keys(o.msgs).filter(e=>e>0).sort((e,t)=>e-t).slice(0,-50),c=l.slice(-1)[0];e.mutate(n.resetTabAll.bind(null,t)),e.set(n.removeMessages.bind(null,l,t)).then(()=>s().removeStartingFromMessage(c,t,e))}}function ki(e,t,a,n){var i=n.target,s=domClosest("_im_replied_message",i),o=Number(s.getAttribute("data-msgid")),l=domClosest("im-mess",i),c=Number(l.getAttribute("data-msgid")),d=e.get().peer;o&&!Object(r.isAlreadyDeleted)(e,d,o)?(e.setState({msgid:o}),Object(gr.updateLocation)({msgid:o}),Object(r.focusOnMessage)(e,t().focusOnMessage,d,o)):c&&Object(r.showRepliedBox)(e,c,n)}function Mi(e){checkEvent(e)||cancelEvent(e)}function Pi(e,t){var a=domClosest("_im_mess",t);if(a){var r=Number(a.getAttribute("data-msgid")),o=e.get().peer,l=Object(i.getMessage)(e,o,r);r&&l&&!Object(s.isOut)(l)&&Object(n.markAudioMessageAsListened)(o,r,e.get())}}function Li(e,t,a){var n=a.target.closest("."+r.MESSAGE_KEYBOARD_BUTTON_CLASS),i=a.target.closest("."+r.MESSAGE_STACK_CLASS);if(n){var s=e.sendMessageFromKeyboard.bind(null,()=>e),o=Object(rt.getActionObjectFromElement)(n),l=i?i.dataset.peer:void 0,c=a.target.closest("._im_mess");return Object(rt.handleButtonClick)(o,s,{keyboardAuthorId:l,store:t,messageElement:c,buttonElement:n})}}function Ai(e,t){var a=t.target.closest("._im-call-snippet"),n=a.closest("._im_mess_callsnippet"),i=a.dataset.type,s=a.dataset.participants,o=s&&s.split(",").reduce((t,a)=>(+a!==e.get().id&&Object(r.isUserPeer)(+a)&&t.push(+a),t),[]),l=+n.dataset.peer;Object(r.isCallToPeerAvailable)(e,l)&&Object(r.startCallFromIm)(e,l,"video"===i,o,r.CALL_ENTRY_POINT_SNIPPET)}function Di(e,t,a){Bi(e,t,a.target.closest("._im_mess_pinned"))}function Bi(e,t,a){var n=+a.dataset.msgid,s=Object(i.getMessage)(e,e.get().peer,n),o=Object(Ba.canMessageBeEdited)(e,s);o!==a.classList.contains("im-mess_editable")&&(a.classList.toggle("im-mess_editable",o),Object(r.updateMessageInCache)(e,t,a))}function xi(e,t,a,o,u,g,m,_,b,h,f,v,O,y,j,C,w,E){var T,S=Object(l.throttle)((function(){a.smoothScroll(...arguments)}),300);return{fixKeyboard(){u.fixKeyboard()},removeUnpinnedMessageEditable(e,a){var n=t.querySelector("._im_mess_pinned:not(._im_mess_"+a);n&&(n.classList.remove("_im_mess_pinned"),Bi(e,t,n))},changePeer(e){var s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],l=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],c=e.get().peer;if(revertLastInlineVideo(t),0===c)return j.disable(),u.setDraft(e,null),function(e){addClass(e,"im-page--history_empty"),Kr(e).innerHTML=""}(t);if(Object(r.isFullyLoadedTab)(e.get(),e.get().peer)){removeClass(t,"im-page--history_search"),e.set(n.dropSelection),o.changeActions(e),o.showActions(e);var d=e.get().prevPeer;removeClass(t,"im-page--history_loading"),toggleClass(t,"im-page--history_vkcomgroup",Object(r.isFvkcomgroup)(e,c)),s?u.setDraft(e,Object(i.getTabDraft)(Object(H.getCurrentTab)(e))):u.updateState(e),ni(e,t),ri(e,t),g().updateTyping(c,e),ti(e,0,o),Object(r.isReservedPeer)(d)&&!Object(r.isReservedPeer)(c)?function(e,t,a,n,r,i,s,o,l,c,d){removeClass(e,"im-page--history_empty"),Wr(e,t,a,n,r,i,s,o,l,c,d)}(t,e,c,a,g,o,_,C,E,l,j):Object(r.isReservedPeer)(d)||Object(r.isReservedPeer)(c)||Wr(t,e,c,a,g,o,_,C,E,l,j),Object(i.isCasperChat)(e,c)||(j.enable(),j.toggle(!0),j.reset(a)),Object(r.isReservedPeer)(c)||setTimeout(()=>{Qr(e,g,Kr(t),O,j,t,0,a)}),Object(r.ensureDomHasActions)(t)}},preparePeer(e){var a=Object(nt.getPeer)(e);Ei(e),u.setDraft(e,Object(i.getTabDraft)(Object(i.getTab)(e,a)),!1),g().updateTyping(a,e),g().hideError(),o.renderPeer(e),C.renderPeer(e),o.hideActions(e),_.changePeer(a,e),ti(e,0,o),j.toggle(!1),Oi(e,t,!0),yi(e,t,!0)},saveScroll:e=>zr(e,a),loadingPeer(e){Object(n.isAnythingLoading)(e.get())||(removeClass(t,"im-page--history_empty"),addClass(t,"im-page--history_loading"))},stopLoading(e){removeClass(t,"im-page--history_loading")},deselectDialog(e){m().removeSelection(e)},replaceMessageAttrs(e,a){Object(r.replaceMessageAttrs)(a.get(),Kr(t),e)},cleanSelection(e){h.cleanSelection(e)},updateDialogFilters(e){m().updateDialogFilters(e)},getSearchResulstModule:()=>T,showSearchResults(e){e?(removeClass(t,"im-page--history_search-empty"),Kr(t).innerHTML=e):(addClass(t,"im-page--history_search-empty"),Kr(t).innerHTML=Object(r.renderEmptySearch)())},insertSearch(e,n){T||(o.deselectAll(n),T=p(t,n)),addClass(t,"im-page--history_search"),g().showSearchResults(e),bi(n,a,t),a.scrollBottom(0),ni(n,t),ri(n,t),j.reset(a)},updateChatTopic(e,t){m().updateDialog(e,t),e===t.get().peer&&(o.renderPeer(t),o.renderActions(t),C.renderPeer(t))},updateActions(e){o.changeActions(e)},updateChatPhoto(e,n,i){if(Object(r.isPeerActive)(e.peerId,i.get())){o.renderPeer(i),C.renderPeer(i);var s=li(a);Object(r.addChatPhotoToUpdate)(e,n,i.get(),Kr(t)),s&&a.scrollBottom(-30)}},markImportant(e,a,n){Nr(t,e)&&(o.changedMessageSelection(n),b.markImportant(e,a,n))},isNewMessagesVisible:e=>function(e,t){return Object(i.getUnreadScrollBottom)(e)>=intval(t.scrollBottom())}(e,a),loadHistory(e,n,i){var s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=i.get();if(Object(r.isPeerActive)(e,o)){var l=s||o.tabs[e].historyToAppend;if(!l)return;var c=geByClass1("_im_peer_history",t),d=domFC(c),u=a.scrollBottom(),g=n.reversed?e=>c.appendChild(e):e=>c.insertBefore(e,d),m=0;n.reversed&&(m=c.offsetHeight);var p=sech(l),_=document.createDocumentFragment();p.forEach(e=>_.appendChild(e)),g(_),n.reversed&&j.heightIncreased(c.offsetHeight-m,a),n.reversed||a.scrollBottomFixSave(u),a.update(!1,!0);var b=p.filter(e=>hasClass(e,"_im_bar_date"));j.parseMore(b,a),Object(r.ensureDomHasActions)(t)}},sendMessage(e){0!==e.get().peer&&u.sendMessage()},editMessage(e,n){if(Object(r.isFullyLoadedTab)(e,n.peerId)&&Object(r.isPeerActive)(n.peerId,e.get())){if(!Nr(t,n.messageId))return;zr(e,a),Object(r.editAndReplaceMessage)(e.get(),n,t),Vr(Object(i.getTab)(e,n.peerId),a),o.reRenderPinned(e),j.reset(a)}},addMessage(e,o){if(!Object(n.isSearchingInplace)(o.peerId,e.get())&&Object(r.isFullyLoadedTab)(e,o.peerId)&&Object(r.isPeerActive)(o.peerId,e.get())){if(Nr(t,o.messageId))return;var l=Kr(t);hi(j,l,a,()=>{var n=li(a),c=geByClass1("_im_unread_bar_row",t),d=Tr(Object(r.isMessagesVisible)(e,t,a),2),u=d[0],m=d[1];Object(r.appendToHistory)(e.get(),o,l,!0,!0,!u&&!c),removeClass(t,"im-page--history_empty-hist");var p=Object(i.getTab)(e,e.get().peer),_=Object(s.isServiceMsg)(o)&&o.userId===vk.id,b=o.kludges&&o.kludges.source_act,h=_&&b!==r.CHAT_PIN_MESSAGE&&b!==r.CHAT_UNPIN_MESSAGE;p.skipped||u||!Object(s.isUnread)(p,o)||Object(s.isOut)(o)||(ni(e,t,!0,m),ri(e,t,!0,m)),(o.local||n||h)&&a.scrollBottom(0),g().updateTyping(o.peerId,e),ii(t,e),Si(t)});var c=domPS(domLC(l));if(hasClass(c,"_im_bar_date")){var d=ce("div");d.innerHTML=c.outerHTML,j.parseMore(d,a)}g().hideError(),j.update(a),Object(n.updateMentions)(e.get()),Ii(e,o.peerId,a.scrollBottom(),0,g),this.updateObserver()}},setMessageErrored(e,a,n,i){n&&"string"==typeof n&&g().showError(n),Object(r.setMessageError)(e,a,t)},markMessagesAsRead(e,a){e.get().peer===a.peerId&&Object(r.markMessagesAsRead)(e.get(),a.peerId,t)},compensateHistoryHeightChange(e){a.scrollTop(a.scrollTop()+e*Dr(v))},updateTyping(e,a){if(!Object(n.isSearchingInplace)(e,a.get())){var s=a.get();if(s.peer===e&&Object(r.isFullyLoadedTab)(s,e)){var o=Object(r.formatTyper)(Object(i.getTab)(a,e).activity,e,!1,s),l=geByClass1(r.TYPING_CLASS,t);if(l||o){if(!l){var c=geByClass1("_im_typer_c",t);val(c,getTemplate("im_typing",{cls:Object(r.isClassicInterface)(a)?"im-activity_classic":""})),l=geByClass1(r.TYPING_CLASS,t)}val(geByClass1("_im_typing_name",l),o);var d=Object(r.loadSummaryActivityType)(Object(i.getTab)(a,e).activity||{})===n.ACTIVITY_TYPE_RECORDING_AUDIO;l.setAttribute("data-activity-type",d?"recording":"typing"),o?(addClass(l,"im-page--typing_vis"),g().hideError()):removeClass(l,"im-page--typing_vis")}}}},scrollFix(e,t,n){j.heightIncreased(n,a),j.update(a),Object(r.isPeerActive)(t,e.get())&&li(a,n)&&a.scrollBottom(-30)},goToEnd(){pi(()=>this,v,t,a)},updateGoToEnd(e,n){var r=Object(i.getTab)(e,e.get().peer);r&&(r.skipped||r.unread)?ni(e,t):Oi(e,t,n),f(0,a,!1);var s=e.get().peer;setTimeout(()=>{e.get().peer===s&&zr(e,a)})},updateGoToMention(e,n){var r=Object(i.getTab)(e,e.get().peer),s=oi(e),o=s.length>0&&s[0].messageId;r&&o?ri(e,t):yi(e,t,n),f(0,a,!1);var l=e.get().peer;setTimeout(()=>{e.get().peer===l&&zr(e,a)})},newMessage(e){m().newMessage(e),Oi(e,t,!0),yi(e,t,!0)},scroll(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==e.get().peer){var i=n?a.getScrollHeight():40;!0===r&&(i=a.contHeight()),i="up"===t?-i:i,n||r?S(i,()=>{f(i,a)}):(a.scrollTop(a.scrollTop()+i),f(i,a))}},showCreation(e,t){m().showCreation(e,t)},updateScroll:()=>bi(v,a,t),toggleBarDate(e){j.toggle(e)},changedMessageSelection(e){o.changedMessageSelection(e)},updateOnline(e,t){Object(r.isTabLoaded)(t.get(),e)&&e===t.get().peer&&o.renderPeer(t)},isEmpty:e=>u.isEmpty(e),replaceAttachmentPlaceholders(e,n){if(Object(r.isPeerActive)(n.peerId,e.get()))hi(j,Kr(t),a,()=>{var s=li(a);Object(r.replaceAttaches)(t,n,e.get());var l=Object(i.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(i.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned,o.reRenderPinned(e))}s&&a.scrollBottom(0)}),j.update(a);else if(Object(s.isMoneyRequest)(n)){var l=Object(i.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(i.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned)}}},removeMessages(e,n,i){i.get().peer===n&&(Object(r.removeMessages)(e,Kr(t)),Object(r.removeExpiredMessagesStub)(e,Kr(t)),bi(i,a,t),o.changedMessageSelection(i),this.updateObserver())},removeStartingFromMessage(e,n,i){if(i.get().peer===n){var s=Kr(t),l=geByClass1("_im_mess_"+e,s);Object(r.removeStartingFromMessage)(l,s),bi(i,a,t),o.changedMessageSelection(i)}},hideGoToEnd(e){Oi(v,t,e)},hideGoToMention(e){yi(v,t,e)},removeMessagesRestore(e,a,n,i){i.get().peer===a&&Object(r.removeMessagesWithRestore)(e,a,n,Kr(t))},removeExpiredFailedMessages(e){v.get().peer===e&&v.set(n.removeExpiredFailed.bind(null,Kr(t),e))},handleMessageExpiration(e){Object(r.isFullyLoadedTab)(v.get(),e.peerId)&&(Object(r.replaceExpiredMessageWithPlaceholder)(v,t,e),Object(r.replaceExpiredRepliedMessageWithPlaceholder)(t,e),u.detachMessages(e))},updateState(e,t){m().updateState(e,t)},updateBanner(e){C.renderPeer(e)},updateHeader(e){o.renderPeer(e)},updateChat(e,t){e.get().peer===t&&(o.changeActions(e),o.renderPeer(e),o.renderActions(e),C.renderPeer(e),u.updateState(e),Object(n.updateMentions)(e.get()))},focustTxt(e){u.focusOn(e)},startSearch(e){g().showSearch(e),_.changePeer(e.get().peer,e),_.search()},showSearch(e){addClass(t,"im-page--hisory_search-open"),e.setState({searchShown:!0}),Lr(e)&&this.updateChatTopic(e.get().peer,e),this.cancelEditing(),setTimeout(()=>_.focus(e),10)},cancelSearch(e){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e.get().searchShown&&(removeClass(t,"im-page--hisory_search-open"),removeClass(t,"im-page--history_search"),removeClass(t,"im-page--history_search-empty"),e.setState({searchShown:!1}),Lr(e)&&this.updateChatTopic(e.get().peer,e),o.changedMessageSelection(e)),i&&!Object(r.isReservedPeer)(e.get().peer)&&T){var s=e.get().tabs[e.get().peer],l=Object(n.strHistory)(s.history);l?Kr(t).innerHTML=l:g().showEmptyScreen(),bi(e,a,t),a.scrollBottom(0),e.get().msgid&&(ei(a,t,e.get().msgid,e),ni(e,t),ri(e,t)),O(a),j.reset(a)}T&&(T.unmount(),T=!1,Object(r.ensureDomHasActions)(t))},showEmptyScreen(){var e=geByClass1("_im_peer_history",t);addClass(t,"im-page--history_empty-hist");var a=Object(i.isCasperChat)(v,v.get().peer)?getTemplate("sImEmptyCasper"):getLang("mail_im_here_history");val(e,a)},updateHistory(e){0!==v.get().peer&&e(t)},focusOnMessage(){ei(a,t,v.get().msgid,v)},sendEditMessage(e,t){e.set(n.deliverEditedMessage.bind(null,Object(i.getTab)(e,t.peerId),t)).catch(a=>e.get().longpoll.push([Object(d.failedMessage)(t.peerId,t,a)]))},unmount(){Object(c.destroyModule)(e),a.destroy(),clearInterval(y),u.unmount(),o.unmount(),b.unmount(),h.unmount(),_.unmount(),j.unmount(),cancelStackFilter("forward"),Fr("_im_chat_resize_track",t),E.destroy()},removePeer(e,t){m().removePeer(e,t)},restoreScroll(e,t){var n=e.get().tabs[t];n.scrollBottom?Vr(n,a):a.scrollBottom(-30)},resendMessage(e,a){e===v.get().peer&&Object(r.startResendMessage)(e,a,t)},resendPeer(){u.resendPeer()},resendAll(){u.resendAll()},respond(e,t){u.attachMessages(e,t),u.focusOn(e);var n=Object(i.getTab)(e,t);n&&!n.skipped&&(a.scrollBottom(-30),O(a))},cancelRecording(){u.cancelRecording()},flushDraft(e){u.saveText(e)},hideError(){geByClass1("_im_error",t).classList.remove("im-page--error--visible")},showError(e){var n=geByClass1("_im_error",t);n.innerHTML=e,n.classList.add("im-page--error--visible"),a.scrollBottom(-30)},startEditing(e){if(Object(n.isAnythingLoading)(v.get()))Object(r.showWaitUntilUploadedBox)();else{e=Object(i.parserMessage)(e);var a=Object(r.getNowEditingMessage)(v);if(!(u.isBlocked()||a&&a.messageId==e.messageId)){a&&this.cancelEditing(),Si(t),v.get().searchShown&&this.cancelSearch(v);var s=Nr(t,e.messageId);s&&(this.cancelRecording(),function(e,t,a,n,r){e.setState({isEditing:!0}),a.saveText(e),addClass(n,"im-mess_is_editing"),addClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackPush("cancel_edit",()=>Ti(e,t,a,n,r));var i=new xa.ImDraft;i.dData.txt=Object(Ba.convertEmojiHtmlToRegularText)(r.text),i.dData.attaches=Object(q.convertKludgesToAttaches)(r.kludges,r.messageId),a.toggleStickers(e,!1),a.setDraft(e,i),setTimeout(()=>a.focusOn(e),0)}(v,t,u,s,e),u.hideKeyboard(),o.deselectAll(v))}}},cancelEditing(){var e=Object(r.getNowEditingMessage)(v);e&&Ti(v,t,u,Nr(t,e.messageId))},messageKeyboardButtonClick:e=>Li(u,v,e),getEditingMessage:()=>Object(r.getNowEditingMessage)(v),focusEditingMessage(){var e=Object(r.getNowEditingMessage)(v);e&&ei(a,t,e.messageId,v),u.focusOn(v)},setNetworkWaitingStatus(e){o.setNetworkWaitingStatus(e)},setNetworkReconnectingStatus(){o.setNetworkReconnectingStatus()},clearNetworkStatus(){o.clearNetworkStatus()},updateCasperMessageStatus(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(r.isFullyLoadedTab)(v.get(),e.peerId)&&v.set(n.updateCasperMessageExpiringStatus.bind(null,e,a)).then(()=>{v.get().peer===e.peerId&&Object(r.setCasperMessageExpiringStatusDOM)(t,a,e.messageId)})},updateObserver(){w.update()},renderPeerProfile(e){E.render(e)},destroyPeerProfile(){E.destroy()}}}function Ni(e,t,a,o,u){var g=geByClass1("_im_peer_history_w",e);Object(va.hasAccessibilityMode)()&&addClass(g,"history_a11y");var m,p,_,f=Object(c.createMutations)(xi),v=f.callMutations,O=f.bindMutations,y=(m=zr.bind(null,t),p=Object(Oa.debounce)(m,100),_=Object(l.throttle)(m,100),e=>{p(e),_(e)}),j=ur(t,e),C=Qr.bind(null,t,v,g,y,j,e),w=Object(h.createScroll)(geByClass1("_im_chat_body_abs",e),{onScroll:C,nativeScroll:Object(r.isClassicInterface)(t),shadows:!1}),E=Object(r.isClassicInterface)(t)?void 0:w.scroll.container,T=function(e,t,a){var n=Object(b.default)({observer:new IntersectionObserver(a,{root:t}),targets:[]});Qn(e,t,n);var r=Object(c.createModule)({handlers:(e,t)=>{}});return{update(){Qn(e,t,n)},unmount(){var e=n.get(),t=e.observer;e.targets.forEach(t.unobserve.bind(t)),Object(c.destroyModule)(r)}}}(t,E,e=>function(e,t,a){var r=Object(H.getCurrentTab)(e);if(r){var o=a.reduce((t,a)=>{if(a.isIntersecting){var n=+a.target.getAttribute("data-msgid"),o=Object(i.getMessage)(e,r.peerId,n);n&&o&&!Object(s.isOut)(o)&&t.push(n)}return t},[]);if(o.length){var l=Math.max(...o);Jr(e,l).then(()=>{l===r.lastmsg&&e.set(e=>Object(n.setActions)(e)).then(()=>t().updateActions(e))})}}}(t,v,e));setTimeout((function(){var a=t.get().peer;if(a){if(Ei(t),(Object(H.getCurrentTab)(t).pinned||Object(H.getCurrentTab)(t).top_banner)&&(v().updateChatTopic(a,t),t.set(n.setActions),S.changeActions(t)),Object(H.getCurrentTab)(t).callInProgress&&v().updateBanner(t),t.get().msgid)ei(w,e,t.get().msgid,t);else if(!Zr(w,e,v,t,j)){w.scrollBottom(-30);var s=Object(H.getCurrentTab)(t);Object(r.isTabMarkedUnread)(s)&&t.set(e=>Object(n.markDialogRead)(s.peerId,e))}t.get().history_init=!1,Object(i.isCasperChat)(t,a)?j.disable():j.reset(w),ni(t,e),ri(t,e),Qr(t,v,g,y,j,e,0,w),Object(r.ensureDomHasActions)(e),nav.objLoc.st&&(t.mutate(n.setInplaceSearch.bind(null,nav.objLoc.st,a)),v().startSearch(t))}else j.disable()}),15);var S=Object(st.mount)(geByClass1("_im_dialog_actions",e),t,v),I=kn(geByClass1("_im_text_input",e),t,Object(r.isClassicInterface)(t)?o.updateMenu:void 0,(e,t)=>{a.removeDialog(e,t),a.restoreDialogs(e,!0)},v),k=Nn(geByClass1("_im_dialog_actions",e),t,v),M=Yn(e,t,v),P=Xn(e,t,()=>({changedMessageSelection:S.changedMessageSelection})),L=Object(Jn.mount)(g);Object(Zn.mount)(e,t,v);var A=Cr(e,t,()=>({hidePinned(){Object(Zn.pinnedMessageHide)(t,t.get().peer,v,!1)},compensateHistoryHeightChange(e){v().compensateHistoryHeightChange(e)},showPinned(){Object(Zn.pinnedMessageUnHide)(t,t.get().peer,v,!1)}}));Object(r.isReservedPeer)(t.get().peer)||t.set(n.restoreHistoryQueue.bind(null,t.get().peer)).then(()=>{Object(r.restoreQueue)(t.get().peer,t.get(),Kr(e)),Gr(e,t,t.get().peer)}),AudioMessagePlayer.events.on("listened",Pi.bind(null,t)),Rr("_im_chat_resize_track",e,u);var D=ci.bind(null,t,e,v),B=di.bind(null,t,e,w,v),x=ui.bind(null,u,t),N=pi.bind(null,v,t,e,w),R=_i.bind(null,v,t,e,w),F=qr.bind(null,t,e),G=r.showEditTimeTooltip.bind(null,t),q=r.showMessageInfoTooltip.bind(null,t),K=ai.bind(null,t,D,e,v),V=Ur.bind(null,t,e,w),W=ji.bind(null,v,t,w),z=Ci.bind(null,t),Y=wi.bind(null,t,v),$=ki.bind(null,t,v,e),X=Li.bind(null,I,t),Q=Hr.bind(null,v),J=r.showCasperExpiringTooltip.bind(null,t,e),Z=()=>showWiki({w:"expired_messages"}),ee=Ai.bind(null,t),te=e=>function(e,t){var a=t.target.closest("._im_call_snippet_join_btn"),n=a.closest("._im_mess_callsnippet"),i=a.dataset.link,s=+n.dataset.peer;Object(r.isCallToPeerAvailable)(e,s)&&Object(r.joinCallFromIm)(e,s,i,!1,r.CALL_ENTRY_POINT_JOIN_SNIPPET)}(t,e),ae=Di.bind(null,t,e),ne=Object(c.createModule)({handlers:(a,s)=>{s(e,"click",r.RESTORE_CLASS,B),s(e,"mouseover click",r.FAILED_CLASS,F),s(e,"mouseover","_im_edit_time",G),s(e,"mouseover","_im_page_info",q),s(e,"click","_im_mess_susp",xr.bind(null,e)),s(e,"click","_im_failed_action",K),s(e,"click","_im_mess_link",V),s(e,"mouseover","_im_admin_name",fi),s(e,"mouseover","_im_mess_srv",z),s(e,"mouseover","im-mess-stack--bomb",J),s(e,"mouseover","mem_pseudolink",e=>function(e,t){var a=e.target.dataset.mention,n=null;switch(!0){case at.MASS_MENTION_ALIASES.all.includes(a):n=getLang("mail_im_mention_all");break;case at.MASS_MENTION_ALIASES.online.includes(a):n=getLang("mail_im_mention_online")}n&&(window.tooltips&&window.tooltips.destroy(e.target),Object(U.showTooltip)(e.target,{shift:[0,5],center:!0,black:1,className:"im-mass-mention-tt",reverseOffset:!0,toup:e.target.getBoundingClientRect().top>Object(r.getHistoryTopIndent)(t)+37,text:n,noZIndex:!0}))}(e,t)),s(e,"mouseover","_im_mess_pinned",ae),s(e,"click","im_srv_mess_link",Y),s(e,"click","_im_error",Q),s(e,"click","_im_replied_message",$),s(e,"click","_im_replied_author_link",Mi),s(e,"click","_chat_invitation",(e,a)=>{if(checkEvent(e))return!0;if(!gpeByClass("wall_postlink_preview_btn",e.target)&&!hasClass(e.target,"wall_postlink_preview_btn"))return!0;var i=geByClass1("flat_button",a),s={invite_chat_id:domData(i,"inv-id"),invite_hash:domData(i,"hash")};Object(r.showInvitationBox)(t,s,n.leaveInvitation),cancelEvent(e)}),s(e,"click","_im_join_call_by_link",r.handleCallLinkClick),s(e,"click","_im_join_cancel",()=>t.get().longpoll.push([Object(d.resetPeer)()])),s(e,"click","_im_retry_media",e=>function(e,t,a){var s=e.get(),o=domClosest("_im_mess",a.target),l=domData(o,"msgid"),c=Object(i.getMessage)(s,s.peer,l),d=e=>t().replaceAttachmentPlaceholders(e,c);c&&(Object(tt.statlogsSendingRetry)("retry_attach"),e.set(n.addAttachmentsToStoreData.bind(null,c,[Object(r.renderMessageMedia)(e,c)])).then(d),e.set(n.loadMedia.bind(null,c)).then(d))}(t,v,e)),s(e,"click",r.MESSAGE_KEYBOARD_BUTTON_CLASS,X),s(e,"click","_im-call-snippet",ee),s(e,"click","_im_call_snippet_join_btn",te),a(geByClass1("_im_peer_history_w",e),"mousemove",j.show),a(geByClass1("_im_start_new",e),"click",x),a(e.querySelector("._im_to_end"),"click",N),a(e.querySelector("._im_to_mention"),"click",R),a(geByClass1("_im_cancel_edit",e),"click",()=>(v().cancelEditing(),!1)),a(geByClass1("_im_edit_focus_cur",e),"click",()=>(v().focusEditingMessage(),!1)),it.screenfull.raw&&a(document,it.screenfull.raw.fullscreenchange,W),a(window,"im_goToMessage",e=>{var a=intval(e.msgid);if(a)return window.statlogsValueEvent("im_links_to_attachments",1,"to_message"),t.set(n.changePeer.bind(null,e.sel,a,!1)).then(()=>Object(r.focusOnMessage)(t,v().focusOnMessage,t.get().peer,a))}),s(e,"click","im-expired-message--in",Z)}});curNotifier.recvClbks.pin_hide=[function(e){e.hide?Object(Zn.pinnedMessageHide)(t,e.peer,v,!1):Object(Zn.pinnedMessageUnHide)(t,e.peer,v,!1)}],window.showForwardBox=e=>function(e,t){Object(r.boxHandleMessagesLabelsTooltips)(showBox("al_im.php",t,{dark:1},{}),e)}(t,e);var re=setInterval(ti.bind(null,t,e,S),1e4);return O(ne,e,w,S,I,v,u,k,M,P,C,t,y,re,j,A,T,L)}function Ri(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Fi(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Fi(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Fi(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Hi=[],Ui=0,Gi=!1;function qi(e){Hi=Hi.reduce((t,a)=>{var n=Ri(a,2),r=n[0],i=n[1];return i(e)?t:t.concat([[r,i]])},[])}function Ki(e,t){!1===Gi&&(Gi=!0,document.body.addEventListener("click",qi,!0)),Hi=Hi.concat([[e,t]])}function Vi(e){Hi=Hi.filter(t=>Ri(t,1)[0]!==e),0===Ui&&(document.body.removeEventListener("click",qi,!0),Gi=!1)}function Wi(e,t){Hi=Hi.map(a=>{var n=Ri(a,2),r=n[0],i=n[1];return r===e?[e,t]:[r,i]})}function zi(e,t){return 0===t.length?t=>(e(t),!0):a=>{var n=t.reduce((e,t)=>e&&!domClosest(t,a.target),!0);return n&&e(a),n}}var Yi=a("XzvV"),$i=a("e87a"),Xi=a("GSQL"),Qi=a("CGHU"),Ji=a("8tCR"),Zi=a("p9ed"),es=a("RdBX"),ts=a("Aegd"),as=a("85vT"),ns=a("6krn"),rs=a("5R8M"),is=a("xt6h"),ss=function(e){var t=e.onClose,a=e.contacts,n=e.selectPeer,i=Object(Pt.useState)(""),s=i[0],o=i[1],l=Object(Pt.useState)(a),c=l[0],d=l[1],u=Object(Pt.useMemo)((function(){return new es.vkIndexer(a,(function(e){return[e.name,e.user&&e.user.full_name].filter(Boolean).join(" ")}))}),[a]);Object(Pt.useEffect)((function(){if(0!==s.length){var e=u.search(s);d(e)}else d(a)}),[s]);return Lt.a.createElement("div",{className:"ContactsListContent"},Lt.a.createElement(Qi.BlockSearchInput,{onChange:function(e){return t=e.target.value,void o(t);var t},placeholder:Object(ns.getLang)("mail_top_search"),autoFocus:!0,key:"search",value:s}),0===c.length?Lt.a.createElement(Ji.default,{className:"ContactsListContent__stub",key:"no-results"},Object(ns.getLang)("mail_im_search_empty_contacts")):Lt.a.createElement(Bt.Scroll,{className:"ContactsListContent__scroll"},Lt.a.createElement(Zi.default,{className:"ContactsListContent__list"},c.map((function(e){var a=e.user?e.user.user_id:19e8+e.id,i=Object(r.prepareContactName)(e.name),s=e.can_write,o=Object(is.classNames)("ContactsListContent__item",{"ContactsListContent__item--disabled":!s});return Lt.a.createElement(rs.default,{key:e.id,onClick:s?function(){return function(e){n(e),t()}(a)}:void 0,className:o,selectable:s},Lt.a.createElement("div",{className:"ContactsListContent__contactAvatar"},e.user?Lt.a.createElement("img",{className:"ContactsListContent__contactAvatarImage",src:e.user.photo,alt:e.name}):Lt.a.createElement(ts.ConversationNoPhoto,{text:Object(r.getUserInitials)(e.name),size:"34",id:a,specificType:7,key:e.id})),Lt.a.createElement("div",{className:"ContactsListContent__contactName"},Lt.a.createElement(as.default,null,i)))})))))},os=a("QDnf"),cs=function(e){var t=e.onClose,a=e.selectPeer,n=e.getContactsList,r=Lt.a.useState({kind:"loading"}),i=r[0],s=r[1];switch(Lt.a.useEffect((function(){n().then((function(e){s({kind:"loaded",contactsList:e})})).catch((function(e){Object(l.showErrorBox)(Object(ns.getLang)("global_error")),s({kind:"failed",error:e}),t()}))}),[]),i.kind){case"failed":return Lt.a.createElement(Lt.a.Fragment,null);case"loading":return Lt.a.createElement(os.default,null);case"loaded":return Lt.a.createElement($i.default,{onClose:t,disableBodyScroll:!0,className:"ContactsList"},Lt.a.createElement(Xi.default.Header,{title:Object(ns.getLang)("mail_contacts_list"),onClose:t,appearance:"blue"}),Lt.a.createElement("div",{className:"ContactsList__body"},Lt.a.createElement(ss,{contacts:i.contactsList,onClose:t,selectPeer:a})))}};function ds(e,t){var a=us();At.render(Pt.createElement(cs,{onClose:t.closeContactList,getContactsList:()=>function(e){return Object(st.checkContactListLoaded)(e).then(e=>{var t=e.get().contactsList;return Promise.resolve(t)})}(e),selectPeer:t=>function(e,t){e.get().longpoll.push([Object(d.changePeer)(t,!1,!0,!0,"contacts_list")])}(e,t)}),a)}function us(){var e=document.getElementById("_im_contacts_list");if(e)return e;var t=document.createElement("section");return t.setAttribute("id","_im_contacts_list"),document.body.appendChild(t),t}function gs(e,t){return{unmount:()=>function(e,t){var a=us();a&&At.unmountComponentAtNode(a),Object(c.destroyModule)(e)}(e),closeContactList(){var e=us();At.unmountComponentAtNode(e)}}}function ms(e){var t=(0,Object(c.createMutations)(gs).bindMutations)(Object(c.createModule)({handlers:(e,t)=>{}}),e);return ds(e,t),t}function ps(){return(ps=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function _s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return bs(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return bs(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function bs(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var hs=Object(Oa.debounce)(R.statlogsProbValueEvent,1e3);function fs(e,t,a,r,s,o,l){var c=trim(o);if(Object(i.isSearchingValue)(e,c)){var d=()=>l.clearSearch(e,t);c?(e.setState({recentSearch:!1}),s.stop()):s.replaceOrAdd(d),cancelStackPush("im_search",d),c&&e.set(e=>Object(n.setCurrentSearch)(c,!1,e)).then(t),r.classList.add("im-page--dialogs-search_fill","_im_d_search"),Object(i.isCommunityInterface)(e)||l.showCancelControl()}else c||(s.stop(),e.set(e=>Object(n.setCurrentSearch)("",!1,e)).then(t),r.classList.remove("im-page--dialogs-search_fill","_im_d_search"),Object(i.isCommunityInterface)(e)||l.hideCancelControl())}function vs(e,t,a){return function(){var n=Object(i.getSearchText)(t);n===e&&a(...arguments)}}function Os(e,t,a){var r=Object(i.getSearchText)(a);return hs(.01,"im_search_stat",1,"search_start"),Object(n.updateSearchQuery)(r),a.setState({recentSearch:!1}),e().toggleSettingsButton(a,!!r),r?(a.get().dialog_search_going=!0,function(e,t,a){var r=vs(e,a,e=>t().appendFastDialogs(a,e));return Object(n.searchTopConv)(e,a.get()).then(e=>(r(e),e))}(r,e,a).then(n=>{var i=n.map(e=>e.peerId);return t(r,e,i,a)}).then(()=>{a.get().dialog_search_going=!1}).catch(()=>{})):(e().restoreDialogs(a,!1,!0),Object(Yi.removeSearchPositionTracker)("messages"),Promise.resolve(!1))}function ys(e,t,a,i){var s=i.get(),o=vs(e,i,e=>t().appendDialogs(i,e)),l=vs(e,i,t().appendSearch);return Object(r.isPendingForward)(i)?Object(n.searchHints)(e,a,"all",{},s).then(o):Promise.all([Object(n.searchHints)(e,a,"all",{},s).then(o),Object(n.searchMessages)(e,s)]).then(e=>{var t=_s(e,2),a=_s(t[1],2),n=a[0],r=a[1];l(i,n,r,!0)})}function js(e,t,a){var r=a.target;e.set(e=>Object(n.toggleCommunityMute)(t,e)).then(()=>{r.classList.toggle("im-page--gim-mute_muted",e.get().mute),t&&Cs(e,{target:r})})}function Cs(e,t){var a=t.target;return Object(U.showTooltip)(a,{text:()=>e.get().mute?Object(fa.getLang)("mail_im_sound_off"):Object(fa.getLang)("mail_im_sound_on"),black:1,shift:[13,9],appendCls:"js-im-page"})}function ws(e,t,a,n,r,s,l,d,u){return{focusInput(){uiSearch.focus(n.parentNode)},hideCancelControl(){a.classList.remove("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_hidden"),t.classList.remove("im-dialog-select_rotated")},showCancelControl(){a.classList.add("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_rotated"),t.classList.remove("im-dialog-select_hidden")},setSearch(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?u:()=>{};n.value=t,fs(e,a,0,n,s,t,d())},clearSearch(e,t){cancelStackFilter("im_search"),Object(i.isCommunityInterface)(e)||d().hideCancelControl(),uiSearch.reset(n),e.setState({recentSearch:!1}),fs(e,t||(()=>{}),0,n,s,n.value,d())},initPeerTagsFilter(e){Object(o.initPeerTagsFilter)(e)},unmount(){s.stop(),Object(c.destroyModule)(l),uiSearch.destroy(r),cancelStackFilter("im_search")}}}function Es(e,t,a){var s=Object(c.createMutations)(ws),l=s.callMutations,u=s.bindMutations,g=geByClass1("_im_dialogs_header_controls",e),m=geByClass1("_im_create_convo",e),p=geByClass1("_im_create_call",e),_=geByClass1("_im_search_cancel",e),b=ge("im_dialogs_search",e),h=geByClass1("_im_gim_mute",e),f=geByClass1("_im_av_time",e),v=geByClass1("_im_peer_tags_filter_control",e),O=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Ui++,{stop(){Ui--,Vi(e)},replaceOrAdd(a){var n=Hi.filter(t=>{var a=Ri(t,1)[0];return e===a}),r=zi(a,t);n.length>0?Wi(e,r):Ki(e,r)}}}("im_search",["_im_search_more","_im_create_convo","_im_create_call","_im_page_dcontent","_im_d_search","_im_dialog"]),y=Object(ra.debouncedPromise)(ys,300),j=e=>Os(a,y,e),C=e=>fs(t,j,0,b,O,e,l()),w=()=>l().clearSearch(t,j),E=geByClass1("_im_dialogs_search_input",e);uiSearch.init(E,{onChange:C}),b.value&&setTimeout(()=>C(b.value),0);var T=e=>{Object(U.showTooltip)(e.target,{text:Object(fa.getLang)("mail_admin_av_time"),dir:geByClass1("_im_top_notice")||geByClass1("im-page--dialogs--group-status")?"down":"up",shift:[0,8]})},S=()=>{var e;e=0===t.get().peer||Object(r.isPendingForward)(t)?"search":"default",Object(i.isSearching)(t)||a().toggleSettingsButton(t,!1),t.get().longpoll.push([Object(d.transitionEvent)(e)])},I=()=>{Object(i.isSearching)(t)&&a().toggleSettingsButton(t,!0),function(e,t,a,s,o,l){if(!Object(i.isSearching)(e)){var c=cur.imDb.select(mr.RECENT_SEARCH_OP);if(0!==c.length||Object(i.doPopularSuggExist)(e)){e.setState({recentSearch:!0}),fs(e,()=>{Object(i.isSearching)(e)||(s.stop(),o().toggleSettingsButton(e,!1),o().restoreDialogs(e,!1,!0))},0,a,s,"",l);var d=c.filter(t=>!Object(r.isTabLoadedWithMessage)(e.get(),t)),u=c.filter(t=>Object(r.isTabLoadedWithMessage)(e.get(),t)).reduce((t,a)=>(t[a]=Object(i.getTab)(e,a),t),{});e.get().topConvTree.then(t=>{var a=t.list.filter(e=>d.includes(e[0])).reduce((e,t)=>(e[t[0]]=Object(n.localIndexToDialog)(t),e),{}),r=ps({},a,{},u);return o().appendFastDialogs(e,c.map(e=>r[e])),a}).then(t=>Object(n.searchHints)(!1,Object.keys(t),!1,{},e.get())).then(t=>{o().appendDialogs(e,t)})}}}(t,0,b,O,a,l())},k=(e,a)=>{switch(a.dataset.action){case"contacts":ms(t);break;case"favorites":nav.go("/im?box=fav")}},M=Object(c.createModule)({handlers:(n,s)=>{n(_,"click",w),n(_,"mouseover",()=>function(e,t){return Object(U.showTooltip)(t,{appendEl:bodyNode,text:Object(fa.getLang)("mail_cancel"),black:1,shift:[3,-1],appendCls:"js-im-page"})}(0,_)),n(m,"click",()=>a().showCreation(t)),n(p,"click",()=>Object(r.startCallFromIm)(t,null,!1,null,r.CALL_ENTRY_POINT_LIST)),s(e,"click","_im_search_more_action",k),f&&n(f,"mouseover",T),Object(i.isCommunityInterface)(t)&&h&&(n(h,"click",e=>js(t,!0,e)),n(h,"mouseover",e=>Cs(t,e))),n(b,"click",I),n(b,"blur",S),n(b,"focus",()=>{t.get().longpoll.push([Object(d.transitionEvent)("search")])}),Object(i.isCommunityInterface)(t)&&v&&(s(e,"change","_im_peer_tags_filter_checkbox",e=>Object(o.onPeerTagsFilterCheckboxChange)(e,t)),s(e,"click","_im_peer_tags_filter_pane_item",e=>Object(o.onPeerTagsFilterPaneItemClick)(e,t)))}});return Object(i.isCommunityInterface)(t)&&(v?Object(o.initPeerTagsFilter)(t):h&&js(t,!1,{target:h})),u(e,_,g,b,E,O,M,l,j)}function Ts(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Ss(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ss(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ss(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Is(e,t,a,i){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var s=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(r.wrapLoading)(s)(Object(n.loadSpam)(e.offset,i.get().gid).then(t=>{var a=Ts(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(s,"im-important_all"):e.loading=!1,i.set(n.mergeTabs.bind(null,Object(r.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,s.appendChild(c),Object(r.ensureDomHasActions)(s)}),"bottom")}}function ks(e,t){var a=t.get().selectedMessages,n=geByClass1("_im_spam_box",e.bodyNode),i=geByClass1("ui_tab_sel",e.bodyNode);if(a.length>0){var s=getLang("mail_selected",a.length);s=s.replace("{count}",a.length),val(i,s+`<button aria-label="${getLang("mail_deselect_all")}" type="button" class="im-deselect ${r.DESELECT_ALL_CLASS}"></button>`)}else val(i,getLang("mail_spam"));0===a.length?removeClass(n,"im-important-box_with-sel"):(addClass(n,"im-important-box_with-sel"),val(geByClass1("_im_spam_not_spam"),getLang("mail_im_mark_notspam",a.length)),val(geByClass1("_im_spam_spam"),getLang("mail_im_mark_delspam",a.length)))}function Ms(e,t,a){var r=e.get().selectedMessages;e.set(n.cleanSelected).then(a.cleanSelection.bind(null,r)).then(a=>ks(t,e))}function Ps(e,t,a,i){var s=gpeByClass("_im_mess",i,t);if(s){var o=intval(domData(s,"msgid"));s&&(Object(n.removeMessageSend)([o],0,e.get().tabs[0].hash,"undel",e.get()),Object(r.restoreMessage)(o,0,t))}}function Ls(e,t,a){var i=e.get().selectedMessages;Object(n.removeMessageSend)(i,0,e.get().tabs[0].hash,"delete",e.get()),Object(r.removeMessagesWithRestore)(i,0,"delete",t),Ms(e,t,a)}function As(e,t,a){var i=e.get().selectedMessages;Object(n.removeMessageSend)(i,0,e.get().tabs[0].hash,"nospam",e.get()),i.map(e=>geByClass1("_im_mess_"+e)).filter(e=>e).forEach(e=>{var t=intval(domData(e,"peer")),a=intval(domData(e,"msgid"));val(e,Object(r.renderGoTo)(t,a)),addClass(e,"im-mess_light")}),Ms(e,t,a)}function Ds(e,t,a,n,r){var i=gpeByClass("_im_mess",r,t.bodyNode),s=intval(domData(i,"peer")),o=intval(domData(i,"msgid"));return t.hide(),a().unmount(),e.get().longpoll.push([Object(d.changePeer)(s,o)]),Object(Ht.stopEvent)(n),cancelEvent(n),!1}function Bs(e,t,a,r){var i=Object(lt.showFastBox)({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_delete_all_spam"),getLang("mail_delete"),()=>{Object(n.flushSpam)(e,r).then(e=>{var t=Ts(e,2),a=(t[0],t[1]);showDoneBox(a)}),i.hide(),t.hide(),a().unmount()},getLang("mail_close"),()=>i.hide())}function xs(e,t){return{unmount(){t.unmount(),Object(c.destroyModule)(e)}}}function Ns(e,t,a){var n=ge("box_layer_wrap"),i=Object(c.createMutations)(xs),s=i.callMutations,o=i.bindMutations,l=Object(b.default)({peer:0,oCache:{},tabs:Object(r.tabFromIds)(a.msgs,a.hash),gid:t.get().gid}),d=Is.bind(null,{all:a.all,loading:!1,offset:a.offset},e,n,l),u=Ps.bind(null,l,e.bodyNode),g=Ds.bind(null,t,e,s),m=Bs.bind(null,a.hash,e,s,t.get().gid),p=Xn(e.bodyNode,l,t=>({changedMessageSelection:ks.bind(null,e)})),_=Ls.bind(null,l,e.bodyNode,p),h=As.bind(null,l,e.bodyNode,p),f=Ms.bind(null,l,e,p);return Object(r.ensureDomHasActions)(e.bodyNode),o(Object(c.createModule)({handlers:(t,a)=>{t(n,"scroll",d),t(geByClass1("_im_spam_spam",e.bodyNode),"click",_),t(geByClass1("_im_spam_not_spam",e.bodyNode),"click",h),t(geByClass1("_im_spam_flush",e.bodyNode),"click",m),a(e.bodyNode,"click","_im_mess_restore",u),a(e.bodyNode,"click","_im_go_to",g),a(e.bodyNode,"click",r.DESELECT_ALL_CLASS,f)}}),p)}var Rs=a("8/qD"),Fs=a("4edV"),Hs=Object(Oa.debounce)(Rs.setInfo,400);var Us=a("MNOG");function Gs(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"im_settings",a={sound:ls.get("sound_notify_off")?getLang("mail_im_sound_off"):getLang("mail_im_sound_on"),showOnlyNotMuted:Object(nt.getLocalSettingsValue)(e,"show_only_not_muted_messages")?getLang("mail_show_only_not_muted_off"):getLang("mail_show_only_not_muted_on")};return window.pushNotifier&&window.pushNotifier.loadEndpoint()||Object(Er.partConfigEnabled)("push_notifier")&&ls.get("im_ui_notify_off")?a.browser=getLang("mail_notification_settings"):a.browser=Vs()?getLang("mail_im_notifications_on"):getLang("mail_im_notifications_off"),getTemplate(t,a)}function qs(e){return hasClass(e,"_im_settings_popup")?"im_settings_pop":"im_settings"}function Ks(e,t){Object(U.showTooltip)(t.target,{content:Gs(e,"im_settings_pop"),dir:"down",shift:[220,9],hasover:!0,showdt:10})}function Vs(){return DesktopNotifications.supported()&&!DesktopNotifications.checkPermission()&&!ls.get("im_ui_notify_off")}function Ws(e,t,a,n,i){var s=domData(i,"action"),o=gpeByClass("_im_settings_menu",i),l=qs(o);switch(s){case"spam":Object(r.showSpamLayer)(e,Ns,n);break;case"sound":ls.set("sound_notify_off",ls.get("sound_notify_off")?0:1),o.outerHTML=Gs(e,l);break;case"browser":Vs()?(ls.set("im_ui_notify_off",1),o.outerHTML=Gs(e,l),Object(tt.statlogsBrowserNotificationsOff)()):DesktopNotifications.checkPermission()?DesktopNotifications.requestPermission(()=>{o.parentNode&&(o.outerHTML=Gs(e,l))}):Object(Er.partConfigEnabled)("push_notifier")?nav.go("/settings?act=notify"):(ls.set("im_ui_notify_off",0),o.outerHTML=Gs(e,l),Object(tt.statlogsBrowserNotificationsOn)());break;case"showOnlyNotMuted":var c=Object(nt.getLocalSettingsValue)(e,"show_only_not_muted_messages")?0:1;e.set(e=>function(e,t,a){return Hs(e,t),Object(Fs.setLocalSettingsValue)(e,t,a)}("show_only_not_muted_messages",c,e)).then(Us.updateUnreadCounter),o.outerHTML=Gs(e,l)}}function zs(e,t,a){var s=Ks.bind(null,t),o=Ws.bind(null,t,a,e),l=function(e,i){if(Object(r.showUnreadOnly)(t,a,n.changeDialogsTab)){var s=t.get().active_tab===_.FOLDER_UNREAD;val(i,getTemplate("im_filter",{filter:s?getLang("mail_to_all_dialogs"):getLang("mail_to_unread")}))}},d=Object(c.createModule)({handlers:(t,a)=>{a(e,"mouseover","_im_dialogs_cog_settings",s),a(e,"click","_im_settings_action",o),a(e,"click","_im_to_unread",l)}});return function(e,t){return{updateFilter(t){var a,n=t.get().active_tab===_.FOLDER_UNREAD,r=[];Object(i.isSearching)(t)&&r.push("im-page--dialogs-filter_hidden"),Object(nt.getUnreadCountWithMuted)(t)>0?a=n?getLang("mail_to_all_dialogs"):getLang("mail_to_unread"):(a=getLang("mail_all_dialogs"),r.push("im-page--dialogs-filter_disabled")),val(geByClass1("_im_to_unread",e),getTemplate("im_filter",{filter:a,cls:r.join(" ")}))},toggleButton(t,a){var n=geByClass1("im-page--dialogs-filter",e);toggleClass(n,"im-page--dialogs-filter_hidden",a)},toggleLoader(t,a){var n=geByClass1("_im_dialogs_cog_settings",e);toggleClass(n,"im-page--dialogs-settings_loading",a)},updateSettings(t){var a=geByClass1("_im_settings_menu",e),n=qs(a);a.outerHTML=Gs(t,n)},unmount(){Object(c.destroyModule)(t)}}}(e,d)}var Ys=a("iukX"),$s=a("amDN");function Xs(e,t){return t.selection||(t.selection=[]),t.selection.push(e),Promise.resolve(t)}function Qs(e){return e.selection=[],Promise.resolve(e)}function Js(e,t){return t.selection=t.selection.filter(t=>t.id!==e),Promise.resolve(t)}function Zs(e,t,a,n,r,i,s){var o=intval(domData(s,"peer"));tooltips.hide(s),t.set(Js.bind(null,o)).then(i=>{to(e,n,t,r),a().selectionDeleted(t,o)})}function eo(e,t,a,r){e.set(n.setCurrentSearch.bind(null,a,!1)).then(t().onChange)}function to(e,t,a,n){var r=a.get().selection,i=uiSearch.getFieldEl(e);uiSearch.focus(e),r.length>0?attr(i,"placeholder",""):attr(i,"placeholder",unclean(Object(fa.getLang)("mail_search_creation"))),t.innerHTML=r.map(e=>`<div class="token">\n      <div class="token_title">${e.name}</div>\n      <div data-peer="${e.id}" class="token_del _ui_multiselect_cancel"></div>\n    </div>`).join(""),toggleClass(e,"ui_multiselect_has_selection",r.length>0),domFC(e).scrollTop+=50,n()}function ao(e,t){return Object(U.showTooltip)(t,{text:Object(fa.getLang)("mail_create_chat_remove_user"),black:1,shift:[15,8],appendParentCls:"_wrap"})}function no(e,t,a){uiSearch.init(e,{onChange:eo.bind(null,t,a)});var n=uiSearch.getFieldEl(e),r=ce("div",{className:"_ui_multiselection ui_multiselect_cnt"});n&&n.parentNode.insertBefore(r,n);var i,s,o=(i=n,s=0,function(){var e=i.offsetWidth;setStyle(i,{width:1});var t=i.offsetLeft;s!==t?(s=t,e=i.parentNode.offsetWidth,setStyle(i,{width:Math.max(30,e-t-20)})):setStyle(i,{width:e})});t.set(Qs);var l=Zs.bind(null,e,t,a,r,o),d=t=>{document.activeElement!==n&&uiSearch.focus(e)},u=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_ui_multiselect_cancel",l),a(e,"mouseover","_ui_multiselect_cancel",ao),t(e,"click",d)}});return{addSelection:(a,n)=>t.set(Xs.bind(null,{id:a,name:n})).then(to.bind(null,e,r,t,o)),removeSelection:a=>t.set(Js.bind(null,a)).then(to.bind(null,e,r,t,o)),resetSelection(){!function(e,t,a,n){e.set(Qs).then(to.bind(null,t,a,e,n))}(t,e,r,o)},focus(){uiSearch.focus(e)},save(){t.stash(),to(e,r,t,o)},restore(){t.pop(),to(e,r,t,o)},unmount(){uiSearch.destroy(e),Object(c.destroyModule)(u)}}}var ro=a("v+DW"),io=a("zjLC"),so="_im_dialogs_creation_name",oo="_im_create_select",lo=["im-creation--item_hovered"],co=0;function uo(e){!function(e){var t=e.querySelector("._im_creation_settings_modal_wrap"),a=go.bind(null,t);At.render(Pt.createElement($i.default,{onClose:a,className:"im-creation--modal-settings"},Pt.createElement($s.default,{title:Object(fa.getLang)("mail_chat_creation_settings"),onCloseClick:a}),Pt.createElement(Ys.ChatSettingsOptions,{flags:co,back:a,isChatCreation:!0,onSave:mo,afterSave:po.bind(null,t),onCancel:a})),t)}(e)}function go(e){e&&At.unmountComponentAtNode(e)}function mo(e){return co=e,Promise.resolve()}function po(e){go(e)}function _o(e){return Object(U.showTooltip)(e,{text:Object(fa.getLang)("mail_chat_creation_settings_icon_tooltip"),black:1,center:!0,zIndex:1e3,shift:[0,10]})}function bo(e,t,a,r,i,s){Object(n.toggleConversation)(!1),removeClass(t,"im-create_shown"),removeClass(t,"im-create_photo-attached"),setTimeout(fo.bind(null,t,!1),100),Co(s).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>{removeClass(e,"olist_item_wrap_on")}),a().createCanceled(e),i.resetSelection(),"add_member"===e.get().creationType&&e.set(n.setCreationType.bind(null,"chat",[])),e.set(n.presetAvatar.bind(null,!1));var o=geByClass1("_im_avatar_img",t);vo(e,s,t),uiSearch.reset(geByClass1(so,t)),uiSearch.reset(geByClass1(oo,t)),o&&o.parentNode.removeChild(o),vo(e,s,t),cancelStackFilter("im_search");var l=0===e.get().peer?"search":"default";e.get().longpoll.push([Object(d.transitionEvent)(l)]),attr(t,"aria-hidden","true")}function ho(e,t,a){return t&&(a.current_create_peer_ids={},a.current_create_peers=[]),a.current_create_peer_ids||(a.current_create_peer_ids={}),a.current_create_peers||(a.current_create_peers=[]),e.forEach(e=>{e.then(e=>{e=e.filter(e=>!a.current_create_peer_ids[e.peerId]),a.current_create_peer_ids=e.reduce((e,t)=>(e[t.peerId]=!0,e),a.current_create_peer_ids),a.current_create_peers=a.current_create_peers.concat(e)})}),Promise.resolve(a)}function fo(e,t){toggleClass(e,"im-create_material",t)}function vo(e,t,a){var n=geByClass1("_im_confirm_creation",a),r=t.get().selection.length,i="add_member"===e.get().creationType,s=uiSearch.getFieldEl(geByClass1(so,a)),o=r>0,l=(s?s.value.trim():"").length>0,c=!o&&(i||!l),d=i?1===r?Object(fa.getLang)("mail_append_chat"):Object(fa.getLang)("mail_im_create_chat_with"):l||r>1?Object(fa.getLang)("mail_im_create_chat"):Object(fa.getLang)("mail_im_go_to_dialog");val(n,d),toggleClass(n,"button_disabled",c)}function Oo(e,t,a,n,r,i,s){if(s){var o,l=intval(domData(s,"list-id")),c=Co(i),d=trim(s.textContent),u=geByClass1(oo,t),g=getSize(u)[1];inArray(l,c)?(o=n.removeSelection(l,d),removeClass(s,"olist_item_wrap_on")):(o=n.addSelection(l,d),addClass(s,"olist_item_wrap_on")),o.then(()=>{var e=g-getSize(u)[1],t=r.scrollTop();r.scrollTop(t-e)}),vo(e,i,t);var m=geByClass1(oo,t);uiSearch.reset(m)}}function yo(e,t){var a=Co(e),n=["_im_dialog","_im_dialog"+t.peerId,"im-creation--item"],r=[];return t.online&&r.push("online"),mobPlatforms[t.online]&&r.push("mobile"),inArray(t.peerId,a)&&n.push("olist_item_wrap_on"),getTemplate("im_owner_item",{owner_id:t.peerId,cls:" "+n.join(" "),photo:t.photo,name:t.name,link:t.href,img_cls:r.join(" ")})}function jo(e){return Object(i.getSearchText)(e)||!1}function Co(e){return e.get().selection.map(e=>e.id)}function wo(e,t,a){return e.then(e=>e.filter(e=>e.is_friend&&!inArray(e.peerId,a.get().creationFilter)))}function Eo(e,t,a,r,i){var s,o,l=geByClass1(oo,e),c=Object(n.searchLocalHints)(r,t.get()),d=a.hoverFirstElement.bind(a,lo,Po(t));t.get().creation_shown_all=!1,a.reset(),a.pipe(wo(c,0,t),r),a.toTop(),r?(o=Object(n.searchTopConv)(r,t.get()),s=Object(n.searchHintsIndex)(r,[],"friends",t.get()),a.pipe(wo(s,0,t),r).then(d),a.pipe(wo(o,0,t),r).then(d)):(s=Promise.resolve([]),o=Promise.resolve([])),t.set(ho.bind(null,[c,o,s],!0)),uiSearch.showProgress(l),Promise.all([c,s,o]).then(()=>uiSearch.hideProgress(l))}function To(e,t,a,r){var i=2e9+Math.round(rand(1e6,2e6));cur.recieveCropResult=a=>{cur.recieveCropResult=!1,curBox()&&curBox().hide(),e.set(n.presetAvatar.bind(null,a)),Object(n.getOwnerPhoto)(a,i).then(e=>{geByClass1("_im_create_avatar",t).appendChild(ce("img",{className:"im-chat-placeholder--img _im_avatar_img",src:e}))}),addClass(t,"im-create_photo-attached")},Page.ownerPhoto(i)}function So(e,t){geByClass1("_im_create_avatar",t).innerHTML="",e.set(n.presetAvatar.bind(null,!1)),removeClass(t,"im-create_photo-attached")}function Io(e,t,a,n,r,i){Co(t).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>removeClass(e,"olist_item_wrap_on")),t.reset(),Eo(a,e,n,!1,Co(t)),r.resetSelection(),bo(e,a,i,0,r,t)}function ko(e,t,a,r,s,o,l){var c=Co(t),u=e.get(),g=geByClass1("_im_confirm_creation",a),m=uiSearch.getFieldEl(geByClass1(so,a)).value,p="add_member"===e.get().creationType,_=!p&&(m.length||c.length>1),b=geByClass1("_im_creation_show_history_input",a).checked;if(p)return e.set(n.addNewMember.bind(null,u.peer,c,b)).catch(e=>Object(lt.showFastBox)(Object(fa.getLang)("global_error"),e)),bo(e,a,o,0,s,t);if(Object(ro.lockButton)(g),!_)return h(c[0]);function h(n){co=0,Io(e,t,a,r,s,o),function(e,t,a,n,r,i){bo(e,t,a,0,r,i),e.get().longpoll.push([Object(d.changePeer)(n,!1,!1,!1,"create_conversation")])}(e,a,o,n,s,t),Object(ro.unlockButton)(g),Object(i.isSearching)(e)?o().cancelSearch(e):o().restoreDialogs(e)}e.set(e=>Object(io.createChatAction)(e,u.next_chat_avatar,c,m,co)).then(()=>h(u.next_peer)).catch(e=>{Object(ro.unlockButton)(g),topMsg(Object(fa.getLang)("global_unknown_error"),2,"#FFB4A3")})}function Mo(e,t){return Object(U.showTooltip)(e,{text:Object(fa.getLang)("mail_cancel"),black:1,zIndex:1e3,shift:[3,-2],appendCls:"js-im-page"})}function Po(e,t){var a=t&&t.get().selection.length;return{top:-1,bottom:Object(r.isClassicInterface)(e)?a>0?69:0:-1}}function Lo(e,t,a){vo(e,t,a)}function Ao(e,t,a,n,r,i,s,o){return{show(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.setState({shown:!0}),fo(e,!0),cancelStackPush("im_create",s),addClass(e,"im-create_shown");var o=n.get().selection.reduce((e,t)=>(e[t.id]=!0,e),{});i&&i.forEach(t=>{if(!o[t[0]]){var a=e.querySelector("._im_dialog"+t[0]);r.addSelection(t[0],t[1]),a&&!a.classList.contains("olist_item_wrap_on")&&a.classList.add("olist_item_wrap_on")}}),function(e,t,a,n){toggleClass(e,"im-create_chat","chat"===n.get().creationType),toggleClass(e,"im-create_invite","add_member"===n.get().creationType);var r="chat"===n.get().creationType?Object(fa.getLang)("mail_im_group_dialog"):Object(fa.getLang)("mail_im_friends_tab"),i=geByClass1("_im_create_title",e);val(i,r),val(geByClass1("_im_confirm_creation",e),"add_member"===n.get().creationType?Object(fa.getLang)("mail_im_create_chat_with"):Object(fa.getLang)("mail_im_create_chat")),Eo(e,n,t,!1,a.get().selection.map(e=>e.id))}(e,a,n,t),setTimeout(()=>{t.get().longpoll.push([Object(d.transitionEvent)("create")]),attr(e,"aria-hidden","false"),r.focus()},1)},focusSearch(e){r.focus()},confirmCreate(e){o()},hide(a){a.get().shown=!1,bo(a,e,t,0,r,n)},scroll(e){a.scrollPage(e,!0)},updateScroll(){a.updateScroll()},selectElement(t){Oo(t,e,0,r,a,n,a.getHoveredElement())},hoverPrevElement(e){a.hoverPrevElement(lo,null,Po(e,n))},hoverNextElement(e){a.hoverNextElement(lo,null,Po(e,n))},unmount(){Object(c.destroyModule)(i),a.unmount(),r.unmount(),cancelStackFilter("im_create"),cur.recieveCropResult=void 0}}}function Do(e,t,a){var r=Object(b.default)({selection:[]}),i=x(geByClass1("_im_create_list",e),Object(b.default)({offset:0,limit:100,elements:[],elCls:"_im_dialog"}),()=>({idFn:e=>intval(e.peerId),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:yo.bind(null,r),more(e,a){var i;return t.get().shown?(t.get().creation_shown_all||!1!==jo(r)?i=Promise.resolve([]):(t.get().creation_shown_all=!0,i=Object(n.searchTopConv)(jo(r),t.get())),t.set(ho.bind(null,[i],!1)),wo(i,jo(r),t)):Promise.resolve(!1)},onClick(a,n){checkEvent(a)||(Oo(t,e,0,d,i,r,n),cancelEvent(a))}}));t.get().creationQuery=!1,t.get().creationType="chat";var s=geByClass1(oo,e),o=Object(ra.debouncedPromise)(a=>function(e,t,a,n){var r=n.get(),i=jo(r);r.selection.map(e=>e.id),a.unhoverElements(lo),e.get().creationQuery=i,Eo(t,e,a,i)}(t,e,i,a),300),d=no(s,r,()=>({selectionDeleted(a,n){vo(t,a,e),removeClass(geByClass1("_im_dialog"+n),"olist_item_wrap_on")},onChange:o})),u=bo.bind(null,t,e,a,"cross",d,r),g=To.bind(null,t,e),m=So.bind(null,t,e),p=Io.bind(null,t,r,e,i,d,a),_=ko.bind(null,t,r,e,i,d,a),h=Lo.bind(null,t,r,e),f=uo.bind(null,e),v=geByClass1("_im_create_cancel",e),O=geByClass1(so,e),y=geByClass1("_im_creation_settings",e),j=O.querySelector(".ui_search_reset"),C=Object(c.createModule)({handlers:(t,a)=>{t(v,"click",u),t(v,"mouseover",Mo.bind(null,v)),t(geByClass1("_im_create_avatar",e),"click",g),t(geByClass1("_im_create_remove_avatar",e),"click",m),t(geByClass1("_im_cancel_creation",e),"click",p),t(O,"change",h),t(O,"input",h),t(O,"paste",h),t(j,"click",h),t(geByClass1("_im_confirm_creation",e),"click",_),t(y,"click",f),t(y,"mouseenter",_o.bind(null,y)),t(e,"mouseover",Object(l.throttle)(i.unhoverElements.bind(i,lo),100))}});return Ao(e,a,i,r,d,C,u,_)}var Bo=a("1MUc"),xo=a("hGJG");function No(){var e="_im_create_chat_container",t=document.getElementById(e);if(t)return t;var a=document.createElement("section");return a.id=e,document.body.appendChild(a),a}function Ro(e,t,a){return{show:a,unmount:function(){var e=No();e&&Dt.a.unmountComponentAtNode(e),Object(c.destroyModule)(t)},closeCreateConvoPopup:function(){var e=No();Dt.a.unmountComponentAtNode(e),Object(n.toggleConversation)(!1)}}}function Fo(e){var t=Object(c.createModule)({handlers:function(){}}),a=(0,Object(c.createMutations)(Ro).bindMutations)(t,e),n=function(t){var n;null===(n=e.get().longpoll)||void 0===n||n.push([Object(d.changePeer)(t,!1,!1,!1,"create_conversation")]),a.closeCreateConvoPopup()},r=function(t){var n;null===(n=e.get().longpoll)||void 0===n||n.push([Object(d.changePeer)(t,!1,!0,!0)]),a.closeCreateConvoPopup()},i=a.closeCreateConvoPopup;return Ro(0,t,(function(){return function(e,t,a,n){var r=No();Dt.a.render(Lt.a.createElement(Bo.ChatCreation,{store:e,uploadAvatar:xo.uploadConvoPhoto,onClose:t,onCreateChat:a,onGoToConvo:n}),r)}(e,i,n,r)}))}var Ho=a("9KdC");function Uo(e,t){return t.state=e,Promise.resolve(t)}function Go(e,t,a,n,i){switch(t){case _.ARROW_UP:Object(r.isEditableFocused)()||(n.scroll(i,"up"),cancelEvent(a));break;case _.ARROW_DOWN:Object(r.isEditableFocused)()||(n.scroll(i,"down"),cancelEvent(a));break;case _.PAGE_UP:a.ctrlKey||Object(r.isClassicInterface)(i)||(n.scroll(i,"up",!0),cancelEvent(a));break;case _.PAGE_DOWN:a.ctrlKey||Object(r.isClassicInterface)(i)||(n.scroll(i,"down",!0),cancelEvent(a));break;case _.HOME:Object(r.isEditableFocused)()||(n.scroll(i,"up",!1,!0),cancelEvent(a));break;case _.END_KEY:Object(r.isEditableFocused)()||(n.scroll(i,"down",!1,!0),cancelEvent(a));break;case _.PRINTABLE:n.focustTxt(e)}}function qo(e,t,a,n,i,s){var o=Object(b.default)({state:t||"default"});return{signal(t,l){if(!(cur.storyLayer||cur.articleEditorLayer||window.isArticleLayerOpen()))switch(o.get().state){case"default":return Go(o,t,l,n,e);case"fwd":case"search":return function(e,t,a,n,i,s){switch(t){case _.ARROW_DOWN:n&&n.hoverNextDialog(s),cancelEvent(a);break;case _.ARROW_UP:n&&n.hoverPrevDialog(s),cancelEvent(a);break;case _.ENTER:Object(r.isEditableFocused)()&&!gpeByClass("_im_dialogs_search_input",document.activeElement)||n&&n.selectHoveredDialog(s);break;case _.PRINTABLE:i.focusInput()}}(0,t,l,a,i,e);case"create":return function(e,t,a,n,i){switch(t){case _.PAGE_UP:!a.ctrlKey&&Object(r.isClassicInterface)(i)&&(n.scroll("up"),cancelEvent(a));break;case _.PAGE_DOWN:!a.ctrlKey&&Object(r.isClassicInterface)(i)&&(n.scroll("down"),cancelEvent(a));break;case _.ARROW_DOWN:n.hoverNextElement(i);break;case _.ARROW_UP:n.hoverPrevElement(i);break;case _.ENTER:gpeByClass("_im_dialogs_creation_name",document.activeElement)?n.confirmCreate(i):gpeByClass("im-create--search",document.activeElement)&&n.selectElement(i);break;case _.PRINTABLE:n.focusSearch(i)}}(0,t,l,s,e);case"message":return function(e,t,a,n,r){switch(t){case _.HOME:case _.END_KEY:n.isEmpty(r)&&Go(e,t,a,n,r);break;case _.PAGE_UP:case _.PAGE_DOWN:Go(e,t,a,n,r)}}(o,t,l,n,e);default:throw new Error("Unknown state: "+o.get().state)}},transition:e=>o.set(Uo.bind(null,e))}}var Ko=a("ER42"),Vo=a("nJdr"),Wo=a("V1Nw"),zo=a("ERyv");function Yo(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return $o(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return $o(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $o(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Xo={},Qo=Date.now();function Jo(e,t){var a=Math.floor(t.status/100);t.status&&e.stat&&(t.status>=500&&t.status<600&&statlogsValueEvent("im_longpoll",1,a+"0x",t.getResponseHeader("x-frontend")),Xo[a]=Xo[a]?Xo[a]+1:1,Date.now()-Qo>=3e4&&(Object.keys(Xo).forEach(e=>{statlogsValueEvent("im_longpoll",Xo[e],e+"0x",t.getResponseHeader("x-frontend"))}),Xo={},Qo=Date.now()))}function Zo(e,t){return Promise.resolve(extend({},t,{timeout:e<64?2*e:e}))}function el(e,t){return Promise.resolve(extend({},t,{imTs:e}))}function tl(e){e.set(e=>Promise.resolve(extend({},e,{stopped:!0}))).then(()=>{e.get().cancelToken()})}function al(e,t){return t.cancelToken=e,Promise.resolve(t)}function nl(e,t){return t.pauses||(t.pauses=[]),t.pauses.push(e),Promise.resolve(t)}function rl(e){return e.pauses||(e.pauses=[]),Object(l.lplog)("Aborting all pauses","error"),e.pauses.forEach(e=>e()),e.pauses=[],Promise.resolve(e)}function il(e,t,a,r){var i=r.failed?Object(ra.abortablePause)(4,e):{},s=i.abort,o=i.pause;switch(r.failed){case 1:return Object(l.lplog)("Old timestamp, init resync","error"),e.set(nl.bind(null,s)),a([N.resyncEvent()]),e.set(n.loadLongPollTs).then(o).then(sl.bind(null,e,t,a));case 2:return Object(l.lplog)("Key is incorrect","error"),e.set(nl.bind(null,s)),e.set(n.loadLongPollKey).then(o).then(sl.bind(null,e,t,a));case 3:throw Object(zo.imWeirdLog)("im_longpoll_force_reload",r,!1),nav.reload({force:!0}),new Error("ts is very wrong");default:return e.set(el.bind(null,r.ts)).then(()=>r)}}function sl(e,t,a){if(e.get().stopped)return Promise.resolve({updates:[]});if(t())return Promise.reject(new Error("pause"));var n=e.get(),r=`${n.imUrl}/${n.imPart}`,i=Object(Ko.plaingetCancelable)(r,{act:"a_check",key:n.imKey,version:14,ts:n.imTs,wait:25,mode:n.mode}),s=i.request,o=i.cancel;return e.set(al.bind(null,o)).then(()=>s).then(t=>{var a=Yo(t,2),r=a[0],i=a[1];return i&&Jo(n,i),e.set(Zo.bind(null,1)),JSON.parse(r)}).catch(e=>{var t=Yo(e,2),a=(t[0],t[1]);return a&&Jo(n,a),Promise.reject(new Error(""))}).then(il.bind(null,e,t,a))}function ol(e){var t=e.id,a=e.gid,n=e.key,r=e.ts,i=e.url,s=e.lhost,o=e.lpstat,c=new EventEmitter,d=window.vk.lpConfig&&window.vk.lpConfig.enabled&&window.longpollTesting_onImEvents,u=ba((function(e,t){return d&&window.longpollTesting_onImEvents(t),c.trigger("data",t),Promise.resolve({})})),g=u.pause,m=u.resume,p=u.pushMessage,_=u.isPaused,h=u.reset,f=Object(b.default)({id:t,gid:a,mode:202,timeout:1,imKey:n,imTs:r,imPart:i,imUrl:s,pause:!1,stat:o});return function e(t,a,n){t.get().stopped||(Object(l.lplog)("New request"),sl(t,n,a).then(e=>e.map(N.constructEvent)).then(e=>(Object(l.lplog)("Request success","success"),e)).then(a).catch(e=>{if(!t.get().stopped)return Object(l.lplog)("Error, waiting: "+(e.message||"no message (probably browser reset)"),"error"),t.set(Zo.bind(null,n()?2:t.get().timeout)).then(()=>{var e=Object(ra.abortablePause)(t.get().timeout,t),a=e.abort,n=e.pause;return t.set(nl.bind(null,a)).then(n)});Object(l.lplog)("Stopped longpoll")}).then(e.bind(null,t,a,n)))}(f,p.bind(null,"main"),_.bind(null,"main")),{onData:e=>c.on("data",e),offData:e=>c.off("data",e),abortWaiting:()=>f.set(rl),stop:tl.bind(null,f),pause:g.bind(null,"main"),resume:m.bind(null,"main"),reset:h.bind(null,"main"),push:e=>c.trigger("data",e),isEnabled:()=>!f.get().pause&&!f.get().stopped}}var ll=new Map,cl=!1;function dl(e){return e.queue||e.key}function ul(){ll.forEach((e,t)=>{var a=e.onData,n=e.onUpdateKey,r=e.ts;(function(e){return!!window.curNotifier&&!curNotifier.addQueues[dl(e)]})(t)&&Notifier.addKey(extend(t,{ts:r}),pl.bind(null,a,n,t))})}function gl(){cl||(cl=setInterval(ul,3e3))}function ml(e){!function(e){if(!window.curNotifier)return!1;delete curNotifier.addQueues[dl(e)]}(e),ll.delete(e),0===ll.size&&(clearInterval(cl),cl=!1)}function pl(e,t,a,n,r){if(r.failed)return ml(a),void function(e,t,a,n){var r;switch(e){case 1:case 2:case 3:case 5:r=n(t,e);break;case 4:r=Object(ra.pause)(1).then(()=>t);break;default:throw new Error("Unkonwn error from queue: "+e)}Object(ra.pause)(3).then(()=>r).then(e=>{ll.set(e,{onUpdateKey:n,onData:a,ts:e.ts}),ul(),gl()})}(r.err,a,e,t);ll.set(a,{onData:e,onUpdateKey:t,ts:intval(r.ts)}),r.events.map(e=>e.split("<!>")).forEach(e)}var _l=a("PEW9"),bl=Object.values(_l.ConvoListFolder);function hl(e){var t=e.get().tabbedPeers.map(t=>e.get().tabs[t.peer]||e.get().mapped_index&&e.get().mapped_index[t.peer]).filter(e=>e).filter(e=>!e.deletedDialog).map(e=>({type:"peer",peer:e.peerId}));return t.length>0&&(t=[{type:"sep"}].concat(t)),t}function fl(e,t){if("sep"===t.type)return getTemplate("im_right_menu_sep",{});var a=`${Object(r.getBaseLink)(e)}?sel=${t.peer}&tab=${e.get().active_tab}`,n=Object(r.getBareTab)(t.peer,e),i=Object(r.isContactPeer)(t.peer)?Object(r.prepareContactName)(n.tab):n.tab,s="";switch(!0){case n.unread>0:s=n.unread;break;case Object(r.isTabMarkedUnread)(n):s=1}return i=getTemplate("im_right_menu_ct",{name:i,count:s}),getTemplate("im_right_menu_tpl",{href:a,label:i,peer:t.peer,attrs:`title="${stripHTML(n.tab)}"`,cls:n.unread>0?"im-right-menu--unread":""})}function vl(e,t,a,r){var i=gpeByClass("_im_peer_tab",r),s=intval(domData(i,"list-id")),o=e.get().tabbedPeers.filter(e=>e.peer!==s);return e.set(n.updateTabbedPeers.bind(null,o,!0)).then(()=>{if(Ol(t,e),s===e.get().peer)e.get().longpoll.push([Object(d.resetPeer)()]);else if(0!==e.get().peer){var a=gpeByClass("_im_right_menu",r);uiRightMenu.hideSliding(a)}}),cancelEvent(a),!1}function Ol(e,t){return e.pipeReplace(Promise.resolve(hl(t)))}function yl(e,t,a,n){return{updateMenu(t){!function(e,t){geByClass("_im_peer_tab",e).forEach(e=>{var a=Object(wr.fromQueryString)(attr(e,"href").split("?")[1]);a.tab!==t.get().active_tab&&attr(e,"href",`${Object(r.getBaseLink)(t)}?sel=${a.sel}&tab=${t.get().active_tab}`)})}(e,t);var n=gpeByClass("_im_right_menu",e);Ol(a,t).then(()=>{var e;(e=t.get().peer?ge("ui_rmenu_peer_"+t.get().peer):ge("ui_rmenu_"+t.get().active_tab))&&uiRightMenu.switchMenu(e,!0),uiRightMenu.hideProgress(n)})},updateName(e,t){var a=ge("ui_rmenu_peer_"+e);if(a){var n=geByClass1("_im_r_tx",a),r=t.get().tabs[e].tab;val(n,r)}},updateCounter(e,t){var a=ge("ui_rmenu_peer_"+t);if(a){var n=geByClass1("_im_r_ct",a),i=Object(r.getTab)(e,t),s="";switch(!0){case i.unread>0:s=i.unread;break;case Object(r.isTabMarkedUnread)(i):s=1}val(n,s),a.classList.toggle("im-right-menu--unread",i.unread>0||Object(r.isTabMarkedUnread)(i))}},unmount(){Object(c.destroyModule)(n),a.unmount()}}}function jl(e,t,a){1===a.which&&(e.get().peer&&e.get().longpoll.push([Object(d.resetPeer)()]),e.get().longpoll.push([Object(d.changeTab)(t)]),cancelEvent(a))}function Cl(e){Object(U.showTooltip)(e.currentTarget,{text:Object(fa.getLang)("mail_admin_av_time"),dir:"bottom",needLeft:!0,typeClass:"tt_default_right RightMenuBlockInfo__averageTimeTooltip",width:210,shift:[-14,8],slide:15})}function wl(e,t,a){e.set(e=>Object(n.toggleCommunityMute)(!t,e)).then(()=>a.classList.toggle("RightMenuBlockInfo__mute--muted",e.get().mute))}function El(e,t,a){var n=x(e,Object(b.default)({limit:50,offset:0,noScroll:!0,elements:hl(t)}),()=>({idFn:e=>e.peer||"000",renderFn:fl.bind(null,t)})),i=vl.bind(null,t,n),s=geByClass1("RightMenuBlockInfo"),o=geByClass1("RightMenuBlockInfo__averageTimeHint",s),u=geByClass1("RightMenuBlockInfo__mute",s),g=Object(c.createModule)({handlers:(a,n)=>{n(e,"click","_im_r_cl",i),n(e,"click","_im_peer_tab",(e,a)=>{if(!checkEvent(e)){var n=intval(domData(a,"list-id"));Object(l.unpackStore)(t).longpoll.push([Object(d.changePeer)(n,!1,!0,!0)]),cancelEvent(e)}}),bl.forEach(n=>{a(geByClass1("_ui_item_"+n,e.parentNode),"mousedown",jl.bind(null,t,n))}),a(geByClass1("_im_contact_list_menu_item",e.parentNode),"click",()=>ms(t)),o&&a(o,"mouseover",Cl),Object(r.isCommunityInterface)(t)&&u&&a(u,"click",e=>wl(t,!1,e.currentTarget))}});return Object(r.isCommunityInterface)(t)&&u&&(wl(t,!0,u),u.classList.remove("RightMenuBlockInfo__mute--hidden")),yl(e,0,n,g)}function Tl(e){var t=e.get().tabs,a=e.get().peer,i=Object.keys(t).filter(t=>Object(r.isFullyLoadedTab)(e,t)&&intval(t)!==a).map(e=>t[e]);i.filter(e=>Date.now()-e.last_visited>54e6).forEach(t=>e.set(n.cleanTab.bind(null,t.peerId))),i.filter(t=>Object(r.isFullyLoadedTab)(e,t.peerId)&&"string"!=typeof t.history&&Date.now()-t.last_touched>72e5).forEach(t=>e.set(n.stringifyTab.bind(null,t.peerId)))}function Sl(e){var t=setInterval(Tl.bind(null,e),5e3);return{unmount(){clearInterval(t)}}}function Il(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return kl(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return kl(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function kl(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Ml(e,t,a,i){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var s=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(r.wrapLoading)(s)(Object(n.loadImportant)(e.offset).then(t=>{var a=Il(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(s,"im-important_all"):e.loading=!1,i.set(n.mergeTabs.bind(null,Object(r.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,s.appendChild(c),Object(r.ensureDomHasActions)(s)}),"bottom")}}function Pl(e,t,a){for(var r=arguments.length,i=new Array(r>3?r-3:0),s=3;s<r;s++)i[s-3]=arguments[s];i.filter(e=>inArray(e.type,[N.SET_FLAGS,N.RESET_FLAGS,N.CHANGE_PEER])).forEach(r=>{if(r.type!==N.CHANGE_PEER){if(r.flags===N.FLAG_IMPORTANT){var i=r.type===N.SET_FLAGS;e.set(n.updateFavMessage.bind(null,[r.messageId],0,i)).then(a=>{t.markImportant(r.messageId,i,e)})}}else a.hide()})}function Ll(e,t,a,n){var i=ge("box_layer_wrap"),s=t.get().longpoll,o=Object(b.default)({peer:0,longpoll:s,oCache:{},tabs:Object(r.tabFromIds)(n.msgs,n.hash)}),l=Yn(e.bodyNode,o,()=>({})),d=p(e.bodyNode,t);Object(r.ensureDomHasActions)(e.bodyNode);var u=Pl.bind(null,t,l,e);s.onData(u);var g=Ml.bind(null,{all:!1,loading:n.all,offset:n.offset},e,i,o),m=Object(c.createModule)({handlers:(e,t)=>{e(i,"scroll",g)}});return{unmount(){Object(c.destroyModule)(m),d.unmount(),l.unmount(),s.offData(u)}}}function Al(e){return e.which||e.keyCode}function Dl(e,t,a){!a||inArray(Al(a),_.UNPRINTABLE_KEYS)||Object(n.isSearchingInplace)(e.get().peer,e.get())||Object(r.isEditableFocused)()||a.ctrlKey||browser.mac&&a.metaKey||a.key&&1!==a.key.length||t.signal("printable",a)}function Bl(e,t,a){Al(a)===_.ENTER&&e.signal(Al(a),a)}function xl(e,t,a,n){var i=Al(n);if(!layers.visible){if(i>=49&&i<=57&&(n.ctrlKey||n.metaKey&&browser.mac)&&Object(r.isClassicInterface)(t))return function(e,t){var a=e.get().tabbedPeers[t];a&&e.get().longpoll.push([Object(d.changePeer)(a.peer,!1,!0,!0)])}(t,i-49),cancelEvent(n);inArray(i,_.UP_DOWN_CONTROLS)&&e.signal(i,n)}}function Nl(e,t){var a=browser.mozilla?"keydown":"keypress",n=Object(b.default)({signalTimer:!1}),r=Dl.bind(null,e,t),i=xl.bind(null,t,e,n),s=Bl.bind(null,t,n),o=Object(c.createModule)({handlers:(e,t)=>{e(document,"keydown",i),e(document,"keyup",s),e(document,a,r)}});return{unmount(){Object(c.destroyModule)(o)}}}function Rl(e,t){return-1===(e?e.indexOf(t):0)&&(e.push(t),!0)}function Fl(e,t){var a=e?e.indexOf(t):-1;return-1!==a&&(e.splice(a,1),!0)}function Hl(e,t,a,s,o,l){var c=Object(i.getTab)(e,t);switch(a){case N.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED:case N.MAIL_CHAT_UPDATE_TYPE_ADMIN_KICKED:return a===N.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED?Rl(c.adminIds,s):Fl(c.adminIds,s),e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{Ul(e,t,o),Gl(e,t,o,l)}),!0;case N.MAIL_CHAT_UPDATE_TYPE_FLAGS_CHANGED:return c.data.flags=s,e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{Ul(e,t,o),Gl(e,t,o,l)}),!0;case N.MAIL_CHAT_UPDATE_TYPE_PINNED:delete c.pinHideId,cur.imDb.update(mr.PIN_HIDDEN_ID_OP,[c.peerId,void 0]);var d=c&&c.pinned&&Object(r.parserMessage)(c.pinned).messageId;return o.removeUnpinnedMessageEditable(e,d),!1;case N.MAIL_CHAT_UPDATE_TYPE_USER_JOINED:var u=s===vk.id;return function(e,t,a){if(Object(r.isTabLoaded)(a.get(),e)){var s=Object(i.getTab)(a,e);Rl(s.memberIds,t)&&s.membersCount++,-1===s.data.active.indexOf(t)&&s.data.active.push(t),t===vk.id&&(s.data.kicked=0,s.data.closed=0)}return a.set(a=>Object(n.loadChatMember)({[e]:[t]},a))}(t,s,e).then(()=>{if(u&&e.get().peer===t)return e.set(e=>Object(n.getPinnedMessage)(t,e))}).then(()=>Gl(e,t,o,l)).then(()=>{if(u&&e.get().peer===t)return Promise.all([e.set(e=>Object(n.getPeerActiveCallData)(t,e)),e.set(e=>Object(n.loadKeyboard)(t,e))])}).then(()=>(e.get().peer===t&&c.callInProgress&&(o.updateBanner(e),o.updateHeader(e)),o.fixKeyboard())),!0;case N.MAIL_CHAT_UPDATE_TYPE_USER_LEFT:case N.MAIL_CHAT_UPDATE_TYPE_USER_KICKED:return function(e,t,a,s,o){if(Object(r.isTabLoaded)(s.get(),e)){var l=Object(i.getTab)(s,e);Fl(l.memberIds,t)&&l.membersCount--,l.data.active=l.data.active.filter(e=>e!==t),t===vk.id&&(a?l.data.kicked=1:l.data.closed=1,s.set(t=>Object(n.removePeerActiveCallData)(e,t)))}return t===vk.id&&s.get().peer===e?(o.cancelEditing(),s.set(t=>Object(n.unpinMessageOptimistic)(e,t))):Promise.resolve()}(t,s,a===N.MAIL_CHAT_UPDATE_TYPE_USER_KICKED,e,o).then(()=>Gl(e,t,o,l)),e.get().id!==s&&(Object(i.getKeyboard)(e,t)||{}).author_id!==s||e.set(e=>Object(n.deleteKeyboard)(t,e)).then(()=>o.fixKeyboard()),!0;case N.MAIL_CHAT_UPDATE_TYPE_BANNER_CHANGED:return e.set(e=>Object(n.loadBanner)(t,e)).then(()=>o.updateBanner(e)),!0;case N.MAIL_CHAT_UPDATE_TYPE_KEYBOARD_CHANGED:case N.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:return!0;case N.MAIL_CHAT_UPDATE_TYPE_CALL_IN_PROGRESS_CHANGED:var g=s?e=>Object(n.getPeerActiveCallData)(t,e):e=>Object(n.removePeerActiveCallData)(t,e);return e.set(g).then(()=>{e.get().peer===t&&(o.updateBanner(e),o.updateHeader(e)),l.updateDialog(t,e)}),!0;default:return!1}}function Ul(e,t,a){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateActions(e))}function Gl(e,t,a,r){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateChat(e,t),r.updateDialog(t,e))}var ql=a("gF8j"),Kl=a("ambf"),Vl=a("pdqG");function Wl(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||zl(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function zl(e,t){if(e){if("string"==typeof e)return Yl(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(a):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?Yl(e,t):void 0}}function Yl(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function $l(e,t,a,s,o){var l,c=new Map,d=new Map,u=function(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=zl(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw r}}}}(o);try{for(u.s();!(l=u.n()).done;){var g=l.value;c.has(g.peerId)||c.set(g.peerId,new Set),c.get(g.peerId).add(g.messageId),d.set(g.messageId,g)}}catch(e){u.e(e)}finally{u.f()}c.forEach((o,l)=>{var c=[...o],u=Object(i.getTab)(e,l),g=u&&!u.offset,m=u&&u.inplaceSearch&&!!u.searchOffset;e.set(n.removeMessages.bind(null,c,l)).then(()=>e.set(n.removeMessagesMarkDeleted.bind(null,c,l))).then(()=>{if(e.get().peer===+l&&Object(r.isFullyLoadedTab)(e.get(),l)){var a=Object(i.getTab)(e,l);t.removeMessages(c,+l,e);var s=a.inplaceSearch;if(!a.offset&&!g&&(Object(n.setActions)(e.get()),t.updateActions(e),s||t.showEmptyScreen()),s&&m&&!a.searchOffset&&(t.showSearchResults(),browser.safari)){var o=geByClass1("_im_peer_history_w");o.style.display="none",setTimeout(()=>o.style.display="",0)}}}).then(()=>{var r=Object(i.getTab)(e,l);if(r){var o=c.some(e=>e>=r.lastmsg),u=c.filter(e=>e>r.in_up_to&&!(d.get(e).flags&N.FLAG_OUTBOUND));o?Object(n.loadActualLastMessage)(e,+l).then(()=>{a.promoteDialog(e,l),s&&s.updateCounter(e,l),t.updateGoToEnd(e,!0),t.updateGoToMention(e,!0)}):u&&Object(Vl.removeDeletedUnreadMsgsFromTab)(l,u,e.get()).then(()=>a.updateDialog(l,e))}})})}function Xl(e,t){"spam"===t?Object(r.showSpamLayer)(e,Ns,{}):"fav"===t&&Object(r.showFavvedBox)(e,{},Ll,{})}function Ql(e,t,a,i,s){e.forEach(e=>{switch(e.kludges.source_act){case r.CHAT_PHOTO_REMOVE:case r.CHAT_PHOTO_UPDATE:!function(e,t,a,r){t.set(n.updateChatPhoto.bind(null,e)).then(()=>{var n=e.kludges.source_act;a.updateDialog(e.peerId,t),r.updateChatPhoto(e,n,t)})}(e,t,a,i)}})}function Jl(e,t){var a=e.get().longpoll.push.bind(null,[Object(d.resetPeer)()]),n=()=>{var r=e.get().selectedMessages;r&&r.length?(e.setState({selectedMessages:[]}).then(()=>{t.changedMessageSelection(e),t.cleanSelection(r)}),setTimeout(()=>cancelStackPush("im_peer",n),0)):a()};cancelStackPush("im_peer",n)}function Zl(e){var t=e.attaches.filter(e=>"sticker"!==e.type&&"call"!==e.type);return Object(s.isServiceMsg)(e)||0===t.length}function ec(e,t,a){addClass(a,"im-page_history-show"),t.loadingPeer(e)}function tc(e,t){var a=Object(r.getRightMenuMaxItems)(e,t.offsetHeight);if(e.get().tabbedPeers.length>a){var i=e.get().tabbedPeers.filter(t=>{var a=t.peer;return intval(a)!==e.get().peer}).map(t=>{var a=t.peer;return e.get().tabs[a]}).sort((e,t)=>t.last_touched-e.last_touched),s=[];0!==e.get().peer&&s.push(e.get().tabs[e.get().peer]);var o=s.concat(i).slice(a).map(e=>e.peerId),l=e.get().tabbedPeers.filter(e=>!inArray(e.peer,o));return e.set(n.updateTabbedPeers.bind(null,l,!0))}return Promise.resolve(e)}function ac(){for(var e=curBox();e;)e.hide(),e=curBox()}function nc(e,t,a,s,o,l,c,d,u){e.get().audio_msg.isRecording&&e.set(n.cancelRecording).then(()=>{s.cancelRecording()}),AudioMessagePlayer.detachPlayer(),Object(i.isAnyMessageBeingEdited)(e)&&s.cancelEditing(),Object(i.isSearching)(e)&&t.cancelSearch&&(o.clearSearch(e),a.restoreDialogs(e),u().toggleSettingsButton(e,!1)),rc(e,d,u),ec(e,s,l);var g=e.get().peer;Object(n.updateMentions)(e.get()),Object(n.videoAutoPlayHandler)(),Object(r.isFullyLoadedTab)(e,t.peerId)&&(t.msgid&&!Object(i.getMessage)(e,t.peerId,t.msgid)||!t.msgid&&!Object(i.getMessage)(e,t.peerId,Object(i.getTab)(e,t.peerId).lastmsg)||Object(i.getTab)(e,t.peerId).skipped)&&e.mutate(e=>Object(i.makeTabNotFullyLoaded)(e,t.peerId));var m=e.set(n.changePeer.bind(null,t.peerId,t.msgid,t.entryPoint)).then(e=>{var a=e.get(),r=n.loadPeer.bind(null,t.peerId,!1,t.msgid,!1,a);return a.tabs[t.peerId]?Promise.resolve(a):e.set(r)}).then(()=>{a.selectPeer(t.msgid,e),function(e,t){Object(r.isPendingForward)(e)&&(cancelStackFilter("forward"),e.set(n.forwardMessages.bind(null,e.get().pendingForward,Object(i.getTabDraft)(Object(i.getTab)(e,t)),!1)))}(e,e.get().peer),window.tooltips&&tooltips.hideAll(),ac(),s.preparePeer(e),Jl(e,s),Object(r.isClassicInterface)(e)&&(a.deactivate(),tc(e,l).then(()=>c.updateMenu(e)),Object(r.updateMessageRequestsCounterInDOM)(e))});return(m=t.msgid?m.then(()=>e.set(n.selectPeerOnMessage.bind(null,t.peerId===g,g))):m.then(()=>e.set(n.selectPeer.bind(null,!0)))).then(()=>e.set(n.prepareCasperMessagesFromMessages.bind(null,t.peerId))).then(()=>{if(e.get().peer===t.peerId){if(t.forward){var a=e.get().tabs[e.get().peer];if(!a.scrollBottom&&a.unread)(Object(Er.partConfigEnabled)("mail_history_unread_counter_observer")?Promise.resolve():e.set(n.readLastMessages.bind(null,e.get().peer))).then(()=>e.set(n.setActions)).then(()=>s.updateActions(e));else!a.unread&&Object(i.isTabMarkedUnread)(a)&&e.set(e=>Object(n.markDialogRead)(t.peerId,e))}Object(r.isClassicInterface)(e)&&c.updateMenu(e),s.changePeer(e,!1),s.updateTyping(t.peerId,e),s.removeExpiredFailedMessages(t.peerId),Object(Er.partConfigEnabled)("mail_history_unread_counter_observer")&&s.updateObserver(),Object(n.updateMentions)(e.get())}}).catch(e=>Object(zo.imWeirdCatch)("applyNewPeer",e))}function rc(e,t,a){t&&e.get().shown&&(t.hide(e),a().createCanceled(e))}function ic(e,t,a){Object(i.isSearching)(e)&&(t.clearSearch(e),a.restoreDialogs(e))}function sc(e,t,a,i,s,o,l){e.setState({isCreating:!0}),Object(Er.partConfigEnabled)("messages_chat_creation_new_interface")?Fo(e).show():(Object(r.isClassicInterface)(e)&&(s.saveScroll(e),o.saveScroll(e)),i.showCancelControl(),addClass(l,"im-page_creating"),a&&a.show(e,t),Object(r.isClassicInterface)(e)&&(setStyle(l,{height:mc(l,e).page}),setTimeout((function(){addClass(l,"im-page_cropped")}),200))),Object(n.toggleConversation)(!0)}function oc(e,t,a,n){Object(r.isTabLoaded)(e.get(),n)&&(t.updateTyping(n,e),a.updateTyping(n,e))}function lc(e,t,a,i,s){i.activityType||(i.activityType=s);var o=e=>oc(e,t,a,i.peerId);Object(r.isSelfMessage)(i.peerId,e.get().gid)||(e.set(n.setActivity.bind(null,i,s)).then(o),e.set(n.waitActivity.bind(null,i,s)).then(o))}function cc(e,t){t?e.classList.add("im-page_reconnecting"):e.classList.remove("im-page_reconnecting")}function dc(e,t,a){var r=null;if(a.kludges.keyboard&&!a.kludges.keyboard.inline){var o=Object.assign(a.kludges.keyboard,{author_id:a.userId});r=e.set(n.setKeyboard.bind(null,a.peerId,o))}else{var l=Object(i.getKeyboard)(e,a.peerId);l&&l.one_time&&l.author_id!==Object(s.getAuthorId)(e,a)&&(r=e.set(n.deleteKeyboard.bind(null,a.peerId)))}a.peerId===Object(nt.getPeer)(e)&&r&&r.then(t.fixKeyboard)}function uc(e,t,a,l,u,g,m,p,b,h,f,v,O,y,j,C,w,E,T,S,I,k){var M=!1;return{changePeer(e,a){t.selectPeer(e,a)},cancelSearch(e){ic(e,l,t)},loadingPeer(e){ec(e,a,u)},restoreDialogs(e,a,n){t.restoreDialogs(e,a,n)},showChatInvitationBox(e,a){Object(r.showChatInvitationBox)(e,a,b,t)},toggleSettingsButton(e,t){f.toggleButton(e,t)},focusSearch(e){l.focusInput()},appendSearch(e,a,n,r){t.appendSearch(e,a,n,r)},appendDialogs(e,a){t.appendDialogs(e,a)},showCreation(e,n){sc(e,n,h,l,t,a,u)},showCreationNew(){Fo(v).show()},updateState(e,n){t.updateDialog(e,n),n.get().peer===e&&a.updateChat(n,e)},updateConvoInList(e,a){t.promoteDialog(a,e)},appendFastDialogs(e,a){t.appendFastDialogs(e,a,!0)},createCanceled(e){l.hideCancelControl(),Object(r.isClassicInterface)(e)?(setStyle(u,{height:"auto"}),removeClass(u,"im-page_cropped"),setTimeout(()=>l.focusInput(),0),0===e.get().peer?t.restoreScroll(e):a.restoreScroll(e,e.get().peer)):setTimeout(()=>{0===e.get().peer?l.focusInput():a.focustTxt(e)},0),removeClass(u,"im-page_creating"),e.setState({isCreating:!1})},updateMenu(e){C&&C.updateMenu(e)},goToHistoryEnd(){a.goToEnd()},updateDialog(e,a){t.updateDialog(e,a)},focusTxt(e){a.focustTxt(e)},resync(e){Object(i.isSearching)(e)&&l.clearSearch(e),t.restoreDialogs(e,!0,!0).then(()=>{Object(r.isClassicInterface)(e)||t.focusOnSelected(e)}),h&&h.hide(e),Object(r.isCommunityInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a)}),Object(r.isClassicInterface)(e)&&(e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a),C.updateName(a,e)}),Object(r.updateMessageRequestsCounterInDOM)(e)),a.cleanSelection(e.get().selectedMessages||[]),a.cancelSearch(e,!0),Object(r.isReservedPeer)(e.get().peer)||a.changePeer(e,!1),Object(Us.updateUnreadCounter)(e)},toggleSettingsLoader(e,t){f.toggleLoader(e,t)},onUserActions(e,t){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())){var s,o=e.get(),l=o.peer;if(Object(r.isFullyLoadedTab)(o,l))if(!g.is_idle)if(Object(i.countUnread)(e.get().peer,e.get())>0)if(!o.tabs[l].skipped&&a.isNewMessagesVisible(e))a.hideGoToEnd(!0),a.hideGoToMention(!0),Object(Er.partConfigEnabled)("mail_history_unread_counter_observer")?(a.updateObserver(),s=Promise.resolve()):s=e.set(n.readLastMessages.bind(null,l)),s.then(()=>e.set(n.setActions)).then(()=>a.updateActions(e))}},removeSelection(e){t.removeSelection(e),l.focusInput()},route(e,i,s,o){if(void 0!==e[0])return!0;e.box&&(e={box:e.box});var c=!1;return!!(e.mr||e.invite_chat_id&&s.invite_hash)||(o&&o.params&&"left_nav"===o.params._ref&&void 0===e.sel&&t.scrollUp(!0,!0),Object.keys(e).sort().forEach(e=>{switch(e){case"sel":s.q||(c=!0);var g=s.sel?Object(r.unUrlPeer)(s.sel):0,m=o.back;0===g?v.get().longpoll.push([Object(d.resetPeer)(!1,m)]):g!==v.get().peer&&v.get().longpoll.push([Object(d.changePeer)(g,s.msgid||!1)]);break;case"invite_chat_id":case"invite_hash":!function(e){e.set(n.leaveInvitation).then(()=>{e.get().longpoll.push([Object(d.resetPeer)(!1,!1)])})}(v);break;case"tab":rc(v,h,b),c=!0;var p=s.tab||_.FOLDER_ALL;v.get().longpoll.push([Object(d.changeTab)(p)]);break;case"act":s.act&&"create"===s.act?sc(v,[],h,l,t,a,u):function(e,t,a,n){a&&a.hide(e,t)}(v,[],h);break;case"st":s.st&&s.sel?(curBox()&&curBox().hide(),v.mutate(n.setInplaceSearch.bind(null,unescape(s.st),s.sel)),a.startSearch(v)):(v.mutate(n.cancelSearch.bind(null,i.sel)),a.cancelSearch(v,!0));break;case"q":s.q?(curBox()&&curBox().hide(),l.setSearch(v,s.q,!0)):l.clearSearch(v);break;case"box":Xl(v,s.box)}}),s.msgid&&(v.get().msgid=s.msgid,a.focusOnMessage()),Object(r.isClassicInterface)(v)&&void 0===e.sel&&C.updateMenu(v),c&&ic(v,l,t),!1)},updateDialogFilters(e){Object(i.isSearching)(e)||t.restoreDialogs(e),f.updateFilter(e)},removePeer(e,a){t.removeDialog(e,a),t.saveScroll(e),e.get().peer===a&&e.get().longpoll.push([Object(d.resetPeer)()]),Object(r.isClassicInterface)(e)&&C.updateMenu(e)},newMessage(e){Object(r.isClassicInterface)(e)||t.scrollUp(!0)},onQueueEvent(e,i){switch(i.entity_type){case Ho.EntityType.Online:e.set(e=>Object(n.updateOnline)(i.data.user_id,!!i.data.online&&i.data.platform,i.data.last_seen,e)).then(e=>{Object(r.isTabLoaded)(e.get(),i.data.user_id)&&(t.updateOnline(i.data.user_id,e),a.updateOnline(i.data.user_id,e))})}},onEvents(e,c){var v=Object(d.compactCounterEvents)(c),y=c.filter(s.isServiceMsg),j=c.filter(e=>e.type===N.ADD_MESSAGE);Ql(y,e,t,a);var w=Object(n.checkNewPeople)(y,j,e),E=Promise.resolve();w.shouldLoad&&(E=e.set(n.loadNewPeople.bind(null,w,m))),E.then(()=>{v.forEach(c=>{switch(c.type){case N.ADD_MESSAGE:var m=c.peerId,v=Object(i.getTab)(e,m),y=!v||!v.msgs||0===v.msgs.length,j=Object(r.getMessageStoreStatus)(c,e.get()),w=Object(i.isCommunityBlocked)(e,c.peerId),E=v&&!v.lastmsg;switch(dc(e,a,c),Object(s.isCasperMessage)(c)&&Kl.casperMessagesStore.add(c),j){case r.MSG_NEW:e.set(n.addMessage.bind(null,c)),tc(e,u),function(e,t){var a=e.get().tabs[t.peerId],r=e.get().active_tab;return r===_.FOLDER_ALL||(r===_.FOLDER_PEER_TAGS?Object(o.applyPeerTagsFilterToTab)(e.get(),a):Object(n.filterFromTab)(r)(a))}(e,c)&&(Object(i.tabIsMessageRequest)(v)||(c.flags&N.FLAG_OUTBOUND||e.set(n.updateFavAndTitle.bind(null,c.peerId,!0)),function(e,t){var a=t.flags&N.FLAG_OUTBOUND,n=inArray(t.peerId,e.get().mutedPeers),i=t.flags&N.FLAG_DELETED,s=e.get().gid;if(!a&&!n&&!i){var o,l,c=function(e,t){return t<2e9&&e&&!e.match(/^\s*(Re(\(\d*\))?\:)?\s*\.\.\.\s*$/)}(t.subject,t.peerId)||"",d=(c?c+" ":"")+t.text||"",u=t.userId,g=t.peerId,m=e.get().tabs[g];if(t.kludges&&t.kludges.source_act&&(d=stripHTML(Object(r.renderServiceMsg)(e,t,m.peerId,!1))),(!e.get().notify_msg&&!Object(r.isChatPeer)(g)||s&&!e.get().mute)&&window.Notifier&&Notifier.playSound({author_id:g}),!Object(r.isChatPeer)(g))return;d=trim(replaceEntities(stripHTML(d.replace(/<br>/g,"\n").replace(/<\*>.*$/,"")))),d=Object(pr.replaceMentions)(d,(e,t,a,n,r)=>r),Object(r.isChatPeer)(g)?(o=Object(F.oCacheGet)(e,u).name,m.tab&&(o+=" » "+m.tab),l=Object(F.oCacheGet)(e,u).photo):(o=m.tab,l=m.photo);var p=t.attaches[0];if(p&&"mail"===p.type)d+="\n["+getLang("mail_added_msgs")+"]";else if(p){var _="doc"===p.type&&"graffiti"===p.kind?"graffiti":p.type;d+="\n["+getLang("mail_added_"+_)+"]"}o=trim(replaceEntities(stripHTML((o||"").replace("&nbsp;"," ")))),window.Notifier&&Notifier.proxyIm({id:t.messageId,text:d,author_id:g,title:o,author_photo:l})}}(e,c)),t.updateTyping(c.peerId,e),Object(i.isSearching)(e)?t.updateDialog(c.peerId,e):t.promoteDialog(e,c.peerId));var T=Object(i.isCommunityBlocked)(e,c.peerId),I=v&&!v.offset;(w&&!T||E&&!I)&&a.updateActions(e),Object(r.isClassicInterface)(e)?(C.updateCounter(e,c.peerId),C.updateMenu(e)):f.updateFilter(e),e.set(n.updateActivity.bind(null,c)).then(oc.bind(null,e,a,t,c.peerId)),a.addMessage(e,c),Zl(c)||!Object(r.isFullyLoadedTab)(e,c.peerId)||c.local||e.set(n.loadMedia.bind(null,c)).then(e=>{a.replaceAttachmentPlaceholders(e,c),Object(n.videoAutoPlayHandler)()}),Object(tt.statlogsSendingTimeStart)(e,c,"send","opt_to_lp");break;case r.MSG_LOCAL_DUPLICATE:Zl(c)||e.set(n.loadMedia.bind(null,c)).then(e=>{a.replaceAttachmentPlaceholders(e,c)}),e.set(n.replaceMessage.bind(null,c)),a.replaceMessageAttrs(c,e),t.updateDialog(c.peerId,e),c.randomId&&Object(tt.statlogsSendingTimeEnd)(e,c,"send","opt_to_lp");break;case r.MSG_DUPLICATE:Object(i.isSearching)(e)||t.promoteDialog(e,c.peerId)}Object(i.tabIsMessageRequest)(v)&&Object(r.checkMessageRequestsTab)(e,t.update);var k=j===r.MSG_LOCAL_DUPLICATE&&1===v.offset||j===r.MSG_NEW&&E&&!c.local;Object(Er.partConfigEnabled)("messenger_empty_pinned_support")&&k&&e.set(t=>Object(n.loadPeer)(m,0,0,0,t).then(t=>(Object(Vl.updateListedConvos)(t,Object(i.getTab)(t,m),!1,n.addDialog.bind(null,m),n.shouldIncludeDialog.bind(null,t)),m===e.get().peer?Object(n.setActions)(t):t))).then(e=>t.promoteDialog(e,m)),v&&y&&v.peerId===Object(nt.getPeer)(e)&&S();break;case N.EDIT_MESSAGE:case N.REPLACE_MESSAGE:e.set(n.editMessage.bind(null,c)).then(e=>{if(dc(e,a,c),c.kludges.is_expired)return Object(r.removeExpiredMessageIfNeed)(c,a.handleMessageExpiration),void t.updateDialog(c.peerId,e);t.updateDialog(c.peerId,e),a.updateTyping(c.peerId,e),a.editMessage(e,c),Zl(c)||!Object(r.isFullyLoadedTab)(e,c.peerId)||c.local||e.set(n.loadMedia.bind(null,c)).then(e=>a.replaceAttachmentPlaceholders(e,c))});break;case N.INVALIDATE_MESSAGE:Object(n.reloadMessage)(c.messageId,e.get()).then(t=>{var a=Object(G.getMessageFromTuple)(t);return e.set(e=>Object(n.editMessage)(a,e)).then(()=>a)}).then(i=>{a.editMessage(e,i),t.updateDialog(i.peerId,e),!Zl(i)&&Object(r.isFullyLoadedTab)(e,i.peerId)&&e.set(e=>Object(n.loadMedia)(i,e)).then(e=>a.replaceAttachmentPlaceholders(e,i))});break;case N.READ_INBOUND:e.set(n.markInboundMessagesAsRead.bind(null,c)).then(e=>{t.updateCounter(e,c.peerId),a.updateGoToEnd(e,!0),a.updateGoToMention(e,!0),a.updateObserver(),Object(r.isClassicInterface)(e)&&C.updateCounter(e,c.peerId),Object(i.isSearching)(e)||t.restoreDialogs(e),f.updateFilter(e)});break;case N.READ_OUTBOUND:e.set(n.markOutboundMessagesAsRead.bind(null,c)).then(e=>{t.updateCounter(e,c.peerId),a.markMessagesAsRead(e,c)});break;case N.UNREAD_COUNT:e.set(e=>Object(Fs.setUnreadCounters)(c,e)).then(()=>{f.updateFilter(e);var t=c.showOnlyNotMuted;t!==Object(nt.getLocalSettingsValue)(e,"show_only_not_muted_messages")&&e.set(e=>Object(Fs.setLocalSettingsValue)("show_only_not_muted_messages",t,e)).then(f.updateSettings),Object(Er.partConfigEnabled)("mail_longpoll_unread_counter")||Object(Us.updateUnreadCounter)(e),Object(r.isClassicInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a)})});break;case N.SET_FLAGS:case N.REPLACE_FLAGS:case N.RESET_FLAGS:if(!(c.flags&N.FLAG_DELETED||c.flags&N.FLAG_SPAM)||c.type!==N.SET_FLAGS||Object(r.isAlreadyDeleted)(e,c.peerId,c.messageId)||e.get().blockedFlagUpdates[c.peerId]||p(c),c.flags===N.FLAG_IMPORTANT){var P=c.type===N.SET_FLAGS;e.set(n.updateImportant.bind(null,P?1:-1,c.messageId)),e.set(n.updateFavMessage.bind(null,[c.messageId],c.peerId,P)).then(()=>{a.markImportant(c.messageId,P,e)})}break;case N.RECORDING_AUDIO:lc(e,a,t,c,n.ACTIVITY_TYPE_RECORDING_AUDIO);break;case N.TYPING:lc(e,a,t,c,n.ACTIVITY_TYPE_TYPING);break;case N.NOTIFY_SETTINGS_CHANGED:!function(e,t,a,r){e.set(n.setMutedPeer.bind(null,a,r)).then(t().updateState.bind(null,a))}(e,b,c.peerId,!c.sound);break;case N.CONVO_MAJOR_ID_CHANGED:e.set(e=>{var t=c.peerId,a=c.majorId,r=Object(i.getTab)(e,t);return(a&&r?Promise.resolve(e):Object(n.loadPeer)(t,0,0,0,e)).then(e=>{var r=Object(i.getTab)(e,t);return r.major_sort_id=a,Object(Vl.updateListedConvos)(e,r,!1,n.addDialog.bind(null,t),n.shouldIncludeDialog.bind(null,e)),Object(n.setActions)(e),Promise.resolve(e)})}).then(e=>{var n=c.peerId;Object(i.getTab)(e,n)&&!Object(i.isSearching)(e)&&t.promoteDialog(e,n),n===e.get().peer&&a.updateActions(e)});break;case N.CONVO_MINOR_ID_CHANGED:e.set(e=>{var t=c.peerId,a=c.minorId,n=Object(i.getTab)(e,t);return n?(n.minor_sort_id=a,Promise.resolve(e)):Promise.resolve(e)}).then(e=>{var a=c.peerId;Object(i.getTab)(e,a)&&!Object(i.isSearching)(e)&&t.promoteDialog(e,a)});break;case N.RESYNC:e.get().longpoll.pause(),e.set(n.resync).then(b().resync).then(()=>e.get().longpoll.resume());break;case N.TRANSITION:O.transition(c.state);break;case N.RESET_PEER:if(c.removeActivePeer){var L=e.get().tabbedPeers.filter(t=>{var a=t.peer,n=t.type;return a!==e.get().peer&&"perm"===n});e.setState({tabbedPeers:L})}!function(e,t,a,s){e.set(n.cancelRecording).then(()=>{a.cancelRecording()}),AudioMessagePlayer.detachPlayer(),t.removeSelection(e),removeClass(s,"im-page_history-show"),t.updateStarPosition(),a.flushDraft(e),a.stopLoading(),a.destroyPeerProfile(),Object(i.isAnyMessageBeingEdited)(e)&&a.cancelEditing();var o=e.get().peer;e.set(n.changePeer.bind(null,0,!1,!1)).then(()=>{window.tooltips&&window.tooltips.hideAll(),ac(),Object(r.isClassicInterface)(e)&&t.activate(),a.changePeer(e),Object(r.isClassicInterface)(e)&&t.restoreScroll(e),setTimeout(()=>{e.get().longpoll.push([Object(d.transitionEvent)("search")])},13),Object(r.isLocksAvailable)(e)&&Object(r.isPeerBlockedByMe)(o,e)&&e.set(n.releaseBlock.bind(null,o))})}(e,t,a,u),c.cancelSearch&&ic(e,l,t),Object(r.isClassicInterface)(e)&&C.updateMenu(e),l.focusInput(),Object(r.isCommunityInterface)(e)&&(l.initPeerTagsFilter(e),t.renderPeerTags(e));break;case N.CHANGE_TAB:Object(i.isSearching)(e)&&l.clearSearch(e);var A=e.get().active_tab;Object(r.changeTab)(c.tab,e,b,n.changeDialogsTab).then(e=>{f.updateFilter(e),c.tab===_.FOLDER_PEER_TAGS&&A!==c.tab&&l.initPeerTagsFilter(e)});break;case N.RESET_DIRECTORIES:case N.SET_DIRECTORIES:case N.REPLACE_DIRECTORIES:var D=c.type,B=c.peerId,x=c.mask;if(x===N.FOLDER_HAS_BANNER)break;var R=x===N.FOLDER_AD_TAG;e.set(n.updateFolderState.bind(null,B,x,D,c.local,R)).then(e=>{Object(i.isSearching)(e)||D===N.RESET_DIRECTORIES&&x===_.FOLDER_MASKS[_.FOLDER_IMPORTANT]||D===N.RESET_DIRECTORIES&&x===_.FOLDER_MASKS[_.FOLDER_MESSAGE_REQUEST]||D===N.SET_DIRECTORIES&&x===_.FOLDER_MASKS[_.FOLDER_MESSAGE_REQUEST_REJECTED]||D===N.REPLACE_DIRECTORIES||t.restoreDialogs(e),t.updateDialog(B,e),Object(r.isClassicInterface)(e)&&C.updateCounter(e,B),e.get().peer===B&&a.changedMessageSelection(e)});break;case N.DELETE_DIALOG:e.set(n.deletedDialog.bind(null,c.peerId,Promise.resolve([]))).then(()=>{b().removePeer(e,c.peerId),b().updateDialogFilters(e)});break;case N.CHANGE_PEER:nc(e,c,t,a,l,u,C,h,b);break;case N.MUTEX:var U={[c.peerId]:c},q=Object(r.isPeerBlocked)(c.peerId,e);e.set(n.updateBlockStates.bind(null,U)).then(()=>{t.updateDialog(c.peerId,e);var n=Object(r.isPeerBlocked)(c.peerId,e);Object(r.isFullyLoadedTab)(e.get(),c.peerId)&&q!==n&&a.updateChat(e,c.peerId)});break;case N.FAILED_MESSAGE:e.set(n.setMessageErrored.bind(null,c.peerId,c.message)).then(()=>{a.setMessageErrored(c.peerId,c.message,c.error,e),t.setDialogFailed(c.peerId,c.message.messageId,e)});break;case N.RESEND:var K=c.message.messageId;e.set(n.resendMessage.bind(null,c.peerId,K,c.message)).then(()=>{a.resendMessage(c.peerId,K),t.promoteDialog(e,c.peerId)});break;case N.PEER_TAGS_CHANGED_EVENT:Object(o.onPeerTagsChangeEvent)(e,t,c);break;case N.PEER_PROFILE_TAGS_CHANGED_EVENT:Object(o.onPeerProfileTagsChangedEvent)(e,t);break;case N.CONVERSATION_UPDATED:if(Object(i.isMessageRequestChangedEvent)(c)){var V=Promise.resolve(),W=Object(H.getCurrentTab)(e);switch(c.updateType){case N.MAIL_CHAT_UPDATE_TYPE_CONTACT_CONVERTED:W&&W.peerId===c.updateArg&&e.get().longpoll.push([Object(d.changePeer)(c.peerId)]),V=e.set(n.deletedDialog.bind(null,c.updateArg,Promise.resolve([]))).then(()=>{b().removePeer(e,c.updateArg),b().updateDialogFilters(e)});break;case N.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:V.then(()=>e.set(n.updateMessageRequestsCounter.bind(null,c))).then(()=>{Object(r.updateMessageRequestsCounterInDOM)(e),Object(r.checkMessageRequestsTab)(e,t.update),c.updateArg===N.MESSAGE_REQUEST_STATUS_ACCEPTED&&Object(r.isClassicInterface)(e)&&C.updateMenu(e)})}}else{if(Object(r.isTabLoaded)(e.get(),c.peerId))Hl(e,c.peerId,c.updateType,c.updateArg,a,t)||b().reloadChatInfo(c.peerId)}break;case N.WAITING_FOR_RECONNECT:setTimeout(()=>{cc(u,!0),a.setNetworkWaitingStatus(c.timeout-1)},1e3);break;case N.RECONNECTING:cc(u,!0),a.setNetworkReconnectingStatus();break;case N.RECONNECTED:cc(u,!1),setTimeout(a.clearNetworkStatus,0),browser.chrome&&!Object(r.isClassicInterface)(e)&&e.get().peer&&(g.is_idle?M||(g.once("unidle",()=>{M=!1,t.forceScrollReinit()}),M=!0):t.forceScrollReinit());break;case N.KEYBOARD_CALLBACK_RECEIVED:var z=Object(nt.getPressedKeyboardButtonState)(c.event_id,e);z&&e.set(e=>Object(Fs.unsetPressedKeyboardButton)({peerId:c.peer_id,eventId:c.event_id},e));var Y=Object(r.getKeyboardButton)(u,z.messageId,z.index);Y&&Object(r.setKeyboardButtonLoadingState)(Y,!1),Object(rt.handleCallbackAction)(c,e)}})})},updateHistory:e=>a.updateHistory(e),reloadChatInfo(e){Object(r.isTabLoaded)(v.get(),e)&&v.set(n.loadChatInfo.bind(null,e)).then(()=>function(e,t,a,i,s){i.updateChatTopic(t,e),Object(r.isClassicInterface)(e)&&s.updateName(t,e),e.get().peer==t&&(Object(n.setActions)(e.get()),i.updateActions(e))}(v,e,0,a,C))},cancelRecording:()=>v.set(n.cancelRecording).then(()=>a.cancelRecording()),fixHeight(){S()},unmount(){Object(c.destroyModule)(e),clearInterval(v.get().update_title_to),g.stop(),I(),k(),Kl.casperMessagesStore.destroy(),t.unmount();var i=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_logo"+i+".ico"),a.unmount(),l.unmount(),cancelStackFilter("im_peer"),f.unmount(),h&&h.unmount(),C&&C.unmount(),w&&w(),y&&y(),Object(r.isLocksAvailable)(v)&&v.get().peer&&v.set(n.releaseBlock.bind(null,v.get().peer)),E.unmount(),C&&C.unmount(),T.unmount(),clearInterval(j),cur.imDb.unmount(),cur.imDb=!1}}}function gc(e,t,a,i){var s=t.get();Object(r.isReservedPeer)(s.peer)||e().onUserActions(t,i),s.update_old_title&&t.set(n.updateFavAndTitle.bind(null,!1,!1))}function mc(e,t){var a=ge("page_header"),n=geByClass1("_im_page_history",e),i=window.clientHeight()-a.offsetHeight-30-2,s=Object(r.isClassicInterface)(t)?250:400,o={page:Math.max(i,s)};if(Object(r.isClassicInterface)(t)){var l=Object(r.getClassicChatHeight)();l=l>0?Math.min(l-a.offsetHeight-30-2,i):i;var c=hasClass(n,"im-page--history_empty-hist")?l:i;o.history=Math.max(l,s),o.chat=Math.max(c,s)}return o}function pc(e,t,a,i,s){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],c=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!Object(l.isFullScreen)()){var d=mc(e,t);if(setStyle(e,{minHeight:d.page}),Object(r.isClassicInterface)(t)&&(void 0===t.get().chatResizeInitialized&&t.set(n.initializeChatResize),setStyle(e,{height:t.get().isCreating?d.page:"auto"}),setStyle(geByClass1("_im_page_dialogs",e),{minHeight:d.page,position:"static",top:0}),setStyle(geByClass1("_im_page_history",e),{minHeight:d.history,position:"relative",top:0}),setStyle(geByClass1("_im_chat_body_abs",e),{minHeight:d.chat,height:d.chat,position:"relative",top:0})),browser.safari&&c&&"function"==typeof c&&c(),i&&i.updateScroll(),s&&s.updateScroll&&s.updateScroll(),a){var u=a.updateScroll();a.scrollFix(t,t.get().peer,u)}o&&setTimeout(()=>pc(e,t,a,i,s,!1),100)}}function _c(e,t){e.get().resendAllOnOnline&&t()}function bc(){!function(e){var t="safari-repaint";e.forEach((function(e){hasClass(e,t)&&removeClass(e,t),addClass(e,t)})),setTimeout((function(){e.forEach((function(e){removeClass(e,t)}))}),100)}([geByClass1("_im_dialog_actions"),geByClass1("_im_chat_input_w"),ge("side_bar"),geByClass1("_im_right_menu"),geByClass1("_im_dialogs_settings"),geByClass1("_im_dialogs_search")])}function hc(e){var t,a,i,s=e.get();return Object(r.isLocksAvailable)(e)?(t=s.mutex_key,a=function(e){s.longpoll.push([N.mutexEvent(e)])},i=function(e,t){return Object(n.getMutexQueue)(s.gid).then(e=>Wl(e,1)[0])},Notifier.addKey(t,pl.bind(null,a,i,t)),ll.set(t,{onData:a,onUpdateKey:i,ts:t.ts}),gl(),{stop:ml.bind(null,t)}).stop:null}function fc(e,t){var a,s=t.get(),o=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_im"+o+".ico"),pc(e,t,!1,!1,!1,!0),Object(tt.statlogsBrowserNotificationsUser)();var d=Object(c.createMutations)(uc),u=d.callMutations,g=d.bindMutations,m=s.useFcLongpoll&&vk.lpConfig.enabled&&Notifier.getLpInstance&&Notifier.getLpInstance(),p=m?Notifier.getLpInstance():t.get().gid?function(e){Object(zo.imWeirdLog)("im_start_longpoll_group",{},!1);var t=Object(Wo.createLongpollEventsQueue)(e.ts,e=>{n.trigger("data",e)}),a=Object(Vo.createLongpoll)(e,t.onLp),n=new window.EventEmitter;return{onData:e=>n.on("data",e),offData:e=>n.off("data",e),push:e=>n.trigger("data",e),pause:t.pause.bind(t),resume:t.resume.bind(t),abortWaiting:a.abortWaiting.bind(a),onLp:t.onLp.bind(t),stop:a.stopConnection.bind(a),isEnabled:()=>!(!a||a.isStopped())}}(s.lpConfig):ol(s);p.onData(f);var _=Notifier.getEventQueueInstance&&Notifier.getEventQueueInstance(),b=_?_.subscribe(e=>u().onQueueEvent(t,e)):()=>{};function f(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];u().onEvents(t,a)}m&&Object(zo.imWeirdLog)("im_use_fc_longpoll",{},!1);var v=geByClass1("_im_dialogs_search",e),O=geByClass1("_im_dialogs_settings",e),y=Fe(geByClass1("_im_page_dcontent",e),t,u,v);y.updateStarPosition(),y.renderPeerTags(t);var j,C,w=Es(v,t,u),E=zs(O,t,u),T=Sl(t);(cur.imDb=Object(mr.mount)(t.get().gid?-t.get().gid:vk.id),t.set(n.preloadSearchIndex.bind(null,cur.imDb)),Object(r.isClassicInterface)(t)&&E.updateSettings(t),Object(r.isClassicInterface)(t))&&(j=El(geByClass1("_im_ui_peers_list",e.parentNode),t),C=function(e,t,a,n){if(browser.mobile)return!1;var r=[t,a,geByClass1("_im_chat_input_w",n),geByClass1("_im_dialog_actions",n)],i=null,s=hasClass(e,"im-page--header_static"),o=ge("im-group-online-disabled-notice");function l(){var t=Object(h.getNativeOption)("scrollLeft"),a=hasClass(e,"im-page--header_static"),n=[];i!==t?n=r.slice().concat([e]):a!==s&&(n=[e]),i=t,s=a,n.length>0&&n.forEach(n=>{var r=e===n&&a?0:-t;setStyle(n,{[cssTransformProp]:0===r?"unset":"translateX("+r+"px)"})})}return o&&r.push(o),r=r.concat(geByClass("_im_aside_notice"),geByClass("_im_aside_promo_block")),addEvent(window,"scroll",l),l(),()=>{removeEvent(window,"scroll",l)}}(v,O,geByClass1("_im_right_menu",e.parentNode),e));Object(r.isClassicInterface)(t)&&s.peer&&y.deactivate(),s.gid||(a=Object(Er.partConfigEnabled)("messages_chat_creation_new_interface")?Fo(t):Do(geByClass1("_im_dialogs_creation",e),t,u));var S=Ni(geByClass1("_im_page_history",e),t,y,j,u),I=s.isCreating,k=I?"create":0===s.peer?"search":"default";I&&a.show(t,[]);var M=qo(t,k,y,S,w,a),P=Nl(t,M);S.renderPeerProfile(t),S.updateScroll();var L=gc.bind(null,u,t,M);s.peer&&t.set(n.prepareCasperMessagesFromMessages.bind(null,s.peer)),Object(r.isReservedPeer)(s.peer)||setTimeout(()=>Jl(t,S),10);var A=new ql.default({id:"im",element:document,focusElement:window,triggerEvents:"mouseover mousedown keypress"}),D=Object(Oa.debounce)(bc,300),B=pc.bind(null,e,t,S,y,a,!1,D),x=_c.bind(null,t,S.resendAll);t.setState({longpoll:p}),t.set(n.setExecStack.bind(null,[])),A.on("unidle",(function(){p.abortWaiting(),L()})),A.start(),nav.objLoc.box&&(Xl(t,nav.objLoc.box),Object(gr.updateLocation)({box:null})),nav.objLoc.mr&&Object(r.isChatPeer)(Number(nav.objLoc.mr))&&Object(r.showChatInvitationBox)(t,nav.objLoc.mr,u,y);var N,R=hc(t);if(Object(r.isLocksAvailable)(t)&&(N=setInterval(r.blockLatencyCompensation.bind(null,t,s.longpoll),2e3)),t.get().invitation&&Object(r.showInvitationBox)(t,t.get().invitation,n.leaveInvitation),Object(r.isClassicInterface)(t)&&Object(i.existsIncomingMessageRequest)(t)){var F=document.getElementById("ui_rmenu_mr");F&&F.classList.remove("unshown")}var H=Object(l.throttleAccumulate)($l.bind(null,t,S,y,j),200),U=r.hideTopNotice.bind(null,t),G=r.hideAsideNotice.bind(null,t);return Kl.casperMessagesStore.subscribe(e=>function(e,t,a,n,r){var s=r.type,o=r.message;switch(s){case Kl.EXPIRING:return t.updateCasperMessageStatus(o);case Kl.EXPIRING_SOON:return t.updateCasperMessageStatus(o,!0);case Kl.EXPIRED:Object(i.isCasperChat)(e,o.peerId)?n(o):(t.handleMessageExpiration(o),a.updateDialog(o.peerId,e))}}(t,S,y,H,e)),Kl.casperMessagesStore.setTimeshift(s.timeshift),g(Object(c.createModule)({handlers:(t,a)=>{t(document,"mousemove mousedown keypress",L),t(window,"resize",B),t(window,"online",x),a(e,"click",r.HIDE_TOP_NOTICE_CLASS,U),a(gpeByClass("_im-page-wrap",e),"click",r.HIDE_ASIDE_NOTICE_CLASS,G),a(gpeByClass("_im-page-wrap",e),"click",r.HIDE_ASIDE_PROMO_BLOCK_CLASS,r.hideAsidePromoBlock),a(gpeByClass("_im-page-wrap",e),"click",r.INSTALL_VKADMIN_LINK,r.installVKAdminApp),browser.safari&&t(document,"visibilitychange",bc)}}),y,S,w,e,A,p,H,u,a,E,t,M,R,N,j,C,T,P,B,(function(){m?p.offData(f):p.stop()}),b)}var vc,Oc;function yc(e){var t=ge("page_header"),a=window.clientHeight()-t.offsetHeight-30-2;setStyle(e,{height:Math.max(a,400)})}function jc(e){var t=Object(r.formatTimespan)(Math.floor(Math.max(e,0)/1e3),!0);return t?getLang("mail_sick_timer").replace(/{timer}/gi,t):""}function Cc(){nav.reload({force:!0})}function wc(e){return{unmount(){clearInterval(Oc),clearTimeout(vc),Object(c.destroyModule)(e)}}}function Ec(e,t,a){yc(e);var n,r,i=(0,Object(c.createMutations)(wc).bindMutations)(Object(c.createModule)({handlers:(t,a)=>{t(e.querySelector("._im_sick_reload"),"click",Cc),t(window,"resize",yc.bind(null,e))}})),s=(n=localStorage.getItem("im_sick_timer"),r=n?Math.min(2*parseInt(n),6e5):5e3,localStorage.setItem("im_sick_timer",r),r),o=e.querySelector("._im_sick_timer"),l=+new Date;return o.innerHTML=jc(s),Oc=setInterval(()=>{o.innerHTML=jc(l+s-new Date)},500),vc=setTimeout(Cc,s),i}var Tc=a("f4YT"),Sc=a.n(Tc),Ic=function(){return(Ic=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};window.IM={init:function(e){var t,a;if(window.imwl=e.imwl,Object(zo.startLoggingAllUnhandled)(),Object(_r.addTemplates)(Sc.a),window.cur.lang.dont_attach=Object(fa.getLang)("mail_dont_add_media"),e.failed)return Ec(Object(br.geByClass1)("im-sick",Object(br.ge)("page_body")));localStorage.removeItem("im_sick_timer"),window.cur.ctrl_submit=e.ctrl_submit,window.cur.module="im",window.cur.mutedPeers=e.mutedPeers,window.cur.gid=e.gid,window.cur.peer=e.peer,window.cur.options={blacklist_hash:e.thash};var i=-10800-60*(new Date).getTimezoneOffset(),s=e.timeshift,o=Ic(Ic({},e),{owners:void 0,tabbedPeers:(e.tabbedPeersArray||[]).map((function(e){return{peer:e,type:"perm"}})),blockedFlagUpdates:{},msgid:Object(_r.intval)(window.nav.objLoc.msgid),timeshift:s-i,oCache:{},ref_id:window.nav.objLoc.ref,ref_source:window.nav.objLoc.ref_source,topConvTree:new Promise((function(){})),hintsTree:new Promise((function(){})),imTopConvList:new Promise((function(){})),keyboardCallbackEventButtons:new Map}),l=Object(b.default)(o);null===(t=e.owners)||void 0===t||t.forEach((function(e){return Object(F.oCacheAdd)(l,e)})),Object(r.normalizeTabsGotFromServer)(l,l.get().tabs),window.cur.imClassicInterface=Object(r.isClassicInterface)(l);var c=fc(Object(br.geByClass1)("js-im-page",Object(br.ge)("page_body")),l);Object(n.updateMentions)(l.get()),e.group_calls_feature_tt_hash&&Object(r.showGroupCallsOnboardingBox)(l.get(),e.group_calls_feature_tt_hash),e.group_calls_new_year_feature_tt_hash&&Object(r.showGroupCallsNewYearTooltip)(l.get(),e.group_calls_new_year_feature_tt_hash),window.IMBRIDGE={chatPhotoSaved:function(e){window.curBox()&&window.curBox().hide();var t=(e||{})[1];return t?(window.cur.pvShown&&window.layers.fullhide(!0,!0),"im"!=window.cur.module||l.get().peer!=t?window.nav.go("/im?sel=c"+(t-2e9)):void 0):window.nav.reload()},syncHistory:function(){l.set((function(e){return Object(n.syncHistory)(e)})).then((function(){}),(function(){}))},activateTab:function(e){l.get().gid||l.get().longpoll.push([Object(d.changePeer)(Object(_r.intval)(e),!1,!1,!0)])}},Object(Er.partConfigEnabled)("debug_messenger")&&(window.IMBRIDGE.store=l);var u=!1;window.cur.nav.push((function(){var e;return!!u||((null===(e=l.get().audio_msg)||void 0===e?void 0:e.isRecording)&&c.cancelRecording(),window.AudioMessagePlayer.detachPlayer(),c.route.apply(null,arguments))})),null===(a=window.cur.destroy)||void 0===a||a.push((function(){if(u)return!0;c.unmount(),window.IMBRIDGE=void 0,l.unmount(),window.store=void 0,u=!0,e=!1,l=!1,c=!1,Object(zo.stopLoggingAllUnhandled)()}))}};try{window.stManager.done("imn.js")}catch(e){}},V1lx:function(e,t,a){"use strict";a.r(t),a.d(t,"setHTML",(function(){return s}));a("91GP"),a("ioFf"),a("rGqo"),a("Btvt");var n=a("q1tI");a("17x9");function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}function s(e,t){var a=!!window.getSelection&&window.getSelection(),n=!1;if(a&&a.rangeCount){var r=a.getRangeAt(0);n=r.commonAncestorContainer?r.commonAncestorContainer:r.parentElement?r.parentElement():r.item(0)}for(var i=n;i&&i!=e;)i=i.parentNode;window.Emoji&&(i||window.Emoji.editableFocus(e,!1,!0),window.Emoji.insertHTML(t))}class o extends n.Component{constructor(){super(...arguments),this.onChange=()=>{this.props.onChange&&window.Emoji&&this.props.onChange(window.Emoji.val(this.container))},this.containerRef=n.createRef(),this.state={value:this.props.initialValue}}componentDidMount(){if(this.container=this.containerRef.current,this.container&&!this.isMount){this.isMount=!0;var e=this.props.initialValue;window.Emoji&&(window.Emoji.val(this.container,window.Emoji.emojiToHTML(e)),window.Emoji.init(this.container,{noStickers:!0,onSend:()=>{},ctrlSend:()=>!0,onChange:this.onChange,noLineBreaks:!this.props.isMultiLine}))}}componentWillUnmount(){this.container&&this.isMount&&(this.isMount=!1)}render(){var e=this.props,t=e.tabIndex,a=e.isMultiLine,s=(e.initialValue,i(e,["tabIndex","isMultiLine","initialValue"]));return n.createElement("div",r({role:"textbox",ref:this.containerRef,tabIndex:t,contentEditable:!0,"aria-multiline":a},s))}}o.defaultProps={isMultiLine:!1,tabIndex:0,initialValue:""},t.default=o},XLJO:function(e,t,a){"use strict";a.r(t),a.d(t,"checkContactListLoaded",(function(){return V})),a.d(t,"mount",(function(){return le}));a("Vd3H"),a("rGqo"),a("pIFo"),a("VRzm"),a("Btvt");var n=a("EasH"),r=a("FWc3"),i=a("4+be"),s=a("ofcU");var o=a("vT4u"),l=a("P13b"),c=a("eaP7"),d=a("rDjD"),u=a("rHUl"),g=a("ZxpX"),m=a("MhhX"),p=a("86+7"),_=a("Wu9C"),b=a("ZoqV"),h=a("t7TG"),f=a("q1tI"),v=a.n(f),O=a("i8i4"),y=a("e87a"),j=a("GSQL"),C=function(e){var t=e.icon,a=e.children,n=Object(g.classNames)("ContactIconRow__icon","ContactIconRow__icon--"+t);return v.a.createElement("div",{className:"ContactIconRow"},v.a.createElement("div",{className:n}),v.a.createElement("div",{className:"ContactIconRow__text"},a))},w=a("Aegd"),E=a("85vT"),T=a("6krn"),S=function(e){var t=e.contact,a=t.id+19e8;return v.a.createElement("div",{className:"ContactPopupContent"},v.a.createElement("header",{className:"ContactPopupContent__header"},v.a.createElement("div",{className:"ContactPopupContent__photo"},v.a.createElement(w.ConversationNoPhoto,{text:Object(l.getUserInitials)(t.name),size:"80",id:a,specificType:7,key:t.id})),v.a.createElement("h3",{className:"ContactPopupContent__title"},v.a.createElement(E.default,null,Object(l.prepareContactName)(t.name))),v.a.createElement("div",{className:"ContactPopupContent__meta"},Object(T.getLang)("mail_from_contacts_list"))),v.a.createElement("div",{className:"ContactPopupContent__info"},t.main_phone&&v.a.createElement(C,{icon:"phone"},Object(l.formatPhoneNumber)(t.main_phone)),t.emails[0]&&v.a.createElement(C,{icon:"mail"},v.a.createElement("a",{href:"mailto:"+t.emails[0]},t.emails[0]))),t.sync_date&&v.a.createElement("div",{className:"ContactPopupContent__info"},v.a.createElement(C,{icon:"sync"},t.sync_date)))},I=a("QDnf"),k=a("aong"),M=function(e){var t=e.getContactInfo,a=e.onClose,n=Object(f.useState)({kind:"loading"}),r=n[0],i=n[1];switch(Object(f.useEffect)((function(){var e=function(e){Object(k.showErrorBox)(e),i({kind:"failed"}),a()};t().then((function(t){t?i({kind:"loaded",contact:t}):e(Object(T.getLang)("mail_contact_was_removed"))})).catch((function(){e(Object(T.getLang)("global_error"))}))}),[]),r.kind){case"failed":return v.a.createElement(v.a.Fragment,null);case"loading":return v.a.createElement(I.default,null);case"loaded":return v.a.createElement(y.default,{onClose:a,className:"ContactPopup"},v.a.createElement(j.default.Header,{title:Object(T.getLang)("mail_contact"),onClose:a,appearance:"blue"}),v.a.createElement(S,{contact:r.contact}))}};function P(e,t,a){var n=L();if(n){var r=t-19e8;O.render(f.createElement(M,{store:e,onClose:a.closeContactPopup,getContactInfo:()=>function(e,t){return V(e).then(e=>{var a=function(e,t){var a=e.get().contactsList;return a?a.find(e=>e.id===t):null}(e,t);return Promise.resolve(a)})}(e,r)}),n)}}function L(){return document.querySelector("._im_contact_popup_container")}function A(e,t){return{unmount:()=>function(e,t){var a=L();a&&O.unmountComponentAtNode(a),Object(s.destroyModule)(e)}(e),closeContactPopup(){var e=L();O.unmountComponentAtNode(e)}}}var D=a("q2pz");var B=a("vhcd"),x=a("shih"),N=a("W9Tc"),R=a("kxld"),F=a("ftTi"),H=a("zxIV"),U=a("PEW9"),G="im-page--header-action_loading";function q(e,t,a){return!e.map(e=>{var n=Object(u.getMessage)(t,a,e);return Object(m.isImportant)(n)}).reduce((e,t)=>e&&t,!0)}function K(e,t){var a=t.get(),n=a.peer,r=a.tabs[n].pinned;return 1===e.length&&r&&e[0]===Object(u.parserMessage)(r).messageId}function V(e){return e.get().contactsList?Promise.resolve(e):e.set(o.getContactsList)}function W(e,t,a){var n=Object(i.getLang)("mail_selected_shorted",t.length);X({actions:!0},"im-page--chat-header"),Object(H.val)(Object(H.geByClass1)("im-page--selected-messages"),getTemplate("im_selected_messages",{label:n.replace("{count}",t.length),tip:Object(i.getLang)("mail_deselect_all")}));var r=Object(u.getTab)(a,a.get().peer),s=e.querySelector("._im_mess_actions"),o=q(t,a,a.get().peer),c=K(t,a),d=t.length>1,m=!d&&Object(l.isChatPeer)(r.peerId)&&Object(l.canPinMessage)(a,t[0]),p=Object(l.canForwardMessages)(a,t),_=e.querySelector('._im_page_action[data-action="respond"]'),b=e.querySelector('._im_page_action[data-action="forward"]'),h=Boolean(Object(u.tabIsOutgoingMessageRequest)(r)),f=Boolean(Object(u.tabIsMessageRequest)(r));s.className=Object(g.classNames)("im-page--mess-actions _im_mess_actions",{"im-page--mess-actions_important":!o,"im-page--mess-actions_pinned":c,"im-page--mess-actions_channel":Object(u.isChannelPeer)(r)&&!a.get().gid,"im-page--mess-actions_multiple-selection":d,"im-page--mess-actions_no-pin-btn":!m,"im-page--mess-actions_out-mr":h,"im-page--mess-actions_in-mr":f,"im-page--mess-actions_no-important-btn":!Object(l.canMarkImportant)(a,t)}),t.length>1?_.innerHTML=Object(i.getLang)("mail_forward_here"):_.innerHTML=Object(i.getLang)("mail_im_mark_reply"),p?(b.removeAttribute("disabled"),b.classList.remove("button_disabled")):(b.setAttribute("disabled","disabled"),b.classList.add("button_disabled")),d&&!p?(_.setAttribute("disabled","disabled"),_.classList.add("button_disabled")):(_.removeAttribute("disabled"),_.classList.remove("button_disabled"));var v=o?Object(i.getLang)("mail_im_toggle_important"):Object(i.getLang)("mail_im_toggle_important_off"),O=c?Object(i.getLang)("mail_unpin"):Object(i.getLang)("mail_pin");attr(Object(H.geByClass1)("im-page-action_star",e),"aria-label",v),attr(Object(H.geByClass1)("im-page-action_pin",e),"aria-label",O)}function z(e,t,a){var n=t.get(),r=n.peer,i=n.tabs[r],s=Object(H.geByClass1)("_im_chat_verified",e),c=Object(H.geByClass1)(l.PINNED_CONTAINER_CLASS,e),d=Object(l.isChatPeer)(r),g=d&&Object(u.isChannelPeer)(i),m=n.selectedMessages&&!!n.selectedMessages.length;s.tt=!1;var b=Object(l.renderPhotosFromTab)(t,i,!1),h=getTemplate("im_simple_link",{href:g?"/club"+-i.ownerId:i.href,content:getTemplate("im_peer_photo",{online_class:"",owner_photo:b,modifier_class:"nim-peer_smaller"})});Object(H.val)(Object(H.geByClass1)("im-page--aside-photo",e),h);var f=d&&Object(u.isChatActive)(i),v={muted:inArray(r,n.mutedPeers),verified:!!i.verified,chat:d,vkcomgroup:g,actions:m,derelict:d&&!f&&!g,pinned:!1};if(d){var O=Object(u.getPinnedMessage)(t),y=function(e){var t=Object(u.getPinnedMessage)(e);if(!t||Object(p.oCacheGet)(e,t.userId))return!1;return t.userId}(t);O&&Object(_.isPinnedMessageVisibleInTab)(t,r)&&(y?t.set(o.loadChatMember.bind(null,{[r]:[y]})).then(z.bind(null,e,t,a)):v.pinned=!0)}Y(t,i,e);var j=!i.top_banner&&c.innerHTML,C=!i.top_banner&&$(t,e,c),w=Object(H.geByClass1)("_im_page_peer_name",e);Object(H.removeClass)(w,l.DESELECT_ALL_CLASS),function(e,t,a){var n=a.length>0;Object(H.geByClass)("_im_header_icon",e).forEach(e=>{if("star"===e.dataset.type&&Object(l.isFoldersAvailable)(t)&&(Object(H.toggleClass)(e,"im-page--header-icon_shown",!n),Object(H.toggleClass)(e,"im-page--header-icon_star-active",Object(l.isImportant)(t))),"answer"===e.dataset.type&&Object(l.isFoldersAvailable)(t)&&Object(H.toggleClass)(e,"im-page--header-icon_shown",!n&&Object(l.isUnrespond)(t)),"search"===e.dataset.type&&!Object(l.isCommunityInterface)(t)){var a=t.get().peer,r=!n&&Object(l.isFullyLoadedTab)(t,a)&&Object(u.getTab)(t,a).offset&&!Object(l.isCommunityInterface)(t)&&(!Object(l.isCallToPeerAvailable)(t,a)||!Object(l.isClassicInterface)(t));Object(H.toggleClass)(e,"im-page--header-icon_shown",r)}})}(e,t,[]);var E=e.querySelector("._im_dialog_call_action_wrapper"),T=e.querySelector("._im_header_icon[data-type=call]");if(E&&E.classList.toggle("im-page--header-call-is-hidden",!Object(l.isCallToPeerAvailable)(t,r)||!!i.callInProgress),T&&(T.classList.toggle("im-page--header-icon_shown",Object(l.isCallToPeerAvailable)(t,r)&&!!i.callInProgress),T.classList.toggle("im-page--header-icon_call-active",!!i.callInProgress&&i.callInProgress.participants.count>0)),Object(l.isClassicInterface)(t)){var S=Object(H.geByClass1)("_im_page_back",e);attr(S,"href",`${Object(l.getBaseLink)(t)}?tab=${n.active_tab}`)}X(v,"im-page--chat-header"),Object(l.compensateHistoryHeightChange)(t,C,j,a)}function Y(e,t,a){var n=Object(l.isChatPeer)(t.peerId),r=n&&Object(u.isChannelPeer)(t),s=n&&Object(u.isChatActive)(t),o=n&&Object(u.isCasperChatTab)(t),c=Object(l.isContactPeer)(t.peerId),d=t.name,g="";n?g=r?getTemplate("im_vkcomgroup_members",{name:Object(i.getLang)("mail_im_n_vkcomgroup_members",Object(l.getAliveMembersCount)(t))}):s?getTemplate("im_chat_members",{name:Object(i.getLang)("mail_im_n_chat_members",Object(l.getAliveMembersCount)(t))}):"":Object(l.isUserPeer)(t.peerId)&&(g=Object(l.getLastSeenTextInHeader)(e,t.peerId));var m=[];""===g&&m.push("im-page--title--1line"),o&&m.push("im-page--title--casper"),m=m.join(" ");var p=getTemplate("im_simple_name",{name:c?Object(l.prepareContactName)(t.name):t.tab,href:r?"/club"+-t.ownerId:t.href,name_attr:d,ads_union:t.ad_union_ids_attr,online:g,more_cls:m});Object(H.val)(Object(H.geByClass1)("im-page--title-wrapper",a),p)}function $(e,t,a){var n=Object(u.getPinnedMessage)(e),r=a||Object(H.geByClass1)(l.PINNED_CONTAINER_CLASS,t);if(Object(H.removeClass)(r,"im-page--pinned_with-bar"),n&&Object(m.isMoneyRequest)(n)){if(void 0===n.kludges.attach1_tr_amount)return;n.kludges.attach1_total_amount&&Object(H.addClass)(r,"im-page--pinned_with-bar")}var i=Object(l.renderPinnedMessage)(e);return Object(H.val)(r,i),!!i}function X(e,t){var a=Object(H.geByClass1)(t);Object.keys(e).forEach(n=>{Object(H.toggleClass)(a,`${t}_${n}`,!!e[n])})}function Q(e,t,a,n,r){e.set(o.removeMessagesWithRestore.bind(null,a,r,n)).then(t().removeMessagesRestore.bind(null,a,r,n)),Object(o.removeMessageSend)(a,r,null,n,e.get()).then(()=>{var n=Object(u.getTab)(e,r);a.includes(n.lastmsg)&&Object(o.loadActualLastMessage)(e,r).then(()=>{Object(N.partConfigEnabled)("messenger_empty_pinned_support")&&t().updateConvoInList(r,e),t().updateState(r,e)})})}function J(e,t,a,n,r){var i=e.get().selectedMessages,s=domData(r,"action"),d=e.get().peer,g=Object(u.getTab)(e,d),m=!0;if(!["star","delete"].includes(s)&&Object(u.tabIsOutgoingMessageRequest)(g))return ee(e,t,a);switch(s){case"delete":var p=!(vk.id==d&&!e.get().gid)&&i.every(t=>Object(l.canMessageBeDeletedForAll)(e,Object(u.getMessage)(e,d,t)));if(p||i.length>1){m=!1;var _=Object(l.showMsgDeleteDialog)(d,i.length,p,n=>{ee(e,t,a),_.hide(),cur.imDb.updateByKey("del_forall_checked",n),n?Object(o.removeMessageSend)(i,d,null,"deleteforall",e.get()):Q(e,t,i,s,d)})}else Q(e,t,i,s,d);break;case"spam":Q(e,t,i,s,d);break;case"forward":if(!Object(l.canForwardMessages)(e,i))return;Object(o.processFwd)(i,d,e).then(t=>e.set(o.prepareForward.bind(null,t))).then(()=>a().showForward(e)).catch(e=>console.error(e));break;case"star":var b=q(i,e,d);e.set(o.favMessage.bind(null,i,b,d)),e.get().longpoll.push(i.map(e=>({type:b?c.SET_FLAGS:c.RESET_FLAGS,messageId:e,peerId:d,flags:c.FLAG_IMPORTANT})));break;case"respond":var h=e.get(),f=1===i.length;Object(o.processFwd)(i,h.peer,e).then(t=>e.set(o.forwardMessages.bind(null,t,h.tfdraft,f))).then(()=>{t().respond(e,d)});break;case"pin":var v=Object(u.getLocalId)(e,i[0]);if(!Object(l.canPinMessage)(e,v))return;var O=K(i,e),y=O?o.unpinMessageOptimistic.bind(null,d):o.pinMessageOptimistic.bind(null,v,d),j=O?o.unpinMessage.bind(null,d):o.pinMessage.bind(null,v,d),C=se.bind(null,t,d);e.set(o.checkChatMember.bind(null,e,v,d)).then(e=>e.set(y)).then(C).then(e=>e.set(j)).then(C)}m&&ee(e,t,a)}function Z(e,t,a,r,s,c){var g=domData(c,"action"),m=r.querySelector("._im_dialog_action_wrapper ._ui_menu").parentNode,b=e.get().peer;switch(g){case U.ConvoAction.CLEAR:var h=Object(u.getTab)(e,b),f=Object(l.showFlushChat)(h,b,()=>{Object(l.cleanHistory)(e,f,t,o.flushHistory,e.get().peer)});break;case U.ConvoAction.MEDIA:showWiki({w:"history"+Object(l.convertPeerToUrl)(b)+"_photo"},null,{});break;case U.ConvoAction.CALL_AUDIO:case U.ConvoAction.CALL_VIDEO:Object(l.isCallToPeerAvailable)(e,b)&&Object(l.startCallFromIm)(e,b,g===U.ConvoAction.CALL_VIDEO,[],l.CALL_ENTRY_POINT_HEADER);break;case U.ConvoAction.CALL_APP:if(Object(l.isCallToPeerAvailable)(e,b)){(function(e){return new Promise((t,a)=>{if(window.browser&&browser.mobile)a("is_mobile");else if(document.body.focus(),"hidden"===document.visibilityState||document.hidden)a("hidden_page");else{var n,r=()=>{n&&clearTimeout(n),window.removeEventListener("blur",r),t()};if(window.addEventListener("blur",r),n=setTimeout(()=>{window.removeEventListener("blur",r),a("timed_out")},2e3),window.browser&&(browser.safari||browser.mozilla)){var i=document.createElement("iframe");i.style.display="none",document.body.appendChild(i);var s=i.contentWindow;s?(s.location.href=e,setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},100)):window.location.href=e}else window.location.href=e}})})("vkcall://payload").then(()=>{window.console&&console.log("Native app check success")}).catch(e=>{window.console&&console.log("Native app check failed",e)})}break;case U.ConvoAction.SEARCH:t().showSearch(e);break;case U.ConvoAction.BLOCK_NOTIFY:case U.ConvoAction.BLOCK_COMMUNITY:e.set(o.toggleCommunityMessages.bind(null,!1,b)).then(()=>{e.get().longpoll.push([Object(d.resetPeer)()]),showDoneBox(Object(i.getLang)("mail_community_was_blocked"))});break;case U.ConvoAction.ALLOW_COMMUNITY:e.set(o.toggleCommunityMessages.bind(null,!0,b)).then(()=>{a().changeActions(e)});break;case U.ConvoAction.BLOCK:Object(l.showBlacklistBox)(b,e).once("success",t=>{t.delta&&(showDoneBox(t.msg),e.get().longpoll.push([Object(d.resetPeer)()]))});break;case U.ConvoAction.LEAVE:var v=Object(l.showLeaveDialog)(e,b,a=>{var n=e.set(o.leaveChat.bind(null,b)).then(()=>e.set(o.unpinMessageOptimistic.bind(null,b)));a&&n.then(()=>Object(l.cleanHistory)(e,v,t,o.flushHistory,b)),v.hide(),e.get().longpoll.push([Object(d.resetPeer)()])});break;case U.ConvoAction.UNREAD:var O=e.get();Object(o.markDialogUnread)(O.peer,O);break;case U.ConvoAction.RETURN:e.set(o.returnToChat.bind(null,b)).then(e=>e.set(o.getPinnedMessage.bind(null,b))).then(t().updateChatTopic.bind(null,b)).catch(e=>{Object(n.showFastBox)(Object(i.getLang)("global_error"),e)});break;case U.ConvoAction.MUTE:case U.ConvoAction.UNMUTE:e.set(o.toggleMutePeer.bind(null,b,g===U.ConvoAction.MUTE,-1)).then(t().updateState.bind(null,b));break;case U.ConvoAction.PIN_CONVO:Object(x.pinConvoHandler)(e.get(),b).catch(e=>{Object(k.showErrorBox)(e)});break;case U.ConvoAction.UNPIN_CONVO:Object(x.unpinConvoHandler)(e.get(),b).catch(e=>{Object(k.showErrorBox)(e)});break;case U.ConvoAction.CHAT_INVITE:Object(l.inviteUser)(e,b,t,o.setCreationType);break;case U.ConvoAction.USER_INVITE:var y=Object(u.getTab)(e,b);if(Object(l.isUserPeer)(b)&&y.canBeAddedToChat){Object(B.collectConvoInviteStats)(B.ConvoInviteEntryPoint.DIALOG_ACTIONS,b);var j=Object(l.isContactPeer)(b)?function(e){return{id:e.peerId,link:e.href,name:e.name,first_name:"",short_name:"",inv_name:"",kick_name:"",sex:e.sex,photo:e.photo||""}}(y):Object(p.oCacheGet)(e,b);Object(D.mount)(e,j,t=>{var a;return Promise.resolve(null===(a=e.get().longpoll)||void 0===a?void 0:a.push([Object(d.changePeer)(t,!1)]))},t=>{var a;return null===(a=e.get().longpoll)||void 0===a?void 0:a.push([Object(d.changePeer)(t,!1,!0,!0)])})}break;case U.ConvoAction.CREATE_CHAT:var C=Object(u.getTab)(e,b),w=[[b,C.tab]];e.set(o.setCreationType.bind(null,"chat",[])).then(()=>t().showCreation(e,w));break;case U.ConvoAction.PIN_HIDE:Object(_.pinnedMessageHide)(e,Object(F.getPeer)(e),t);break;case U.ConvoAction.PIN_UNHIDE:Object(_.pinnedMessageUnHide)(e,Object(F.getPeer)(e),t);break;case U.ConvoAction.UNPIN:Object(_.pinnedMessageUnpin)(e,Object(F.getPeer)(e),t);break;case U.ConvoAction.SETTINGS:a().showSettings(e)}uiActionsMenu.toggle(m,!1),t().cancelEditing()}function ee(e,t,a){var n=e.get().selectedMessages;e.set(o.cleanSelected).then(a().changedMessageSelection).then(t().cleanSelection.bind(null,n))}function te(e,t,a,n){var s,o,c=Object(l.isClassicInterface)(e);switch(domData(n,"type")){case"star":o=[4,6],s=()=>Object(l.isImportant)(e)?Object(i.getLang)("mail_im_toggle_important_off"):Object(i.getLang)("mail_im_toggle_important");break;case"answer":o=[4,6],s=Object(i.getLang)("mail_end_conversation");break;case"search":o=c?[5,6]:[4,-9],s=Object(i.getLang)("mail_search_in_peer")}Object(r.showTooltip)(n,{text:s||"",black:1,shift:o,forcetoup:!0,appendParentCls:c?"_im_dialog_actions":"_im_mess_actions"})}function ae(e,t,a){var n=Object(l.isClassicInterface)(e),i=domData(a.target,"action");"respond"!==i&&"forward"!==i&&Object(r.showTooltip)(a.target,{text:ne.bind(null,e,i)||"",black:1,shift:[2,n?-4:11],forcetodown:!0,appendParentCls:"_im_dialog_actions"})}function ne(e,t){var a=e.get(),n=a.selectedMessages,r=a.peer;switch(t){case"pin":return K(n,e)?Object(i.getLang)("mail_unpin"):Object(i.getLang)("mail_pin");case"star":return q(n,e,r)?Object(i.getLang)("mail_im_toggle_important"):Object(i.getLang)("mail_im_toggle_important_off");case"delete":return Object(i.getLang)("mail_delete");case"spam":return Object(i.getLang)("mail_im_mark_spam")}}function re(e,t,a,n,r){var s=domData(r,"type"),c=e.get().peer;switch(s){case"star":e.set(o.toggleDialogImportant.bind(null,c)).then(()=>{setTimeout(()=>te(e,0,0,r),40)});break;case"search":a().showSearch(e),window.tooltips&&tooltips.hide(r,{fasthide:!0});break;case"answer":var g=Object(u.getTab)(e,c);g&&(e.set(o.markDialogAnswered.bind(null,e.get().peer,g.lastmsg)),showDoneBox(Object(i.getLang)("mail_marked_as_answered"),{out:1e3}),e.get().longpoll.push([Object(d.resetPeer)()]));break;case"call":if(Object(l.isCallToPeerAvailable)(e,c)){var m=Object(u.getTab)(e,c).callInProgress;m&&Object(l.joinCallFromIm)(e,c,m.join_link,!1,l.CALL_ENTRY_POINT_JOIN_HEADER)}}}function ie(e,t){var a=Number(t),n=Object(l.formatTimespan)(a,!0),r=Object(i.getLang)("mail_network_waiting").replace(/{timer}/gi,n);e.querySelector("._im_page_status").innerHTML=r}function se(e,t,a){return e().updateChatTopic(t,a),a}function oe(e,t,a,n){var r={};return{changeActions(t){var a=e.querySelector("._im_dialog_action_wrapper ._ui_menu"),n=e.querySelector("._im_dialog_action_wrapper"),r=t.get().curActions||{},i=Object.keys(r).sort((e,t)=>o.ACTION_PRIORITIES[e]-o.ACTION_PRIORITIES[t]);if(0!==i.length){for(var s=getTemplate("sUiActionsMenuSeparator"),l="",c=0,d=0;d<i.length;d++){var u=i[d];d>0&&(c/10|0)!=(o.ACTION_PRIORITIES[u]/10|0)&&(l+=s),l+=getTemplate("sImUiActionMenuItem",{action:u,name:r[u].name,icon:r[u].icon,classes:"_im_action"}),c=o.ACTION_PRIORITIES[u]}a.innerHTML=l,n.classList.remove(G)}else n.classList.add(G)},setNetworkWaitingStatus(t){r.interval&&clearInterval(r.interval),ie(e,t),r.timeout=t,r.interval=setInterval(()=>{r.timeout>1?(r.timeout--,ie(e,r.timeout)):(clearInterval(r.interval),r={})},1e3)},setNetworkReconnectingStatus(){var t,a;r.interval&&clearInterval(r.interval),r={},t=e.querySelector("._im_page_status"),a=Object(i.getLang)("mail_network_reconnecting"),t&&(t.innerHTML=a)},clearNetworkStatus(){r.interval&&clearInterval(r.interval),r={},e.querySelector("._im_page_status").innerHTML=""},showSettings(t){var a=t.get(),r=Object(u.getTab)(t,a.peer);Object(u.isChatActive)(r)&&Object(b.mount)(e,t,n)},showForward(t){Object(h.mount)(e,t,n)},renderPeer(a){z(e,a,t)},reRenderPinned(t){var a=Object(R.getCurrentTab)(t);a&&a.pinned&&$(t,e)},reRenderTitle(t){var a=Object(R.getCurrentTab)(t);a&&Y(t,a,e)},renderActions(t){var a=t.get().selectedMessages||[];a.length>0&&W(e,a,t)},hideActions(t){if(!Object(l.isFullyLoadedTab)(t,t.get().peer)){Object(H.geByClass)("_im_header_icon",e).forEach(e=>{Object(H.addClass)(e,G)});var a=Object(H.geByClass1)("_im_dialog_action_wrapper",e);Object(H.addClass)(a,G);var n=Object(H.geByClass1)("_im_dialog_call_action_wrapper",e);Object(H.addClass)(n,G)}},showActions(t){if(Object(l.isFullyLoadedTab)(t,t.get().peer)){Object(H.geByClass)("_im_header_icon",e).forEach(e=>{Object(H.removeClass)(e,G)});var a=Object(H.geByClass1)("_im_dialog_action_wrapper",e);Object(H.removeClass)(a,G);var n=Object(H.geByClass1)("_im_dialog_call_action_wrapper",e);Object(H.removeClass)(n,G)}},changedMessageSelection(a){if(0!==a.get().peer){var n=a.get().selectedMessages||[];n.length>0?W(e,n,a):z(e,a,t)}},updateLastSeen(t){!function(e,t){var a=e.get().peer,n=Object(H.geByClass1)("_im_page_peer_online",t);n&&Object(l.isUserPeer)(a)&&Object(u.getTab)(e,a)&&Object(l.applyInnerHtml)(n,Object(l.getLastSeenTextInHeader)(e,a))}(t,e)},deselectAll(e){ee(e,t,n)},updateState(e){t().updateState.bind(null,e)},unmount(){Object(s.destroyModule)(a),cancelStackFilter("fowrward")}}}function le(e,t,a){var n=Object(s.createMutations)(oe),r=n.callMutations,i=n.bindMutations,c=J.bind(null,t,a,r),u=Z.bind(null,t,a,r,e),g=ee.bind(null,t,a,r),m=(e,a)=>Object(l.showVerifiedTooltip)(a,t.get().peer),p=te.bind(null,t,e),_=ae.bind(null,t,e),b=re.bind(null,t,e,a),h=()=>r().showSettings(t),f=a=>{var n=t.get().peer;Object(l.isContactPeer)(n)&&(!function(e,t,a,n){var r=(0,Object(s.createMutations)(A).bindMutations)(Object(s.createModule)({handlers:(e,t)=>{}}),e);P(e,t,r)}(t,n),cancelEvent(a)),!gpeByClass("im-page--chat-header_chat",a.target,e)||gpeByClass("im-page--chat-header_vkcomgroup",a.target,e)||checkEvent(a)||(h(),cancelEvent(a))},v=()=>function(e,t){var a=()=>{t&&(t.classList.remove("im-page--chat-header_reconnected"),t.removeEventListener("mouseleave",a))};t&&(t.classList.add("im-page--chat-header_reconnected"),t.addEventListener("mouseleave",a)),e.get().longpoll.abortWaiting()}(t,e),O=Object(s.createModule)({handlers:(a,n)=>{n(e,"click","_im_page_action",c),n(e,"click","_im_action",u),n(e,"click",l.DESELECT_ALL_CLASS,g),n(e,"mouseover","_im_chat_verified",m),n(e,"mouseover","_im_header_icon",p),n(e,"mouseover","_im_page_action",_),n(e,"click","_im_header_icon",b),n(e,"click","_im_header_link",f),n(e,"click","_im_page_peer_name",f),n(e,"click","_im_chat_members",h),n(e,"click","_im_page_reconnect",v),n(e,"click","_im_page_back",e=>{checkEvent(e)||(t.get().longpoll.push([Object(d.resetPeer)()]),cancelEvent(e))})}});return Object(l.isReservedPeer)(t.get().peer)||setTimeout(()=>{t.set(o.setActions).then(r().changeActions)}),i(e,a,O,r)}},XuPN:function(e,t,a){"use strict";a.r(t),a.d(t,"useIndexer",(function(){return i}));var n=a("1nu5"),r=a("q1tI"),i=function(e,t,a){var i=Object(r.useRef)(null);i.current=i.current?i.current:new n.VkIndexer(e,t);var s=i.current,o=Object(r.useCallback)((function(e){return e.reduce((function(e,t){return e[a(t)]=!0,e}),{})}),[]),l=Object(r.useState)(e),c=l[0],d=l[1],u=Object(r.useState)(o(e)),g=u[0],m=u[1];return Object(r.useEffect)((function(){var t=o(e),n=e.filter((function(e){return!g[a(e)]})),r=c.filter((function(e){return!t[a(e)]}));(n.length||r.length)&&(n.forEach((function(e){s.add(e)})),r.forEach((function(e){s.remove(e)})),d(e),m(t))}),[e]),s}},ZVxX:function(e,t,a){"use strict";a.r(t),a.d(t,"initFailBack",(function(){return n}));a("VRzm"),a("Btvt");function n(){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||window.MediaDevices&&window.MediaDevices.getUserMedia;e&&!navigator.mediaDevices&&(navigator.mediaDevices=navigator.mediaDevices||{}),navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(t){return new Promise((function(a,n){e?e.call(navigator,t,a,n):n(new Error("NotSupported"))}))}),navigator.mediaDevices.enumerateDevices||(navigator.mediaDevices.enumerateDevices=function(){return new Promise((function(e,t){if(MediaStreamTrack&&MediaStreamTrack.getSources){var a={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources((function(t){e(t.map((function(e){return{label:e.label,kind:a[e.kind],deviceId:e.id,groupId:""}})))}))}t(new Error("NotSupported"))}))})),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(window.AudioContext.prototype.createScriptProcessor=window.AudioContext.prototype.createScriptProcessor||window.AudioContext.prototype.createJavaScriptNode)}},bP5l:function(e,t,a){"use strict";a.r(t),a.d(t,"lpLogFc",(function(){return i})),a.d(t,"longpollTestingOnFcEvents",(function(){return g})),a.d(t,"longpollTestingOnImEvents",(function(){return m}));var n=a("ERyv"),r=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),r=0;for(t=0;t<a;t++)for(var i=arguments[t],s=0,o=i.length;s<o;s++,r++)n[r]=i[s];return n};function i(e,t){for(var a=[],n=2;n<arguments.length;n++)a[n-2]=arguments[n];if(window.vk.lpConfig.debug){var i="background: "+e+"; color: white",s=new Date,o=function(e){return e<10?"0"+e.toString():e.toString()};console.log.apply(console,r(["%c "+s.getHours()+":"+o(s.getMinutes())+":"+o(s.getSeconds())+":"+s.getMilliseconds()+" "+t+" ",i],a))}}function s(){return window.lpBufferFc||(window.lpBufferFc=[]),window.lpBufferFc}function o(){return window.lpBufferIm||(window.lpBufferIm=[]),window.lpBufferIm}function l(e,t){var a;window.lpWeird||(window.lpWeird=[]),window.lpWeird.push({msg:e,ev:t,is_master:!!(null===(a=window.curNotifier)||void 0===a?void 0:a.is_server)}),setTimeout(c,1e4)}function c(){window.lpWeird&&window.lpWeird.length&&(Object(n.imWeirdLog)("fc_im_differ",{diff:window.lpWeird},!1),window.lpWeird=[])}function d(){return"im"===window.cur.module&&window.store&&window.store.get().longpoll&&!window.store.get().stopped}function u(){var e;d()&&(o().forEach((function(e){!s().find((function(t){return e.ev===t.ev}))&&e.time<Date.now()-1e3&&!e.warned&&(e.warned=!0,i("red","im not fc",e.ev),Object(n.isWeirdLogging)()&&l("im not fc",e.ev))})),s().forEach((function(e){var t=o().find((function(t){return t.ev===e.ev}));t&&t.warned&&!e.warned&&(e.warned=!0,i("red","now fc like im",e.ev),Object(n.isWeirdLogging)()&&l("now fc like im",e.ev))}))),e=Date.now()-3e4,window.lpBufferFc=s().filter((function(t){return t.time>e})),window.lpBufferIm=o().filter((function(t){return t.time>e}))}function g(e){var t;d()&&((t=s()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,0)),i.apply(void 0,r(["green","fc"],e))}function m(e){var t;d()&&((t=o()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,1100)),i.apply(void 0,r(["blue","im"],e))}window.longpollTestingOnImEvents=m},f4YT:function(e,t){e.exports={im_img_prebody:'<div class="im-prebody"> <img alt="" src="%photo%" /> </div>',im_admin_link:' (<a href="%href%" class="_im_admin_name" target="_blank">%name%</a>)',im_right_menu_tpl:'<a id="ui_rmenu_peer_%peer%" href="%href%" class="_im_peer_tab ui_rmenu_item %cls%"%attrs%>\n  <span>%label%</span>\n</a>',im_right_menu_sep:'<div class="ui_rmenu_sep"></div>',im_right_menu_ct:'<span class="ui_rmenu_count im-right-menu--count _im_r_ct">%count%</span> <button type="button" class="im-right-menu--close _im_r_cl"></button><span class="im-right-menu--text _im_r_tx">%name%</span>',im_dialogs_link_img:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank"><div class="im_grid">%photo%</div></a>',sImDialogImRowPhoto:'<div class="im_grid">%photo%</div>',im_dialogs_link:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank">%photo%</a>',im_peer_photo:'<div class="nim-peer %online_class% %modifier_class%"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> %owner_photo% </div> </div> </div>',im_contact_avatar:' <div class="nim-peer--contact-avatar nim-peer--contact-avatar_%size%">%name%</div>',im_owner_item:'<a href="%link%" class="olist_item_wrap%cls%" id="olist_item_wrap%owner_id%" >\n  <div class="olist_item clear_fix">\n    <div class="olist_item_photo_wrap %img_cls%">\n      <img class="olist_item_photo" src="%photo%"/>\n    </div>\n    <div class="olist_item_name">%name%</div>\n    <div class="olist_checkbox"></div>\n  </div>\n</a>',im_simple_name:function(){return'<div class="im-page--title %more_cls%"> <span class="im-page--title-main" title="%name_attr%" %ads_union%> <span class="im-page--title-main-in"> <a href="%href%" target="_blank" class="im-page--title-main-inner _im_page_peer_name">%name%</a> <span class="im-page--title-main-verified _im_chat_verified"></span> </span> </span> <span class="im-page--title-meta _im_page_peer_online">%online%</span> <span class="im-page--title-status _im_page_status"></span> <button class="im-page--title-reconnect _im_page_reconnect">'+getLang("mail_network_reconnect")+"</button> </div>"},im_simple_link:'<a href="%href%" class="_im_header_link" target="_blank">%content%</a>',im_selected_messages:'<span class="im-page--selected-messages-count">%label%</span> <button aria-label="%tip%" type="button" class="im-page--selected-messages-remove"></button>',im_topic:"<div class='im-topic %cls%'>%topic%</div>",im_stack_date:' <a href="%link%" class="_im_mess_link" >%date%</a>',im_dialogs_none:'<li data-list-id="002300" class="im-page--dialogs-empty"> %msg%</li>',im_dialogs_message_requests_button:'<li class="im-page--dialogs-message-requests-button _im_toggle_mr_tab" data-list-id="%list_id%"> %msg%</li>',im_dialogs_message_requests_notice:'<li class="im-page--dialogs-message-requests-notice-w" data-list-id="message_request_notice"> <div class="im-page--dialogs-message-requests-notice"> %msg% </div> </li>',im_filter:'<a class="im-page--dialogs-filter %cls%">%filter%</a>',im_drow_prebody:'<span class="nim-dialog--who">%prebody%</span> <span class="nim-dialog--inner-text">%body%</span>',im_attach_mess:' <div class="im-fwd %modifier%"> <span class="im-fwd--title"> <span class="im-fwd--title-name">%text%</span> <span class="im-fwd--date">%date%</span></span> <span class="im-fwd--close _im_fwd_close"></span> <div rel="button" tab-index="0" type="button" class="im-fwd--messages _im_will_fwd">%messages%</div> </div>',im_preloader:'<div class="im-preloader %cls%"> %preloader%</div>',im_service_row:'<ul class="ui_clean_list"> <li class="im-mess im-mess_srv _im_mess _im_mess_srv _im_mess_%message_id%" data-msgid="%message_id%" data-from="%from_id%" data-ts="%date%"> <div class="im-mess--text">%text%</div> </li> </ul>',im_chat_members:'<button type="button" class="_im_chat_members im-page--members">%name%</button>',im_vkcomgroup_members:'<span class="im-page--members im-page--members--nohover">%name%</span>',im_mess_stack:'<div class="im-mess-stack _im_mess_stack %cls%" data-peer="%peerId%" data-admin="%admin%"> <div class="im-mess-stack--photo"> <div class="nim-peer nim-peer_small fl_l"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> <a target="_blank" class="im_grid" href="%href%"><img alt="%name%" src="%photo%" /></a> </div> </div> </div> </div> <div class="im-mess-stack--content"> <div class="im-mess-stack--info"> <div class="im-mess-stack--pname"> %stack_name% <span class="im-mess-stack--tools">%messageMeta%</span> </div> </div> <ul class="ui_clean_list im-mess-stack--mess _im_stack_messages"> %messages% </ul> </div> </div>',im_mess_stack_name:'<a href="%link%" class="im-mess-stack--lnk%class%" title="" target="_blank">%name%</a>',im_message_media:'<div class="_im_msg_%type%%messageId%" class="wall_module">%attaches%</div>%text%',im_dialog_media:'<span class="nim-dialog--preview nim-dialog--preview-attach">%name%</span>',im_typing:'<div class="im-page--typing _im_typing"> <div class="im-activity %cls%"><div class="pr im-activity--icon"><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><span class="_im_typing_name">&nbsp;</span></div> </div>',ctrl_submit_hint:function(){return'<div class="reply_submit_hint_wrap" >\n  <div class="reply_submit_hint_title">'+getLang("wall_reply_submit_settings")+'</div>\n  <div class="reply_submit_hint_opts" id="">\n    <div class="radiobtn %enter_on% _im_submit_btn" data-val="0" onclick="radiobtn(this, 0, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_1")+'</div></div>\n    <div class="radiobtn %ctrl_on% _im_submit_btn" data-val="1" onclick="radiobtn(this, 1, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_2")+"</div></div>\n  </div>\n</div>"},im_day_bar:'<h5 class="im-page--history-new-bar im-page--history-new-bar_days _im_bar_date %day_class%" data-date="%date%"><span>%day%</span></h5>',im_mess_bar:function(){return'<h4 class="im-page--history-new-bar _im_unread_bar_row"><span>'+getLang("mail_new_unread_msgs")+"</span></h4>"},im_replied_message:'<div class="im-replied"> <div class="im-replied--photo-wrapper"></div> <div class="im-replied--content"> <div class="im-replied--author"> <span class="im-replied--author-link">%authorName%</span> </div> <div class="im-replied--text">%text%</div> </div> </div>',im_drow:function(){return'<li data-list-id="%peer%" class="nim-dialog _im_dialog _im_dialog_%peer% %is_unread% %is_unread_out% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <div class="nim-dialog--date _im_dialog_date">%date%</div> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <button type="button" class="nim-dialog--markre _im_dialog_markre"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w _im_dialog_name_w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--verfifed _im_dialog_verified"></span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'" role="img" ></span> <span class="nim-dialog--mute"></span> <button type="button" class="nim-dialog--star _im_dialog_star"></button> <div class="nim-dialog--peer-tags _im_dialog_peer_tags PeerTags"></div> </div> <div class="nim-dialog--text-preview"> <span class="nim-dialog--preview _dialog_body" tabindex="0">%body%</span> <span class="nim-dialog--typing _im_dialog_typing"></span><span class="nim-dialog--typer-el"></span> </div> <div class="nim-dialog--pinned-conversation" role="img"></div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <label class="blind_label _im_unread_blind_label">%unread_message_string%</label> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_conversation_search_row:function(){return'<li data-list-id="%peer%" class="nim-dialog nim-conversation-search-row _im_dialog _im_dialog_%peer% %is_unread% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer nim-peer_search %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'"></span> </div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_delete_actions:function(){return'<span class="nim-dialog--who">%text%</span> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="restore" type="button">'+getLang("mail_restore")+'</button> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="spam" type="button">'+getLang("mail_im_mark_spam")+'</button> <button class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="block" type="button">'+getLang("mail_user_black_list")+"</button>"},im_chat_change_topic:function(){return'<div class="im_change_topic_wrap clear_fix"> <div class="im_change_topic_label fl_l ta_r">'+getLang("mail_chat_topic_change_label")+'</div> <div class="im_change_topic_labeled fl_l"> <input class="text _im_chat_topic_change_input" value="%value%"/> </div> </div>'},im_msg_row:function(){return'<li class="im-mess %cls% _im_mess_noa _im_mess_%msg_id%" aria-hidden="%aria_hidden%" data-ts="%ts%" data-msgid="%msg_id%" data-peer="%from_id%"> <div class="im-mess--text wall_module _im_log_body">%text%</div> <span tabindex="0" role="link" aria-label="'+getLang("mail_select_message")+'" class="blind_label im-mess--blind-select _im_mess_blind_label_select"></span> <span class="blind_label im-mess--blind-read _im_mess_blind_unread_marker" %unread_params%></span> <span class="im-mess--marker _im_mess_marker" %marker_params%></span> </li>'},sImHistoryRowActions:function(){return'<div class="im-mess--actions"> <span role="link" aria-label="'+getLang("mail_im_mark_forward")+'" class="im-mess--forward _im_mess_forward"></span> <span role="link" aria-label="'+getLang("mail_im_reply")+'" class="im-mess--reply _im_mess_reply"></span> <span role="link" aria-label="'+getLang("mail_im_edit")+'" class="im-mess--edit _im_mess_edit"></span> <span role="link" aria-label="'+getLang("mail_important_message")+'" class="im-mess--fav _im_mess_fav"></span> </div> <div class="im-mess--check fl_l"></div>'},im_wrap_mobile:'<b class="mob_onl %class%" %attrs% onmouseover="mobileOnlineTip(this, {%params%})"></b>',im_pinned_message:'<div class="im-page-pinned _im_pinned_message"> <button class="im-page-pinned--hide _im_pin_hide"></button> <div class="im-page-pinned--meta"> <a href="%link%" target="_blank" class="im-page-pinned--name">%name%</a> <span class="im-page-pinned--date">%date%</span> </div> <div class="im-page-pinned--content">%content%</div> </div>',im_pinned_message_media:'<span class="im-page-pinned--media">%text%</span>',im_pinned_message_media_bar:'<div class="im-page-pinned--media-bar">\n  <div class="im-page-pinned--media-bar_progress" style="width: %percent%%;"></div>\n</div>',im_pinned_messages_promo:'<div class="im-page--mess-actions-promo-content">%content%</div>',im_retry_link:function(){return'<button class="im-page--retry _im_retry_media">'+getLang("mail_retry")+"</button>"},sImLblWasEdited:function(){return" <span class='im-mess--lbl-was-edited _im_edit_time' data-time='%update_time%'>"+getLang("mail_was_edited_short")+"</span>"},sImLblWasSourceInfo:function(){return" <span class='im-mess--lbl-was-edited _im_page_info' data-info='%source%'>"+getLang("mail_was_source_short")+"</span>"},im_top_banner:'<div class="im-top-banner %classes%">\n  %icon%\n  <div class="im-top-banner--text">%text%</div>\n  <div class="im-top-banner--buttons">%buttons%</div>\n</div>',im_top_banner_icon:'<div class="im-top-banner--icon">\n  <img src="%icon%" alt=""/>\n</div>',im_top_banner_button_link:'<a href="%link%" target="_blank" class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small">%text%</a>',im_top_banner_button:'<button class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small" data-payload="%callback_data%">%text%</button>',im_top_banner_hide_btn:'<button class="im-top-banner--button im-top-banner--button_hide _im_top_banner_hide"></button>',im_calls_link:'<button class="im_srv_lnk_light _fc_call_link">%text%</button>',sImPeerMuteUnmute:'<button class="_im_peer_mute_unmute im-chat-input-block-control im-chat-input-block-control--with-icon im-chat-input-block-control--%type%">%text%</button>',sImPeerAcceptOrRejectMessageRequest:function(){return"<p>"+getLang("mail_message_request_user_notice")+'</p> <p> <button type="button" class="flat_button %cls_accept%">'+getLang("mail_message_request_accept")+'</button> <button type="button" class="flat_button secondary %cls_reject%">'+getLang("mail_message_request_reject")+"</button> </p>"},sImPeerReturnToChat:'<button class="_im_peer_return_to_chat im-chat-input-block-control">%text%</button>',sImCallSnippet:'<article class="CallSnippet %classes%" %attributes%> <div class="CallSnippet__users">%user_list%</div> <div class="CallSnippet__content"> <h3 class="CallSnippet__title">%title%</h3> <div class="CallSnippet__desc">%description%</div> </div> %button%</article>',sImMessageKeyboard:'<div class="MessageKeyboard">%content%</div>',sImMessageKeyboardRow:'<div class="MessageKeyboard__row">%content%</div>',sImMessageKeyboardButton:' <span class="MessageKeyboard__cell"> <%tagName% class="MessageKeyboard__button MessageKeyboard__button--%modifier% Button Button--size-s Button--%appearance% _im_mess_btn" %attributes% > <span class="MessageKeyboard__label">%label%</span> </%tagName%> </span>',sImBomb:'<span class="im-mess-stack--bomb %classnames%"></span>',sImEmptyCasper:function(){return' <div class="im-page--casper-empty"> '+getLang("mail_im_empty_casper_chat")+" </div>"},sImExpiredMessagePlaceholder:' <div class="im-expired-message _im_expired_message %id_classes%" data-count="%count%"> <a href="/im?w=expired_messages" target="_blank" class="im-expired-message--in"> <span class="im-expired-message--inner">%text%</span> </a> </div>',sImGiftLabel:' <span class="im-mess-stack--gift">%content%</span>',sImMoneyTransferLabel:' <span class="im-mess-stack--money-transfer">%content%</span>',sUiActionsMenuSeparator:'<div class="ui_actions_menu_sep"></div>',sImUiActionMenuItem:'<a tabindex="0" role="link" class="ui_actions_menu_item im-action im-action_%icon% %classes%" data-action="%action%"> %name%</a>',sImPeerTagsItem:' <div class="PeerTagsItem _im_dialog_peer_tag" data-id="%tag_id%" style="background-color: %color%;">%name%</div>',sImPeerTagsAdTag:function(){return' <div class="PeerTagsItem PeerTagsItem--adTag %extra_class%"> <a href="%url%" target="_blank" class="PeerTagsItem__adTagLink"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </a> <button onclick="return showFastBox(\''+getLang("mail_ad_tag_no_access_box_title")+"', '"+getLang("mail_ad_tag_no_access_box_text")+'\');" class="PeerTagsItem__adTagAlert"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </button> </div>'},sImPeerTagsExtra:' <div class="PeerTagsItem PeerTagsItem--extra _im_peer_tags_extra">%text%</div>',sImPeerTagsExtraTooltipItem:' <div class="PeerTagsExtraTooltipItem"> <span class="PeerTagsExtraTooltipItem__color" style="background-color: %color%"></span> <span class="PeerTagsExtraTooltipItem__name">%name%</span> </div>',sImPeerTagsFilterItem:'<div class="PeerTagsFilterItem"> <input class="PeerTagsFilterItem__checkbox _im_peer_tags_filter_checkbox" type="checkbox" id="peer_tag_%tag_id%" %checked%> <label class="PeerTagsFilterItem__label" for="peer_tag_%tag_id%"> <span class="PeerTagsFilterItem__color" style="background-color: %color%"></span> <span class="PeerTagsFilterItem__name">%name%</span> <span class="PeerTagsFilterItem__count">%count%</span> </label> </div>',sImPeerTagsFilterPaneItem:'<div class="PeerTagsFilterPaneItem _im_peer_tags_filter_pane_item" data-id="%tag_id%"> <span class="PeerTagsFilterPaneItem__color" style="background-color: %color%"></span> <span class="PeerTagsFilterPaneItem__name">%name%</span> <span class="PeerTagsFilterPaneItem__remove"></span> </div>',sImCallUser:'<img src="%url%" alt="%name%" class="CallUsers__user">',sImCallUsers:'<div class="CallUsers"> <svg xmlns="http://www.w3.org/2000/svg" class="CallUsers__hidden"> <defs> <clipPath id="user-frame"> <path d="M12 0a12 12 0 11-7.97 20.97C5.89 18.47 7 15.37 7 12c0-3.36-1.1-6.47-2.97-8.97A11.95 11.95 0 0112 0z"/> </clipPath> </defs> </svg> <figure class="CallUsers__list"> %users% </figure> </div>',sImCallBannerContent:'<article class="CallBanner %cls%"> <div class="CallBanner__users">%user_list%</div> <div class="CallBanner__content"> <h3 class="CallBanner__title">%title%</h3> <div class="CallBanner__desc">%desc%</div> </div> </article>',sImCallBannerButton:function(){return'<button class="_im_top_banner_button _im_call_banner_join_btn im-top-banner--button flat_button button_small secondary" data-link="%call_link%">'+getLang("mail_join_chat")+"</button>"}}},"fD+e":function(e,t,a){"use strict";a.r(t),a.d(t,"TemplatesDropDown",(function(){return d}));var n=a("q1tI"),r=(a("17x9"),a("1Ot2")),i=a("6krn"),s=a("Jbbb"),o=a("n3cE"),l=a("ZxpX"),c=i.default.getLang;class d extends n.Component{constructor(){super(...arguments),this.elementOnClick=(e,t)=>{t.preventDefault(),t.stopPropagation(),this.props.applyTemplate(e),this.toggleDropdown(!1)},this.toggleDropdown=e=>{this.setState({isShowDropDown:e})},this.state={isShowDropDown:!1}}render(){var e=this.props,t=e.getTemplates,a=e.showSettingsPopup,i=e.showCreatingTemplatePopup,s=e.isNeededRendering,d=this.state.isShowDropDown;if(!s())return null;var u=t();return n.createElement("div",{className:"TemplatesDropDown",onMouseOver:this.toggleDropdown.bind(this,!0),onMouseOut:this.toggleDropdown.bind(this,!1)},n.createElement("div",{className:Object(l.classNames)("TemplatesDropDown__wrapper",{"TemplatesDropDown__wrapper--show":d}),"aria-hidden":d},n.createElement("div",{className:"TemplatesDropDown__container"},n.createElement(r.Scroll,{className:"TemplatesDropDown__scroll-wrapper"},n.createElement("div",null," ",n.createElement("header",{className:"TemplatesDropDown__header"},n.createElement("h2",{className:"TemplatesDropDown__title"},c("mail_community_templates")),n.createElement("a",{role:"button",className:"TemplatesDropDown__setting-button",onClick:a},c("mail_settings_configure"))),u.length?n.createElement("ul",{className:"TemplatesDropDown__list"},u.map(e=>n.createElement("li",{key:e.id,className:"TemplatesDropDown__item",onMouseDown:this.elementOnClick.bind(null,e.id)},n.createElement("h3",{className:"TemplatesDropDown__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesDropDown__item-content",dangerouslySetInnerHTML:{__html:e.text}})))):n.createElement("div",{className:"TemplatesDropDown__not-found-container"},n.createElement("span",null,c("mail_community_templates_not_found")),n.createElement(o.default,{onClick:i},c("mail_add_community_template"))))))),n.createElement("button",{className:"TemplatesDropDown__icon"}))}}t.default=Object(s.connect)(d)},gF8j:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return o})),a.d(t,"getVisibilityState",(function(){return d})),a.d(t,"getVisiblityEvent",(function(){return u}));var n=a("uQjJ"),r=a("PU8N"),i=new(function(){function e(){this.onVisibilityChange=this._onVisibilityChange.bind(this)}return e.prototype._onVisibilityChange=function(){this.wakeLockSentinel&&"visible"===document.visibilityState&&this.lock().then((function(){})).catch(console.error)},e.prototype.requestWakeLock=function(){var e=this;return navigator.wakeLock?this.wakeLockSentinel?Promise.resolve():navigator.wakeLock.request("screen").then((function(t){e.wakeLockSentinel=t})):Promise.reject()},e.prototype.isLocked=function(){return!!this.wakeLockSentinel&&!this.wakeLockSentinel.released},e.prototype.lock=function(){var e=this;return this.requestWakeLock().then((function(){e.wakeLockSentinel&&document.addEventListener("visibilitychange",e.onVisibilityChange)})).catch((function(){}))},e.prototype.unlock=function(){var e=this;return this.wakeLockSentinel?(document.removeEventListener("visibilitychange",this.onVisibilityChange),this.wakeLockSentinel.release().finally((function(){e.wakeLockSentinel=null}))):Promise.resolve()},e}()),s=browser.iphone||browser.ipad||browser.ipod;function o(e){this.started=!1,this.is_idle=!0,this.activeTimeStart=null,this.cbActiveB=this.cbActive.bind(this),this.cbInactiveB=this.cbInactive.bind(this),this.onVisiblityChange=this.onVisiblityChange.bind(this),this.opts=extend({triggerEvents:"mousemove keydown",onIdleCb:function(){},onUnIdleCb:function(){},focusElement:e.element,element:null,idleTimeout:3e4},e)}function l(e,t,a){Object(r.isMvk)()?window.addEvent(e,t,a,{passive:!0}):window.addEvent(e,t,a)}function c(e,t,a){Object(r.isMvk)()?window.removeEvent(e,t,a,{passive:!0}):window.removeEvent(e,t,a)}function d(){return document.visibilityState||document.webkitVisibilityState}function u(){var e="visibilitychange";return document.visibilityState||(document.webkitVisibilityState?e+="webkit":e=""),e}extend(o.prototype,n.default.prototype),extend(o.prototype,{stop:function(){this.started=!1,c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),Object(r.isMvk)()&&this._isTopLevel()&&u()&&c(document,u(),this.onVisiblityChange),Object(r.isMvk)()&&s||(c(this.opts.focusElement,"focus",this.cbActiveB),c(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactiveB)},idle:function(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")},unidle:function(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")},start:function(){this.started=!0,!Object(r.isMvk)()&&browser.mobile||(this.is_idle=!this._isFocused(),this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactiveB),Object(r.isMvk)()&&this._isTopLevel()&&u()&&l(document,u(),this.onVisiblityChange),Object(r.isMvk)()&&s||(l(this.opts.focusElement,"focus",this.cbActiveB),l(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},checkIdleCb:function(){this.started&&(l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactiveB,this.opts.idleTimeout))},cbActive:function(){this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}.bind(this),100)),c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},cbInactive:function(){this.started&&(i.isLocked()||(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}.bind(this),100)),clearTimeout(this.checkIdleCbTo),c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout)))},getActiveTime(){return!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0},onVisiblityChange(){"visible"===d()?this.cbActiveB():this.cbInactiveB()},_isTopLevel(){var e=this.opts.focusElement;return e===window||e===document},_isFocused(){var e=this.opts.focusElement;if(this._isTopLevel()){var t=d();return"string"==typeof t&&"visible"===t}return document.activeElement===e}})},hGJG:function(e,t,a){"use strict";a.r(t),a.d(t,"uploadConvoPhoto",(function(){return s}));var n=a("jE6c"),r=a("kcIO"),i=a("Iqrf");function s(){var e=2e9+Math.round(Object(n.rand)(1e6,2e6));return new Promise((function(t){window.cur.recieveCropResult=function(a){window.cur.recieveCropResult=!1,Object(i.ownerPhoto)(JSON.parse(a).data[0],e).then((function(e){var n=Array.isArray(e)?e[0]:e;t({photo:n,photoData:a}),Object(r.curBox)()&&Object(r.curBox)().hide(!0)}),(function(){}))},window.Page.ownerPhoto(e),Object(r.curBox)().setOptions({onHideAttempt:function(e){return e||t({}),!0}})}))}},hOuX:function(e,t,a){"use strict";a.r(t),a.d(t,"MAX_SAFE_INTEGER",(function(){return n})),a.d(t,"MAX_INTERGER",(function(){return r})),a.d(t,"random",(function(){return i}));a("tuSo");var n=9007199254740991,r=2147483647;function i(){try{if(window.crypto){var e=new Int32Array(1);return crypto.getRandomValues(e),Math.abs(e.reduce((e,t)=>e+t))}}catch(e){}return intval(rand(0,r).toFixed(0))}},m5nf:function(e,t,a){"use strict";a.r(t),a.d(t,"MAIN",(function(){return _})),a.d(t,"EDIT",(function(){return b}));a("pIFo"),a("91GP"),a("VRzm"),a("Btvt");var n=a("q1tI"),r=(a("17x9"),a("6krn")),i=a("amDN"),s=a("Jbbb"),o=a("BiHW"),l=a("1Ot2"),c=a("n3cE"),d=a("V1lx"),u=a("LYnS"),g=a("vT4u"),m=a("nAFc"),p=a("EasH"),_="main",b="edit";class h extends n.Component{constructor(){super(...arguments),this.setEditableMessage=e=>{var t=e.id,a=e.name,n=e.text;return new Promise(e=>this.setState({editableMessage:{id:t,name:a,text:n}},e))},this.onChangeEditableMessage=(e,t)=>this.setEditableMessage(Object.assign({},this.state.editableMessage,{[e]:Object(m.escape)(t)})),this.deleteTemplate=e=>Promise.resolve().then(()=>this.state.section!==_?this.go(_):Promise.resolve()).then(()=>this.props.store.set(g.deleteTemplate.bind(null,e))).catch(()=>{Object(p.showFastBox)(Object(r.getLang)("mail_error"),Object(r.getLang)("mail_community_templates_delete_error"))}),this.saveTemplate=e=>{e.preventDefault();var t=this.state.editableMessage,a=t.name,n=t.text;a.length>200||a.length<2||a.length>2e3||n.length<5?Object(p.showFastBox)(Object(r.getLang)("mail_error"),Object(r.getLang)("mail_form_is_filled_in_incorrectly")):this.props.saveTemplate(t).catch(()=>{Object(p.showFastBox)(Object(r.getLang)("mail_error"),Object(r.getLang)("mail_community_templates_save_error"))}).then(()=>this.go(_))},this.addHint=(e,t)=>{t.preventDefault();var a=this.state.editableMessage,n=a.id,r=void 0===n?null:n,i=a.name,s=a.text;return Object(d.setHTML)(this.textarea,`{${e.id}}`),this.setEditableMessage({id:r,name:i,text:`${s}{${e.id}} `})},this.getTextAreaRef=e=>{this.textarea=(e||{}).container},this.state={section:this.props.section,editableMessage:{id:null,name:"",text:""}}}go(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.id,n=void 0===a?null:a,r=t.name,i=void 0===r?"":r,s=t.text,o=void 0===s?"":s;return new Promise(t=>{this.state.section!==e?this.setState({section:e,editableMessage:{id:n,name:i,text:o}},()=>{this.props.popup.updateBoxCoords(),t()}):t()})}render(){var e=this.props,t=e.getTemplates,a=e.closePopup,s=this.state,g=s.section,m=s.editableMessage,p=t();return n.createElement("section",{className:"TemplatesSettings"},n.createElement(i.default,{title:n.createElement("span",{className:"TemplatesSettings__title"},g===_&&Object(r.getLang)("mail_community_templates"),g===b&&Object(r.getLang)("mail_add_community_template")),onCloseClick:a}),n.createElement("main",{className:"TemplatesSettings__content"},g===_&&(p.length?n.createElement(l.Scroll,{className:"TemplatesSettings__scroll-wrapper"},n.createElement("div",{className:"TemplatesSettings__list"},p.map(e=>n.createElement("section",{key:e.id,className:"TemplatesSettings__item"},n.createElement("h3",{className:"TemplatesSettings__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesSettings__item-content",dangerouslySetInnerHTML:{__html:e.text}}),n.createElement("div",{className:"TemplatesSettings__buttons-row"},n.createElement(c.default,{onClick:()=>this.go(b,e),className:"TemplatesSettings__item-button"},Object(r.getLang)("mail_settings_edit")),n.createElement("span",{className:"TemplatesSettings__buttons-splitter","aria-hidden":"true"}," ","·"," "),n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,e.id),className:"TemplatesSettings__item-button"},Object(r.getLang)("mail_delete"))))))):n.createElement("div",{className:"TemplatesSettings__not-found-container"},n.createElement("span",null,Object(r.getLang)("mail_community_templates_not_found")),n.createElement(c.default,{onClick:()=>this.go(b)},Object(r.getLang)("mail_add_community_template")))),g===b&&n.createElement("form",{className:"TemplatesSettings__form",id:"create_template_form",onSubmit:this.saveTemplate},n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"name"},Object(r.getLang)("mail_name"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"name",type:"text",initialValue:m.name,className:"TemplatesSettings__input",onChange:this.onChangeEditableMessage.bind(null,"name")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(r.getLang)("mail_community_templates_input_size").replace("{min}",2).replace("{max}","200")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"text"},Object(r.getLang)("mail_text"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"text",name:"text",isMultiLine:!0,ref:this.getTextAreaRef,initialValue:m.text,className:"TemplatesSettings__textarea",onChange:this.onChangeEditableMessage.bind(null,"text")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(r.getLang)("mail_community_templates_input_size").replace("{min}",5).replace("{max}","2 000")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label"},Object(r.getLang)("mail_hints"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},Object(u.default)().map(e=>n.createElement(o.default,{type:"button",onMouseDown:this.addHint.bind(null,e),appearance:"secondary",className:"TemplatesSettings__hint",key:e.id},e.label)))))),n.createElement("footer",{className:"TemplatesSettings__footer"},g===_&&n.createElement(n.Fragment,null,n.createElement(c.default,{onClick:()=>this.go(b)},Object(r.getLang)("mail_add_community_template")),n.createElement(o.default,{onClick:a},Object(r.getLang)("mail_close"))),g===b&&n.createElement(n.Fragment,null,n.createElement("div",null,m.id&&n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,m.id)},Object(r.getLang)("mail_delete_community_template"))),n.createElement("div",null,n.createElement(o.default,{appearance:"tertiary",onClick:()=>this.go(_)},Object(r.getLang)("mail_cancel")),n.createElement(o.default,{onClick:this.saveTemplate,form:"create_template_form",type:"submit"},Object(r.getLang)("mail_save"))))))}}h.defaultProps={section:_},t.default=Object(s.connect)(h)},nJdr:function(e,t,a){"use strict";a.r(t),a.d(t,"createLongpoll",(function(){return b}));var n=a("DM26"),r=a("ER42"),i=a("eaP7"),s=function(){return(s=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function o(e,t){e.waitAbortFns.push(t)}function l(e){if(e.isStoppedFn())return Promise.resolve({ts:0,updates:[]});var t=Object(r.plaingetCancelable)(e.url,{act:"a_check",key:e.key,version:e.version,ts:e.ts,wait:25,mode:e.mode}),a=t.request,i=t.cancel;return e.stopFn=i,window.lpDebug={startedAt:Date.now(),finishedAt:null,error:!1,request:a,cancel:i},a.then((function(t){var a=t[0],n=t[1];return window.lpDebug&&(window.lpDebug=s(s({},window.lpDebug),{finishedAt:Date.now(),request:null,cancel:null})),e.onData(e,n),e.waitTimeout=2,JSON.parse(a)})).catch((function(t){var a=t[1];return window.lpDebug&&(window.lpDebug=s(s({},window.lpDebug),{finishedAt:Date.now(),error:!0,request:null,cancel:null})),e.onData(e,a),Promise.reject(new Error(""))})).then((function(t){return function(e,t){var a=t.failed?Object(n.abortablePause)(4,null):{abort:function(){},pause:function(){return Promise.resolve()}},r=a.abort,i=a.pause;switch(t.failed){case 1:return o(e,r),e.onHistoryLost(e,t).then((function(){return e.onResult({ts:t.ts,updates:[[-1]]})})).then(i).then((function(){return l(e)}));case 2:return o(e,r),e.onKeyExpired(e,t).then((function(t){var a=t[0],n=t[1],r=t[2],i=t[3];return e.onResult({ts:+i,updates:[[-2,a,n+"/"+r],[-1]]})})).then(i).then((function(){return l(e)}));case 3:return e.onLpBroken(e,t);default:return Promise.resolve(t)}}(e,t)}))}function c(e){e.isStoppedFn()||l(e).then(e.onResult.bind(e)).then((function(){return e.isReconnecting&&d(e,-5)})).catch((function(t){return function(e,t){if(e.isStoppedFn())return;e.onRequestError(t),e.waitTimeout=Math.min(60,2*e.waitTimeout),d(e,-3);var a=Object(n.abortablePause)(e.waitTimeout,null),r=a.abort,i=a.pause;return o(e,r),i().then((function(){return d(e,-4)}))}(e,t)})).then((function(){return c(e)}))}function d(e,t){e.isReconnecting=-4===t,e.onResult({ts:e.ts,updates:[[t,e.waitTimeout]]})}function u(e){return e||function(){}}function g(e){return e?function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];return Promise.resolve(e.apply(void 0,t))}:function(){return Promise.reject()}}var m=a("bP5l"),p=a("vT4u"),_=a("XzvV");function b(e,t){return function(e,t){var a=!!e.stopped,n={id:e.id,key:e.key,ts:e.ts,url:e.url,lpstat:e.lpstat||0,version:e.version||14,mode:1226,waitTimeout:2,waitAbortFns:[],isReconnecting:!1,isStoppedFn:function(){return a},onResult:function(e){e.ts&&s(n.ts,e.ts,e.updates.map(i.constructEvent))},onData:u(t.onData),onRequestError:u(t.onRequestError),onHistoryLost:g(t.onHistoryLost),onKeyExpired:g(t.onKeyExpired),onLpBroken:g(t.onHistoryLost)},r=t.onEvents;function s(e,t,a){n.ts=t;for(var s=0;s<a.length;++s)a[s].type===i.REFRESH_LP_KEY&&(n.key=a[s].key||"",n.url=a[s].url||"");r(e,t,a)}var o={options:n,isStopped:function(){return a},stopConnection:function(){a=!0,n.stopFn&&n.stopFn(),n.stopFn=void 0,document.removeEventListener("resume",l),this.abortWaiting()},reinitConnection:function(){this.stopConnection(),document.addEventListener("resume",l),d(n,-4),a=!1,c(n)},abortWaiting:function(){n.waitAbortFns.forEach((function(e){return e()})),n.waitAbortFns=[],n.waitTimeout=2},onLp:s};function l(){o.abortWaiting()}return document.addEventListener("resume",l),c(n),o}(e,{onEvents:t,onData:v,onRequestError:O,onHistoryLost:y,onKeyExpired:j,onLpBroken:C})}var h={},f=Date.now();function v(e,t){if(t&&t.status&&e.lpstat){var a=t.status.toString();t.status>=500&&t.status<600&&Object(_.statlogsValueEvent)("fc_longpoll",1,a,t.getResponseHeader("x-frontend")||""),h[a]=a in h?h[a]+1:1,Date.now()-f>=3e4&&(Object.keys(h).forEach((function(e){Object(_.statlogsValueEvent)("fc_longpoll",h[e],e,t.getResponseHeader("x-frontend")||"")})),h={},f=Date.now())}}function O(e){Object(m.lpLogFc)("red","LP error",e.message||"no message (probably browser reset)")}function y(e,t){Object(m.lpLogFc)("red","LP failed: old timestamp; resync, next ts",t.ts)}function j(e){return Object(m.lpLogFc)("red","LP failed: key is incorrect; refresh key"),Object(r.post)(p.CONTROLLER,{act:"a_get_key",uid:e.id,gid:e.id<0?-e.id:0},1e3)}function C(){throw window.nav.reload({force:!0}),new Error("ts is very wrong")}},q2pz:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return F}));var n,r=a("ofcU"),i=a("q1tI"),s=a.n(i),o=a("i8i4"),l=a.n(o),c=a("e87a"),d=a("6krn"),u=a("euvX"),g=function(e){var t=e.title,a=e.onCloseModal,n=e.footer,r=e.isWithBackButton,i=void 0!==r&&r,o=e.onBackClick,l=e.children;return s.a.createElement(c.default,{className:"UserConvoInviteModal",disableBodyScroll:!0,onClose:a},s.a.createElement(u.ModalHeader,{title:t,onClose:a,appearance:"blue",backText:i?Object(d.getLang)("global_back"):void 0,onBack:o,className:"UserConvoInviteModal__header"}),s.a.createElement("div",{className:"UserConvoInviteModal__content"},l),n)},m=a("5PZO"),p=a("wQFj"),_=a("J4gp"),b=a("zjLC");!function(e){e.ALL="all",e.UNREAD="unread",e.IMPORTANT="important",e.UNANSWERED="unanswered",e.MESSAGE_REQUEST="message_request",e.BUSINESS_NOTIFY="business_notify",e.CHATS="chats"}(n||(n={}));var h=a("kxld"),f=a("EasH"),v=a("QDnf"),O=a("shih"),y=a("4+be"),j=a("4edV"),C=a("pdqG"),w=a("rudk"),E=a("DM26"),T=a("XuPN"),S=a("6x51"),I=a("Iqrf"),k=Object(E.debouncedPromise)(O.searchHints,300),M=function(){return!0};var P,L=a("ErRf"),A=a("1MUc"),D=a("hGJG"),B=d.default.getLang;!function(e){e[e.PICKER=0]="PICKER",e[e.CREATION=1]="CREATION"}(P||(P={}));var x=function(e){var t=e.user,a=e.store,r=e.onClose,o=e.onInviteSent,l=e.onGoToConvo,c=Object(i.useState)(P.PICKER),d=c[0],u=c[1],E=Object(i.useState)(!function(e){var t,a=e.get(),n=a.chatList||(null===(t=a.dialog_tabs)||void 0===t?void 0:t.all);return Boolean(n&&n.length>0)}(a)),x=E[0],N=E[1],R=Object(i.useState)(!0),F=R[0],H=R[1],U=Object(i.useState)(!1),G=U[0],q=U[1],K=Object(i.useState)(function(e){var t,a=e.get(),n=a.chatList||((null===(t=a.dialog_tabs)||void 0===t?void 0:t.all)||[]).filter(w.isChatPeer);if(n&&n.length>0)return n.map((function(t){return Object(h.getTab)(e,t)}));return[]}(a)),V=K[0],W=K[1],z=Object(i.useState)(""),Y=z[0],$=z[1],X=Object(i.useCallback)((function(e){$(e.target.value)}),[Y]),Q=Object(i.useCallback)((function(){}),[]),J=Object(i.useRef)(null),Z=function(e,t,a,n){var r=Object(i.useState)(t),s=r[0],o=r[1],l=Object(i.useState)(!1),c=l[0],d=l[1],u=Object(i.useRef)(a),g=Object(i.useCallback)((function(e){return e.name}),[]),m=Object(i.useCallback)((function(e){return e.peerId}),[]),p=Object(T.useIndexer)(t,g,m),_=Object(i.useCallback)((function(e){return n.filterFn?e.filter(n.filterFn):e}),[n.filterFn]);return Object(i.useEffect)((function(){if(u.current=a,a){var r=p.search(a),i=r.map((function(e){return e.peerId}));o(_(r)),d(!0),k(a,i,n.queryType||I.HintsSearchType.ALL,n,e.get()).then((function(e){u.current===a&&(o(Object(S.mergeConvoLists)(r,e,n.filterFn||M)),d(!1))})).catch((function(){}))}else o(_(t)),d(!1)}),[a,t]),[s,c]}(a,V,Y,{queryType:I.HintsSearchType.ALL,filterFn:function(e){return Object(w.isChatPeer)(e.peerId)}}),ee=Z[0],te=Z[1];Object(i.useEffect)((function(){return Object(O.loadConversations)(a.get(),n.CHATS,200).then((function(e){var t=e.items;return W(Object(S.mergeConvoLists)(V,t)),t})).then((function(e){var t=e.reduce((function(e,t){return e[t.peerId]=t,e}),{});return a.set((function(a){return Object(C.mergeTabs)(t,a).then((function(t){return Object(j.setChatList)(t,e.map((function(e){return e.peerId})))}))}))})).finally((function(){return N(!1)})),Object(L.cancelStackPush)("convo_invite",(function(){})),function(){setTimeout((function(){return Object(L.cancelStackFilter)("convo_invite")}),0)}}),[]);var ae=t.inv_name?Object(y.langStr)(Object(y.langSex)(t.sex,B("mail_im_invite_user",!0)),"user",t.inv_name):B("mail_convo_invite_title");return s.a.createElement(s.a.Fragment,null,d===P.PICKER&&s.a.createElement(g,{title:ae,onCloseModal:r,footer:s.a.createElement(m.ModalFooter,null,s.a.createElement(p.default,{checked:F,onChange:function(e,t){return H(t)}},B("mail_im_chat_add_members_show_history")))},s.a.createElement(_.ConvoPicker,{convos:ee.map((function(e){return Object(h.getTab)(a,e.peerId)||e})),searchValue:Y,onSearchValueChange:X,onSearchInputKeydown:Q,onConvoSelect:function(e){q(!0),Promise.resolve().then((function(){return a.set((function(a){return Object(b.addNewMember)(e,[t.id],F,a)}))})).then((function(){return o(e)})).then((function(){r(),q(!1)})).catch((function(e){q(!1),Object(f.showFastBox)(B("global_error"),e)}))},checkDisabled:function(e){return!e.canInvite},searchInputGetter:function(e){return J.current=e},isLoading:x||te&&0===ee.length,style:{height:410},onAddClick:function(){return u(P.CREATION)}})),d===P.CREATION&&s.a.createElement(A.ChatCreation,{store:a,uploadAvatar:D.uploadConvoPhoto,onClose:r,onBack:function(){return u(P.PICKER)},onCreateChat:function(e){o(e).then((function(){}),(function(){})),r()},onGoToConvo:function(e){l(e),r()},preselectedUsers:[{id:t.id,peerId:t.id,name:t.name,photo:t.photo}]}),G&&s.a.createElement(v.default,null))};function N(){var e="_im_user_convo_invite",t=document.getElementById(e);if(t)return t;var a=document.createElement("section");return a.setAttribute("id",e),document.body.appendChild(a),a}function R(e){return{unmount:function(){var t=N();t&&l.a.unmountComponentAtNode(t),Object(r.destroyModule)(e)}}}function F(e,t,a,n){var i=(0,Object(r.createMutations)(R).bindMutations)(Object(r.createModule)({handlers:function(){}}));return function(e,t,a,n,r){var i=N();l.a.render(s.a.createElement(x,{user:a,store:e,onClose:t.unmount,onInviteSent:n,onGoToConvo:r}),i)}(e,i,t,a,n),i}},rCUf:function(e,t,a){"use strict";a.r(t),a.d(t,"getUploadVideoExtMasks",(function(){return i})),a.d(t,"getUploadModule",(function(){return o})),a.d(t,"onVideoUploaded",(function(){return l}));a("91GP"),a("pIFo");var n=a("EasH"),r=a("8h6g");function i(e){var t=r.VIDEO_UPLOAD_EXTS.slice(0,r.VIDEO_UPLOAD_EXTS.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+r.VIDEO_UPLOAD_EXTS.join(",."):""}function s(e){if(!cur.leaving){var t=getLang("video_upload_changed"),a=!1;if(each(window.cur.videoUploaders,(e,t)=>{Upload.isSomethingUploading(t)&&(a=!0)}),1===e){if(!a)return!0;var r=Object(n.showFastBox)({title:getLang("global_warning"),dark:!0},t,getLang("global_continue"),(function(){cur.leaving=!0,r.hide(),cur.onContinueCb&&cur.onContinueCb()}),getLang("global_cancel"),(function(){r.hide(),nav.objLoc.section="upload",nav.setLoc(nav.objLoc)}));return!1}return a?winToUtf(t.replace(/<\/?b>/g,"").replace(/<br\s*\/?>/g,"\n")):void 0}}function o(e,t,a,o,c){if(a){o=o||cur,(c=c||{}).onUploadStart||(c.onUploadStart=e=>{boxQueue.hideLast(),cur.nav.push((function(e,t,a){if(!1===s(1))return cur.onContinueCb=nav.go.pbind(a),!1})),cur.prevBefUnload=window.onbeforeunload,window.onbeforeunload=s,c.onUploadProgress(e,0,0),Wall.showEditPost&&Wall.showEditPost(),c.onUploadStartDone&&c.onUploadStartDone()}),c.onUploadComplete||(c.onUploadComplete=(e,t)=>{var a=window.parseJSON(t);a.video_id?l(e,a,o):"string"==typeof t&&t.indexOf("TERMINATED")>-1||Upload.onUploadError(e);c.onUploadCompleteDone&&c.onUploadCompleteDone(),setTimeout(()=>{c.onUploadAllCompleteDone&&!window.Upload.isSomethingUploading(e.ind)&&c.onUploadAllCompleteDone()})}),c.onUploadProgress||(c.onUploadProgress=(e,t,a)=>{var n=void 0!==e.ind?e.ind:e;show("_im_media_preview"),o.showMediaProgress&&o.showMediaProgress("video",n,function(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}(e,t,a))}),c.onUploadError||(c.onUploadError=(e,t)=>{statlogsValueEvent("upload_video_fails",1,a.options.server,t),function(e){var t=void 0!==e.ind?e.ind:e,a=e.fileName?t+"_"+e.fileName:e;if(re("upload"+a+"_progress_wrap"),!geByClass1("popup_box_container")){var r=getLang("video_upload_error");setTimeout(Object(n.showFastBox)({title:getLang("global_error")},r).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+t)||{}).action}),Upload.embed(t)}(e)}),cur.maxFiles=(cur.chooseParams||{}).maxFiles||10;var d=cur.maxFiles-(cur.savedVideos||[]).length,u=browser.safari?"":"video/*,"+i("accept");a.lang&&(cur.lang=extend(cur.lang||{},a.lang));var g={accept:u,file_input:null,file_name:"video_file",file_size_limit:1024*(a.options.file_size_limit_in_GB||r.VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB)*1024*1024,file_types_description:"Video files",file_types:i("types"),chooseBox:1,chunked:1,chunkSize:r.VIDEO_UPLOAD_CHUNK_SIZE,clear:1,dragEl:t===boxLayerWrap?boxLayerWrap:bodyNode,dropbox:t,from:a.vars.from,lang:a.lang,max_attempts:3,max_files:d,multiple:1,multi_progress:1,requestOptionsForFile:!0,type:"video",visibleDropbox:!a.options.hasOwnProperty("visible_dropbox")||a.options.visible_dropbox},m=Upload.init(e,"",{},Object.assign(g,c));return window.cur.videoUploaders||(window.cur.videoUploaders=[]),window.cur.videoUploaders.push(m),m}}function l(e,t,a,r){a=a||cur;var i=void 0!==e.ind?e.ind:e,s=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),o=s?i+"_"+s:e,l=t.owner_id+"_"+t.video_id,c=cur.isSnippetVideoSelection&&cur.chooseSnippetVideo,d=ge("upload"+o+"_progress_wrap");d&&hide(geByClass1("progress_x",d)),ajax.post("al_video.php?act=a_videos_attach_info",{videos:l},{onDone:e=>{c||a.chooseMedia("video",l,extend(e[l],{upload_ind:o,upload_new:!0}));var i=t.owner_id,s=t.video_id,d=t.video_hash,u=0,g=()=>{ajax.post("al_video.php?act=encode_progress",{oid:i,vid:s,hash:d,need_thumb:1},{onDone:t=>{var d,u=!0;if(t){if(t.error)return d=getLang("video_upload_encode_error"),void setTimeout(Object(n.showFastBox)({title:getLang("global_error")},d).hide,2e3);t.thumb&&(u=!1,ajax.post("al_video.php",{act:"a_video_photo_sizes",oid:i,vid:s},{onDone:t=>{if(cur.isSnippetVideoSelection&&cur.chooseSnippetVideo)return cur.chooseSnippetVideo(l,t),void re("upload"+o+"_progress_wrap");a.hasChosenMedia("video",l)?a.updateChosenMedia("video",l,extend(t,{upload_ind:o,upload_new:!0})):r&&r(e,l)}}))}u&&(c||a.hasChosenMedia("video",l))&&setTimeout(g,1e3)},onFail:()=>{++u<3&&setTimeout(g,2e3*u)}})};g()}})}t.default={getUploadModule:(e,t,a,n,r)=>o(e,t,a,n,r),initModalVideoUploader(e){var t=cur.videoUploadParams,a=ge("choose_video_upload");if(!a)return!1;this.initDragEvents();var n={};return"article"===e&&(n.onUploadProgress=()=>{}),o(a,boxLayerWrap,t,null,n)},initDragEvents(){var e,t=e=>{cur.dragTimeout&&(clearTimeout(cur.dragTimeout),delete cur.dragTimeout);var t=ge("video_choose_upload_area_wrap");if(!hasClass(t,"video_choose_upload_area_enter")){addClass(t,"video_choose_upload_area_enter");var a=ge("video_choose_wrap"),n=getXY(a)[1],r=getSize(t)[1];return hide("video_choose_wrap"),setStyle(t,"height",scrollGetY()+window.clientHeight()-n+r),cancelEvent(e)}},a=e=>cancelEvent(e),n=e=>{if(a(),e.dataTransfer.files.length&&Upload.checkFilesSizes(window.videoInlineUploader,e.dataTransfer.files))return window.Upload&&Upload.checked&&Upload.checked[window.videoInlineUploader]&&Upload.onFileApiSend(window.videoInlineUploader,e.dataTransfer.files),cancelEvent(e)},r=()=>{addEvent(boxLayerWrap,"dragenter dragover",t),addEvent(boxLayerWrap,"dragleave",a),addEvent(boxLayerWrap,"drop",n)};r();var i=null===(e=curBox().getOptions())||void 0===e?void 0:e.onHide;setTimeout(curBox().setOptions.pbind({onHide:()=>{if(removeEvent(boxLayerWrap,"dragenter dragover",t),removeEvent(boxLayerWrap,"dragleave",a),removeEvent(boxLayerWrap,"drop",n),"function"==typeof i)return i()},onShow:()=>{r()}}),0)}}},t7TG:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return D}));a("VRzm"),a("Btvt");var n=a("ofcU"),r=a("q1tI"),i=a("i8i4"),s=a("Jbbb"),o=(a("91GP"),a("HEwt"),a("a1Th"),a("rGqo"),a("rE2o"),a("ioFf"),a("Vd3H"),a("17x9"),a("amDN")),l=a("3blr"),c=a("J4gp"),d=a("vT4u"),u=a("DM26"),g=a("P13b"),m=a("rHUl"),p=a("kxld"),_=a("rDjD"),b=a("6krn"),h=a("O8ze"),f=a("ZxpX"),v=a("rjmT"),O=a("EasH"),y=a("6x51");function j(){return(j=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function C(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,r=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){r=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return w(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return w(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var E=Object(u.debouncedPromise)(d.searchHints,300),T=b.default.getLang;class S extends r.Component{constructor(e){var t;super(e),t=this,this.toggleMode=()=>{var e=this.props.store;if(Object(m.isCommunityInterface)(e)){var t=0===this.state.mode?1:0,a=0===t?d.searchImTopConv:d.searchTopConv;this.setState({value:"",mode:t,loading:!0,selected:null,found:[]},()=>a("",e.get()).then(e=>this.setSearchResults(this.filterResults(e))).then(()=>this.searchInput.focus()).catch(e=>console.error(e)))}},this.onChange=e=>{this.setState({value:e.target.value,loading:!0,error:null});var t=e.target.value;this.searchQuery!==t&&(this.searchQuery=t,this.onSearch(t))},this.filterResults=e=>{var t=Object(m.isCommunityInterface)(this.props.store)&&1===this.state.mode;return e.filter(e=>{var a=e.peerId;return!(t&&a<0)&&(!(t&&a>2e9&&!Object(p.doesChatTabHaveFlag)(e,1024))&&!(!t&&a>2e9&&Object(p.doesChatTabHaveFlag)(e,1024)))})},this.onSearch=e=>{var t=this.props.store,a=t.get(),n=Object(m.isCommunityInterface)(t)&&0===this.state.mode,r=n?d.searchImTopConv:d.searchTopConv;return 1===this.state.mode&&""===e?this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}):r(e,a).then(t=>{var r=t.map(e=>e.peerId);return t=this.filterResults(t),this.setSearchResults(t,!1,!t.length),e?E(e,r,"all",{hidegid:n},a):Promise.resolve([])}).then(t=>{e===this.state.value&&this.setSearchResults(this.filterResults(t),!0)}).catch(()=>{})},this.emptySearch=()=>{var e=this.props.store,t=e.get(),a=t.dialog_tabs.all,n={},r={};return Object(d.searchTopConv)("",t).then(i=>(i.forEach(e=>{r[e.peerId]=e}),[t.peer].concat(a.filter(e=>e!==t.peer)).map(t=>{var a=Object(m.getTab)(e,t);return n[t]=!0,{name:r[t]&&r[t].tab||a.tab,photo:r[t]&&r[t].photo||a.photo,lastmsg:a.lastmsg,major_sort_id:a.major_sort_id,minor_sort_id:a.minor_sort_id,data:a.data,peerId:t}}).concat(i.filter(e=>!n[e.peerId])).sort((a,n)=>a.peerId===t.peer?-1:n.peerId===t.peer?1:Object(y.sortFn)(e,a,n))))},this.sendRecipient=e=>{var t=this.props.store,a=t.get();1===this.state.mode?(a.longpoll.push([Object(_.changePeer)(e,!1,!0,!0,"forward_messages_popup")]),Object(h.statlogsForwardEvent)(t),Object(m.isCommunityInterface)(t)&&Object(h.statlogsForwardFromCommunityEvent)(t,!1)):this.setState({selected:e,error:null},()=>{Emoji.focus(this.input)})},this.loadMore=()=>{},this.getSearchInputEl=e=>this.searchInput=e,this.setSearchResults=function(e,a){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t.unmounted)if(a){var r=e.filter(e=>!t.found[e.peerId]);r.forEach(e=>{t.found[e.peerId]=!0}),t.setState({found:[].concat(t.state.found,r),loading:n})}else t.found=e.reduce((e,t)=>(e[t.peerId]=!0,e),{}),t.setState({found:e,loading:n,activeElement:0})},this.getFormRef=e=>{this.form=e},this.getInputRef=e=>{this.input=e},this.getEmojiButtonRef=e=>{this.emojiButton=e},this.onEmojiButtonMouseOver=e=>{e.persist(),Emoji.show(this.emojiButton,e)},this.onEmojiButtonMouseOut=e=>{e.persist(),Emoji.hide(this.emojiButton,e)},this.send=()=>{var e=this.props.store,t=this.state.selected,a=Emoji.val(this.input).trim(),n=new v.ImDraft({},0),r=e.get().pendingForward;if(t&&!Object(g.isMessageTooLong)(val)){this.setState({sending:!0});var i=Object(m.isCommunityInterface)(e)&&0===this.state.mode;i||n.addAttach("mail",r.msgIds.join(";"),r.object||null);var s={message:a,attaches:n.dData.attaches.map(e=>[e.type,e.id])||[]},o={hidegid:!0,external:{original_gid:e.get().id,fwd_group_msg_ids:i?r.msgIds.join(";"):void 0}};new Promise(a=>{Object(d.loadHashes)([t],{hidegid:!0},e.get()).then(e=>{var n=C(e,1)[0];return a(n[t])})}).then(a=>e.set(d.sendMessage.bind(null,t,s,j({hash:a},o)))).then(()=>{Object(h.statlogsForwardFromCommunityEvent)(e,!0),e.setState({pendingForward:null}),this.props.closePopup(),showDoneBox(T("mail_send3"))}).catch(e=>{this.unmounted||this.setState({sending:!1},()=>{Object(O.showFastBox)(T("mail_error"),e)})})}},this.onSearchKeyDown=e=>{27===e.keyCode&&this.state.value&&(this.searchInput.blur(),this.searchQuery="",this.setState({value:"",loading:!0,error:null},this.onSearch.bind(this,"")),e.stopPropagation())},this.onMessageInputKeyDown=e=>{27===e.keyCode&&(this.state.sending||(Emoji.val(this.input,""),this.setState({selected:null}),this.searchInput.focus()),e.stopPropagation())},this.state={value:"",found:[],mode:1,loading:!0,sending:!1,selected:null,activeElement:0},this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}).catch(e=>console.error(e))}componentDidMount(){this.props.updatePopup(),Emoji.init(this.input,{noStickers:!0,onSend:this.send}),this.input.addEventListener("keydown",this.onMessageInputKeyDown)}componentWillUnmount(){this.input.removeEventListener("keydown",this.onMessageInputKeyDown),this.unmounted=!0}render(){var e=this.props,t=e.store,a=e.closePopup,n=this.state,i=n.mode,s=n.loading,d=n.selected,u=n.found,g=n.sending,p=Object(f.classNames)("MessageForward",{"MessageForward--form":0===i&&!!d});return r.createElement("section",{className:p},r.createElement(o.default,{title:r.createElement(r.Fragment,null,r.createElement("span",{className:"MessageForward__title"},T("mail_forward_messages")),Object(m.isCommunityInterface)(t)&&r.createElement("span",{className:"MessageForward__switch",onClick:this.toggleMode},T(0===i?"mail_forward_to_community_messages":"mail_forward_to_im"))),onCloseClick:a}),r.createElement("div",{className:"MessageForward__content"},r.createElement(c.ConvoPicker,{searchValue:this.state.value,isLoading:s,convos:u.map(e=>e||Object(m.getTab)(t,e.peerId)),mode:1===i?c.convoPickerMode.DEFAULT:c.convoPickerMode.RADIO,selectedConvos:[d],onSearchValueChange:this.onChange,onSearchInputKeydown:this.onSearchKeyDown,onConvoSelect:this.sendRecipient,onListLoadMore:this.loadMore,searchInputGetter:this.getSearchInputEl,className:"MessageForward__convoPicker"}),r.createElement("footer",{className:"MessageForward__footer",ref:this.getFormRef,key:"footer"},r.createElement("div",{className:"MessageForward__form _emoji_field_wrap"},r.createElement("div",{className:"MessageForward__input",tabIndex:"0",contentEditable:!0,role:"textbox","aria-multiline":!0,ref:this.getInputRef,placeholder:T("mail_im_enter_msg")}),r.createElement("div",{className:"MessageForward__emoji emoji_smile_wrap _emoji_wrap"},r.createElement("div",{ref:this.getEmojiButtonRef,className:"emoji_smile _emoji_btn",title:T("global_emoji_hint"),onMouseOver:this.onEmojiButtonMouseOver,onMouseOut:this.onEmojiButtonMouseOut,onClick:this.onEmojiButtonClick},r.createElement("div",{className:"emoji_smile_icon_vector emoji_smile_icon"})))),g?r.createElement("div",{className:"MessageForward__send-spinner"},r.createElement(l.default,null)):r.createElement("button",{className:"MessageForward__send",onClick:this.send}))))}}var I,k=Object(s.connect)(S);function M(){I&&I.hide()}function P(){I&&I.updateBoxCoords()}function L(){return document.querySelector("#MessageForward")}function A(e){var t=document.querySelector("#box_layer_wrap"),a=document.querySelector("#box_loader"),r=isVisible(t);return{unmount(){var t=L();t&&i.unmountComponentAtNode(t),Object(n.destroyModule)(e)},showLoader(){boxRefreshCoords(a),show(a),r||show(t)},hideLoader(){hide(a),r||hide(t)}}}function D(e,t,a){var o=(0,Object(n.createMutations)(A).bindMutations)(Object(n.createModule)({handlers:(e,t)=>{}})),l={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow(){!function(e){var t=L();t&&i.render(r.createElement(s.default,{value:e},r.createElement(k,{closePopup:M,updatePopup:P})),t)}(t),requestAnimationFrame(()=>I.updateBoxCoords())},onHideAttempt:()=>(t.set(d.prepareForward.bind(null,null)),o.unmount(),!0)};return o.showLoader(),Promise.resolve().then(e=>{o.hideLoader(),I=new MessageBox(l).content('<div id="MessageForward"></div>').show()}),o}},vhcd:function(e,t,a){"use strict";a.r(t),a.d(t,"ConvoInviteEntryPoint",(function(){return n})),a.d(t,"collectConvoInviteStats",(function(){return i}));var n,r=a("DM2o");!function(e){e.DIALOG_ACTIONS="dialog_actions",e.PROFILE_SCREEN="profile_screen",e.CONTACT_SCREEN="contact_screen"}(n||(n={}));var i=function(e,t){Object(r.statlogsValueEvent)("convo_invite",e,t)}}});